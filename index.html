<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#04060e">
<title>FAR REACH ‚Äî From Castle to the Stars</title>
<link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Far%20Reach%22,%22short_name%22:%22Far%20Reach%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%2304060e%22,%22theme_color%22:%22%2340d8ff%22,%22description%22:%22A%20hex-based%20strategy%20game%20from%20castle%20to%20the%20stars%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A//www.w3.org/2000/svg'%20viewBox%3D'0%200%20512%20512'%3E%3Crect%20width%3D'512'%20height%3D'512'%20fill%3D'%2304060e'/%3E%3Ctext%20x%3D'256'%20y%3D'340'%20text-anchor%3D'middle'%20font-size%3D'300'%3E%F0%9F%8C%8C%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
<style>@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:ital,wght@0,300;0,400;0,600;1,300&display=swap');:root{--bg:#04060e;--panel:rgba(4,8,20,0.96);--bord:rgba(60,140,255,0.3);--gold:#f0c040;--gold-lt:#ffe080;--cyan:#40d8ff;--red:#ff4444;--green:#40ff80;--parchment:#d8e8f8;--safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);--safe-l:env(safe-area-inset-left,0px);--safe-r:env(safe-area-inset-right,0px);}*{box-sizing:border-box;margin:0;padding:0;}html{height:100%;height:-webkit-fill-available;}body{background:var(--bg);font-family:'Exo 2',sans-serif;height:100vh;height:100dvh;overflow:hidden;display:flex;flex-direction:column;color:var(--parchment);padding-left:var(--safe-l);padding-right:var(--safe-r);}#stars{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}.star{position:absolute;border-radius:50%;background:#fff;animation:twinkle 3s infinite;}@keyframes twinkle{0%,100%{opacity:0.2;}50%{opacity:1;}}#hdr{position:relative;z-index:10;background:linear-gradient(180deg,rgba(2,4,12,0.99),rgba(4,8,24,0.97));border-bottom:1px solid var(--bord);padding:6px 14px;padding-top:calc(6px + var(--safe-top));display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 2px 24px rgba(0,0,0,0.9),0 0 40px rgba(0,30,80,0.3);}#logo{font-family:'Orbitron',monospace;font-size:15px;font-weight:900;color:var(--cyan);letter-spacing:4px;text-shadow:0 0 20px rgba(64,216,255,0.6);}#logo em{color:var(--gold);font-style:normal;}#logo small{display:block;font-size:7px;letter-spacing:3px;color:rgba(64,216,255,0.4);font-weight:400;margin-top:1px;}.hstats{display:flex;align-items:stretch;gap:0;}.hs{display:flex;align-items:center;gap:5px;padding:3px 10px;border-left:1px solid rgba(60,140,255,0.12);font-size:9px;}.hs:first-child{border-left:none;}.hs-icon{font-size:14px;line-height:1;flex-shrink:0;}.hs-block{display:flex;flex-direction:column;line-height:1;}.hs-v{font-family:'Orbitron',monospace;color:var(--cyan);font-size:13px;font-weight:700;min-width:18px;line-height:1.1;}.hs-l{color:rgba(216,232,248,0.28);font-size:7px;text-transform:uppercase;letter-spacing:1px;margin-top:1px;}#tbadge{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:var(--cyan);border:1px solid var(--bord);padding:3px 8px;background:rgba(64,216,255,0.04);border-radius:2px;}#era-badge{font-size:8px;color:var(--gold);letter-spacing:1px;border:1px solid rgba(240,192,64,0.22);padding:3px 8px;background:rgba(240,192,64,0.04);border-radius:2px;}#music-btn,#planet-btn{background:none;border:1px solid var(--bord);color:var(--cyan);font-size:13px;padding:4px 8px;cursor:pointer;border-radius:3px;transition:all 0.2s;margin-left:3px;min-width:32px;min-height:32px;}#music-btn:hover,#planet-btn:hover{background:rgba(64,216,255,0.1);border-color:var(--cyan);}#wrap{display:flex;flex:1;overflow:hidden;position:relative;z-index:1;min-height:0;}#cvs-wrap{flex:1;position:relative;overflow:hidden;}canvas{position:absolute;top:0;left:0;cursor:crosshair;touch-action:none;}#side{width:220px;background:var(--panel);border-left:1px solid var(--bord);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;}.ss{border-bottom:1px solid rgba(60,140,255,0.1);padding:8px 10px;}.st{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:3px;color:var(--cyan);margin-bottom:5px;}#sel-panel{flex:1;overflow-y:auto;padding:9px;scrollbar-width:thin;scrollbar-color:var(--bord) transparent;}.igrid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin:5px 0;}.ic{background:rgba(64,216,255,0.04);border:1px solid rgba(64,216,255,0.1);padding:5px 6px;border-radius:3px;}.icl{font-size:7px;color:rgba(216,232,248,0.3);letter-spacing:1px;text-transform:uppercase;}.icv{font-family:'Orbitron',monospace;font-size:12px;color:var(--cyan);}.hpw{margin:5px 0;}.hpb{height:5px;background:rgba(0,0,0,0.5);border-radius:3px;overflow:hidden;}.hpf{height:100%;border-radius:3px;transition:width 0.3s;}.abtn{width:100%;margin-top:4px;padding:6px 8px;background:rgba(64,216,255,0.03);border:1px solid rgba(64,216,255,0.15);color:var(--parchment);font-family:'Exo 2',sans-serif;font-size:10px;cursor:pointer;text-align:left;transition:all 0.12s;border-radius:3px;min-height:36px;}.abtn:hover:not(:disabled){background:rgba(64,216,255,0.1);border-color:var(--cyan);color:var(--cyan);}.abtn:disabled{opacity:0.2;cursor:not-allowed;}.abtn.hi{border-color:var(--gold);color:var(--gold-lt);background:rgba(240,192,64,0.05);}.trow{display:flex;align-items:center;gap:4px;padding:3px 0;font-size:9px;}.tpip{width:7px;height:7px;border-radius:50%;border:1px solid rgba(64,216,255,0.2);flex-shrink:0;}.tpip.done{background:var(--cyan);border-color:var(--cyan);box-shadow:0 0 5px rgba(64,216,255,0.5);}.tpip.avail{border-color:var(--gold);}.era-hdr{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:2px;color:var(--gold);padding:5px 0 2px;opacity:0.65;}#ftr{position:relative;z-index:10;background:linear-gradient(0deg,rgba(2,4,12,0.99),rgba(4,8,24,0.97));border-top:1px solid var(--bord);padding:7px 14px;padding-bottom:calc(7px + var(--safe-bot));display:flex;align-items:center;gap:10px;flex-shrink:0;}#endbtn{padding:10px 20px;background:linear-gradient(135deg,rgba(0,30,80,0.8),rgba(0,50,120,0.6));border:1px solid rgba(64,216,255,0.5);color:var(--cyan);font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;cursor:pointer;border-radius:3px;text-transform:uppercase;transition:all 0.2s;min-height:44px;box-shadow:0 0 12px rgba(64,216,255,0.1) inset;}#endbtn:hover{box-shadow:0 0 20px rgba(64,216,255,0.35);border-color:var(--cyan);}#endbtn:active{transform:scale(0.97);}#msgbar{flex:1;font-size:9px;color:rgba(216,232,248,0.35);font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.fdmg{position:absolute;font-family:'Orbitron',monospace;font-weight:700;pointer-events:none;z-index:300;text-shadow:0 1px 8px rgba(0,0,0,0.9);animation:fdmg-anim 1.1s ease-out forwards;}@keyframes fdmg-anim{0%{opacity:1;transform:translateY(0) scale(1.2);}80%{opacity:1;}100%{opacity:0;transform:translateY(-42px) scale(0.7);}}.retro-burst{position:absolute;pointer-events:none;z-index:350;}@keyframes burst-ring{0%{transform:translate(-50%,-50%) scale(0);opacity:1;}100%{transform:translate(-50%,-50%) scale(1);opacity:0;}}@keyframes burst-star{0%{transform:translate(-50%,-50%) scale(0) rotate(0deg);opacity:1;}60%{opacity:1;}100%{transform:translate(-50%,-50%) scale(1.4) rotate(180deg);opacity:0;}}@keyframes retro-flash{0%{opacity:0.9;}50%{opacity:0.2;}100%{opacity:0;}}@keyframes pixel-explode{0%{transform:translate(-50%,-50%) scale(0);opacity:1;}40%{transform:translate(-50%,-50%) scale(1.1);opacity:1;}100%{transform:translate(-50%,-50%) scale(2);opacity:0;}}@keyframes level-up-badge{0%{transform:translateX(-50%) translateY(10px) scale(0.5);opacity:0;}20%{transform:translateX(-50%) translateY(0) scale(1.15);opacity:1;}80%{transform:translateX(-50%) translateY(0) scale(1);opacity:1;}100%{transform:translateX(-50%) translateY(-20px) scale(0.8);opacity:0;}}@keyframes era-fanfare{0%{transform:translateX(-50%) scale(0.2);opacity:0;}25%{transform:translateX(-50%) scale(1.1);opacity:1;}75%{transform:translateX(-50%) scale(1);opacity:1;}100%{transform:translateX(-50%) scale(1.05);opacity:0;}}@keyframes comet-fly{0%{transform:translate(0,0) scale(1);opacity:1;}100%{transform:translate(var(--cx),var(--cy)) scale(0);opacity:0;}}@keyframes scanline{0%{top:-4px;}100%{top:100%;}}.scanline-effect{position:absolute;inset:0;pointer-events:none;z-index:400;overflow:hidden;}.scanline-effect::after{content:'';position:absolute;left:0;right:0;height:4px;background:rgba(64,216,255,0.06);animation:scanline 3.5s linear infinite;}#endbtn-hint{font-size:7px;color:rgba(64,216,255,0.3);font-family:'Orbitron',monospace;letter-spacing:1px;margin-left:2px;}#menu-btn{background:none;border:1px solid var(--bord);color:rgba(216,232,248,0.6);font-size:14px;padding:4px 10px;cursor:pointer;border-radius:3px;transition:all 0.2s;margin-left:3px;min-width:36px;min-height:32px;}#menu-btn:hover{background:rgba(64,216,255,0.08);color:var(--cyan);border-color:var(--cyan);}#game-menu{position:fixed;inset:0;z-index:800;display:none;align-items:center;justify-content:center;}#game-menu.open{display:flex;}#gm-bg{position:absolute;inset:0;background:rgba(2,4,16,0.9);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);}#gm-panel{position:relative;z-index:1;background:linear-gradient(160deg,rgba(4,10,28,0.99),rgba(2,4,16,0.99));border:1px solid rgba(64,216,255,0.25);border-radius:8px;padding:28px 28px;min-width:300px;max-width:92vw;text-align:center;box-shadow:0 0 60px rgba(0,0,0,0.95),0 0 24px rgba(64,216,255,0.06);}#gm-panel h2{font-family:'Orbitron',monospace;font-size:13px;letter-spacing:5px;color:var(--cyan);margin-bottom:4px;}.gm-sub{font-size:8px;color:rgba(64,216,255,0.28);letter-spacing:3px;margin-bottom:20px;}.mbtn{display:block;width:100%;padding:13px 0;margin-bottom:9px;background:rgba(64,216,255,0.03);border:1px solid rgba(64,216,255,0.12);color:var(--parchment);font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;cursor:pointer;border-radius:4px;transition:all 0.16s;min-height:44px;}.mbtn:hover,.mbtn:active{background:rgba(64,216,255,0.09);border-color:var(--cyan);color:var(--cyan);}.mbtn.mgold{border-color:rgba(240,192,64,0.2);color:rgba(240,192,64,0.8);}.mbtn.mgold:hover,.mbtn.mgold:active{background:rgba(240,192,64,0.08);border-color:var(--gold);color:var(--gold);}.mbtn.mred{border-color:rgba(255,68,68,0.18);color:rgba(255,140,140,0.8);}.mbtn.mred:hover,.mbtn.mred:active{background:rgba(255,68,68,0.09);border-color:var(--red);color:var(--red);}.mdivider{border:none;border-top:1px solid rgba(64,216,255,0.07);margin:6px 0 12px;}#gm-save-note{font-size:8px;letter-spacing:1px;min-height:14px;margin-bottom:10px;transition:color 0.4s;}#notif{position:absolute;top:14px;left:50%;transform:translateX(-50%) translateY(-10px);background:rgba(2,4,16,0.97);border:1px solid var(--cyan);border-radius:3px;padding:7px 18px;font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;color:var(--cyan);z-index:200;pointer-events:none;opacity:0;transition:opacity 0.22s,transform 0.22s;max-width:86%;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.8);}#notif.on{opacity:1;transform:translateX(-50%) translateY(0);}#notif.warn{border-color:var(--red);color:var(--red);}#notif.gold{border-color:var(--gold);color:var(--gold);}#ov{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000;}.ov-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 30%,#060d24,#010208);}.ov-panel{position:relative;text-align:center;max-width:800px;width:96%;padding:20px 18px;max-height:92dvh;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--bord) transparent;-webkit-overflow-scrolling:touch;}.ov-panel h1{font-family:'Orbitron',monospace;font-size:38px;font-weight:900;color:var(--cyan);letter-spacing:8px;text-shadow:0 0 40px rgba(64,216,255,0.55);margin-bottom:4px;}.ov-sub{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:5px;color:var(--gold);margin-bottom:14px;}.ov-desc{color:rgba(216,232,248,0.5);line-height:1.65;margin-bottom:16px;font-size:11px;}.sbtn{padding:12px 28px;background:transparent;border:2px solid var(--cyan);color:var(--cyan);font-family:'Orbitron',monospace;font-size:11px;letter-spacing:3px;cursor:pointer;text-transform:uppercase;transition:all 0.22s;border-radius:3px;min-height:44px;-webkit-tap-highlight-color:transparent;}.sbtn:hover,.sbtn:active{box-shadow:0 0 24px rgba(64,216,255,0.3);background:rgba(64,216,255,0.08);}.sbtn:disabled{opacity:0.3;cursor:default;}.sbtn.gbtn{border-color:var(--gold);color:var(--gold);}.sbtn.gbtn:hover,.sbtn.gbtn:active{box-shadow:0 0 24px rgba(240,192,64,0.3);background:rgba(240,192,64,0.07);}.faction-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}.fcard{padding:14px 12px;border:2px solid rgba(60,140,255,0.12);background:rgba(60,140,255,0.02);cursor:pointer;transition:all 0.22s;border-radius:6px;position:relative;text-align:left;-webkit-tap-highlight-color:transparent;}.fcard:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,0,0,0.5);}.fcard:active{transform:scale(0.98);}.fcard.picked{transform:translateY(-3px);box-shadow:0 8px 32px rgba(0,0,0,0.6);}.fcard .ficon{font-size:26px;margin-bottom:6px;}.fcard .fname{font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;margin-bottom:4px;}.fcard .ftrait{font-size:8px;color:rgba(216,232,248,0.38);line-height:1.45;margin-bottom:5px;}.fcard .fbonus{font-size:8px;font-style:italic;line-height:1.35;}.fcheck{position:absolute;top:8px;right:10px;font-size:14px;opacity:0;transition:opacity 0.2s;}.fcard.picked .fcheck{opacity:1;}.setup-row{display:flex;align-items:center;gap:8px;padding:9px 10px;border:1px solid rgba(60,140,255,0.12);border-radius:4px;margin-bottom:6px;background:rgba(60,140,255,0.03);}.cnt-btn{padding:9px 16px;font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;border:1px solid var(--bord);background:transparent;color:var(--cyan);cursor:pointer;border-radius:3px;transition:all 0.2s;min-height:40px;-webkit-tap-highlight-color:transparent;}.cnt-btn.active{border-color:var(--cyan);background:rgba(64,216,255,0.1);}.lb-row{display:flex;align-items:center;gap:8px;padding:7px 10px;border-bottom:1px solid rgba(60,140,255,0.07);font-size:10px;transition:background 0.15s;}.lb-row:hover{background:rgba(64,216,255,0.03);}.lb-rank{font-family:'Orbitron',monospace;color:var(--gold);min-width:24px;font-size:11px;}.lb-name{flex:1;font-size:10px;}.lb-score{font-family:'Orbitron',monospace;color:var(--cyan);font-size:11px;font-weight:700;}.lb-meta{font-size:8px;color:rgba(216,232,248,0.3);white-space:nowrap;}.end-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:14px 0 18px;}.es-cell{background:rgba(64,216,255,0.03);border:1px solid rgba(64,216,255,0.1);padding:10px 8px;border-radius:4px;}.es-val{font-family:'Orbitron',monospace;font-size:20px;color:var(--cyan);display:block;}.es-lbl{font-size:8px;color:rgba(216,232,248,0.3);letter-spacing:1px;text-transform:uppercase;margin-top:2px;display:block;}.end-btns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px;}.planet-map{display:flex;justify-content:center;align-items:center;gap:18px;margin:18px 0;flex-wrap:wrap;}.planet-card{padding:16px;border:2px solid rgba(60,140,255,0.2);border-radius:10px;cursor:pointer;transition:all 0.22s;min-width:130px;text-align:center;-webkit-tap-highlight-color:transparent;}.planet-card:hover,.planet-card:active{transform:translateY(-3px);border-color:var(--cyan);}.planet-card.active{border-color:var(--cyan);background:rgba(64,216,255,0.08);}.planet-card.locked{opacity:0.35;cursor:not-allowed;}@media(max-width:640px){#logo small{display:none;}#side{display:none;}#era-badge{display:none;}#diff-badge{display:none!important;}canvas{touch-action:none;}#ftr{padding:6px 10px;padding-bottom:calc(6px + var(--safe-bot));gap:6px;}#endbtn{padding:11px 16px;font-size:9px;min-height:48px;flex-shrink:0;}#endbtn-hint{display:none;}#msgbar{display:none;}#mob-sheet{position:fixed;bottom:0;left:0;right:0;z-index:500;background:rgba(2,4,16,0.99);border-top:1px solid var(--bord);padding:10px 14px;padding-bottom:calc(20px + var(--safe-bot));max-height:62vh;overflow-y:auto;-webkit-overflow-scrolling:touch;border-radius:16px 16px 0 0;box-shadow:0 -8px 40px rgba(0,0,0,0.9);transform:translateY(100%);transition:transform 0.28s cubic-bezier(0.32,0.72,0,1);}#mob-sheet.open{transform:translateY(0);}#mob-handle{width:40px;height:4px;background:rgba(64,216,255,0.2);border-radius:2px;margin:0 auto 12px;cursor:pointer;}#mob-close{position:absolute;top:10px;right:14px;background:none;border:none;color:rgba(216,232,248,0.4);font-size:22px;cursor:pointer;padding:4px;min-width:36px;min-height:36px;}#mob-tech-btn{display:flex!important;align-items:center;justify-content:center;position:fixed;top:calc(var(--safe-top) + 58px);right:10px;z-index:400;width:46px;height:46px;border-radius:50%;background:rgba(2,4,16,0.95);border:1.5px solid var(--bord);font-size:20px;cursor:pointer;box-shadow:0 2px 16px rgba(0,0,0,0.8);transition:all 0.2s;-webkit-tap-highlight-color:transparent;}#mob-tech-btn.lit{border-color:var(--gold);box-shadow:0 0 16px rgba(240,192,64,0.4);}#mob-tech-ov{display:none;position:fixed;inset:0;z-index:600;background:rgba(2,4,12,0.98);flex-direction:column;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;}#mob-tech-ov.open{display:flex!important;}#mob-tech-close{align-self:flex-end;font-size:22px;color:var(--cyan);background:none;border:none;cursor:pointer;padding:6px;margin-bottom:8px;min-width:40px;min-height:40px;}.abtn{min-height:44px;font-size:12px;padding:8px 10px;}.faction-grid{grid-template-columns:1fr;}.fcard{display:flex;align-items:flex-start;gap:12px;}.fcard .ficon{font-size:28px;flex-shrink:0;margin-bottom:0;}.fcard .ftext{flex:1;}.ov-panel h1{font-size:26px;letter-spacing:5px;}.end-stats{grid-template-columns:repeat(2,1fr);}.hstats{flex-wrap:nowrap;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;}.hstats::-webkit-scrollbar{display:none;}.hs{padding:2px 8px;white-space:nowrap;flex-shrink:0;}.hs-l{display:none;}.hs-v{font-size:12px;}.hs-icon{font-size:13px;}.hs-planet{display:none;}#mob-turn-info{display:flex!important;}#gm-panel{min-width:0;width:88vw;}.mbtn{min-height:50px;font-size:10px;}.ov-panel{max-height:100dvh;border-radius:0;padding:16px 14px;}.cnt-btn{min-height:46px;font-size:10px;}.sbtn{min-height:48px;}}.ach-row{display:flex;align-items:center;gap:10px;padding:8px 10px;border-bottom:1px solid rgba(64,216,255,0.07);transition:background 0.15s;}.ach-row:hover{background:rgba(64,216,255,0.03);}.ach-locked{opacity:0.38;}.ach-icon{font-size:20px;width:28px;text-align:center;flex-shrink:0;}.ach-info{flex:1;}.ach-name{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:1px;color:var(--parchment);margin-bottom:2px;}.ach-desc{font-size:8px;color:rgba(216,232,248,0.38);}.ach-check{color:var(--gold);font-size:14px;flex-shrink:0;}#evt-modal{position:fixed;inset:0;z-index:900;display:none;align-items:center;justify-content:center;}#evt-modal.open{display:flex;}#evt-bg{position:absolute;inset:0;background:rgba(2,4,16,0.88);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);}#evt-panel{position:relative;z-index:1;background:linear-gradient(160deg,rgba(4,10,28,0.99),rgba(2,4,16,0.99));border:1px solid rgba(64,216,255,0.22);border-radius:8px;padding:24px 22px;max-width:380px;width:92vw;text-align:center;box-shadow:0 0 60px rgba(0,0,0,0.95);}#evt-panel .evt-icon{font-size:36px;margin-bottom:8px;}#evt-panel .evt-name{font-family:'Orbitron',monospace;font-size:12px;letter-spacing:3px;color:var(--gold);margin-bottom:6px;}#evt-panel .evt-desc{font-size:10px;color:rgba(216,232,248,0.55);margin-bottom:18px;line-height:1.5;}.evt-btn{display:block;width:100%;padding:12px 14px;margin-bottom:9px;background:rgba(64,216,255,0.03);border:1px solid rgba(64,216,255,0.18);color:var(--parchment);font-family:'Exo 2',sans-serif;font-size:10px;cursor:pointer;border-radius:4px;transition:all 0.16s;text-align:left;min-height:44px;line-height:1.4;}.evt-btn:hover,.evt-btn:active{background:rgba(64,216,255,0.1);border-color:var(--cyan);color:var(--cyan);}#daily-badge{display:none;padding:3px 8px;border:1px solid rgba(240,192,64,0.35);border-radius:2px;font-family:'Orbitron',monospace;font-size:7px;letter-spacing:2px;color:var(--gold);background:rgba(240,192,64,0.06);}@media(min-width:641px){#mob-sheet,#mob-tech-btn,#mob-tech-ov{display:none!important;}} .ot{font-family:'Orbitron',monospace;} .ot-c{font-family:'Orbitron',monospace;color:var(--cyan);} .ot-g{font-family:'Orbitron',monospace;color:var(--gold);} .sm{font-size:8px;} .xs{font-size:7px;} .ltr2{letter-spacing:2px;} .ltr3{letter-spacing:3px;} </style>
<style>
/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#side{width:242px;display:flex;flex-direction:column;background:linear-gradient(180deg,rgba(2,5,16,0.99),rgba(3,7,20,0.99));border-left:1px solid rgba(60,140,255,0.18);flex-shrink:0;overflow:hidden;box-shadow:-4px 0 24px rgba(0,0,0,0.6);}
#side-tabs{display:flex;flex-shrink:0;border-bottom:1px solid rgba(60,140,255,0.12);background:rgba(1,3,12,0.97);padding:0 2px;}
.stab{flex:1;padding:10px 4px 9px;background:none;border:none;border-bottom:2px solid transparent;color:rgba(216,232,248,0.25);font-family:"Orbitron",monospace;font-size:7px;letter-spacing:2px;cursor:pointer;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:3px;line-height:1;}
.stab .stab-ic{font-size:13px;line-height:1;transition:all 0.2s;}
.stab:hover{color:rgba(216,232,248,0.65);background:rgba(64,216,255,0.04);}
.stab:hover .stab-ic{filter:drop-shadow(0 0 4px rgba(64,216,255,0.4));}
.stab.active{color:var(--cyan);border-bottom-color:var(--cyan);background:rgba(64,216,255,0.05);}
.stab.active .stab-ic{filter:drop-shadow(0 0 6px rgba(64,216,255,0.7));}
.stab-pane{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(60,140,255,0.15) transparent;}
#sel-panel{padding:0;}
#techlist{padding:6px 10px;}
#diplo-panel{padding:6px 10px;}

/* ‚îÄ‚îÄ PANEL SECTIONS ‚îÄ‚îÄ */
.p-sect{padding:12px 13px;border-bottom:1px solid rgba(60,140,255,0.06);position:relative;}
.p-sect:last-child{border-bottom:none;}
.p-hdg{display:flex;align-items:center;gap:6px;margin-bottom:9px;}
.p-hdg-lbl{font-family:"Orbitron",monospace;font-size:7px;letter-spacing:2.5px;white-space:nowrap;text-transform:uppercase;}
.p-hdg-lbl.cyan{color:var(--cyan);}
.p-hdg-lbl.gold{color:var(--gold);}
.p-hdg-lbl.purple{color:#b864ff;}
.p-hdg-lbl.green{color:#40ff80;}
.p-hdg-line{flex:1;height:1px;border-radius:1px;}
.p-hdg-line.cyan{background:linear-gradient(90deg,rgba(64,216,255,0.35),transparent);}
.p-hdg-line.gold{background:linear-gradient(90deg,rgba(240,192,64,0.35),transparent);}
.p-hdg-line.purple{background:linear-gradient(90deg,rgba(184,100,255,0.35),transparent);}
.p-hdg-line.green{background:linear-gradient(90deg,rgba(64,255,128,0.35),transparent);}

/* ‚îÄ‚îÄ PORTRAIT ‚îÄ‚îÄ */
.portrait-row{display:flex;align-items:center;gap:11px;margin-bottom:10px;}
.portrait-box{width:62px;height:62px;border-radius:8px;background:linear-gradient(135deg,rgba(4,10,28,0.95),rgba(2,4,16,0.98));border:1px solid rgba(64,216,255,0.2);flex-shrink:0;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;box-shadow:0 0 12px rgba(0,0,0,0.6),inset 0 1px 0 rgba(255,255,255,0.04);}
.portrait-box canvas{position:absolute;top:0;left:0;}
.portrait-box::after{content:'';position:absolute;inset:0;border-radius:8px;background:linear-gradient(135deg,rgba(255,255,255,0.04),transparent 60%);pointer-events:none;}
.portrait-title{flex:1;min-width:0;}
.portrait-name{font-family:"Orbitron",monospace;font-size:10px;font-weight:700;color:var(--parchment);line-height:1.25;word-break:break-word;letter-spacing:0.5px;}
.portrait-sub{font-size:8px;color:rgba(216,232,248,0.35);margin-top:4px;line-height:1.45;}
.portrait-era{display:inline-block;font-family:"Orbitron",monospace;font-size:6px;letter-spacing:1.5px;padding:1px 5px;border-radius:2px;margin-top:4px;}

/* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
.sg{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin:7px 0;}
.sg.three{grid-template-columns:1fr 1fr 1fr;}
.sc{background:linear-gradient(135deg,rgba(64,216,255,0.04),rgba(64,216,255,0.02));border:1px solid rgba(64,216,255,0.1);border-radius:5px;padding:6px 8px;position:relative;overflow:hidden;}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.06),transparent);}
.sc-lbl{font-size:6px;color:rgba(216,232,248,0.3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px;}
.sc-val{font-family:"Orbitron",monospace;font-size:15px;color:var(--cyan);line-height:1;font-weight:700;}
.sc-val .b{color:var(--gold);font-size:9px;font-weight:400;}
.sc.atk .sc-val{color:#ff7070;}
.sc.def .sc-val{color:#70b8ff;}
.sc.mov .sc-val{color:#80ff80;}

/* ‚îÄ‚îÄ BARS ‚îÄ‚îÄ */
.bar-row{margin:6px 0;}
.bar-labels{display:flex;justify-content:space-between;font-size:8px;color:rgba(216,232,248,0.32);margin-bottom:3px;align-items:baseline;}
.bar-labels b{font-family:"Orbitron",monospace;font-weight:400;font-size:9px;color:rgba(216,232,248,0.5);}
.bar-track{height:8px;background:rgba(0,0,0,0.55);border-radius:4px;overflow:hidden;box-shadow:inset 0 1px 4px rgba(0,0,0,0.7);}
.bar-fill{height:100%;border-radius:4px;transition:width 0.35s ease;}
.bar-hp-hi{background:linear-gradient(90deg,#1a9940,#40ff80);box-shadow:0 0 6px rgba(64,255,128,0.4);}
.bar-hp-mid{background:linear-gradient(90deg,#906018,#ffc040);box-shadow:0 0 4px rgba(255,192,64,0.3);}
.bar-hp-lo{background:linear-gradient(90deg,#7a1414,#ff4444);box-shadow:0 0 6px rgba(255,68,68,0.4);}
.bar-pop{background:linear-gradient(90deg,#0e5090,#40d8ff);box-shadow:0 0 5px rgba(64,216,255,0.3);}
.bar-xp{background:linear-gradient(90deg,#5010a0,#b864ff);box-shadow:0 0 5px rgba(184,100,255,0.35);}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge-row{display:flex;flex-wrap:wrap;gap:4px;margin:6px 0;}

.bdg{font-size:7px;letter-spacing:1px;padding:2px 6px;border-radius:2px;font-family:"Orbitron",monospace;white-space:nowrap;border:1px solid;}
.bdg.cyan{color:var(--cyan);border-color:rgba(64,216,255,0.3);background:rgba(64,216,255,0.07);}
.bdg.gold{color:var(--gold);border-color:rgba(240,192,64,0.3);background:rgba(240,192,64,0.07);}
.bdg.red{color:#ff8080;border-color:rgba(255,80,80,0.3);background:rgba(255,80,80,0.07);}
.bdg.green{color:#50ff90;border-color:rgba(64,255,128,0.3);background:rgba(64,255,128,0.07);}
.bdg.purple{color:#cc88ff;border-color:rgba(184,100,255,0.3);background:rgba(184,100,255,0.07);}
.bdg.dim{color:rgba(216,232,248,0.28);border-color:rgba(216,232,248,0.1);}
.rank-card{display:flex;align-items:center;gap:8px;padding:6px 9px;border:1px solid rgba(240,192,64,0.28);border-radius:4px;background:linear-gradient(135deg,rgba(240,192,64,0.07),rgba(240,192,64,0.02));margin:6px 0;}
.rank-stars{font-size:14px;line-height:1;}
.rank-name{font-family:"Orbitron",monospace;font-size:9px;color:var(--gold);}
.rank-xp-txt{font-size:7px;color:rgba(216,232,248,0.38);margin-top:2px;}
.act-row{display:flex;gap:4px;margin-top:7px;flex-wrap:wrap;}
.abtn2{flex:1;min-width:56px;padding:7px 4px;border-radius:3px;font-family:"Orbitron",monospace;font-size:7px;letter-spacing:1px;cursor:pointer;transition:all 0.15s;border:1px solid;text-align:center;line-height:1.4;}
.abtn2.cyan{border-color:rgba(64,216,255,0.35);background:rgba(64,216,255,0.05);color:var(--cyan);}
.abtn2.cyan:hover:not(:disabled){background:rgba(64,216,255,0.14);border-color:var(--cyan);}
.abtn2.red{border-color:rgba(255,80,80,0.28);background:rgba(255,80,80,0.05);color:#ff9090;}
.abtn2.red:hover:not(:disabled){background:rgba(255,80,80,0.12);border-color:#ff5050;}
.abtn2.gold{border-color:rgba(240,192,64,0.35);background:rgba(240,192,64,0.05);color:var(--gold);}
.abtn2.gold:hover:not(:disabled){background:rgba(240,192,64,0.13);border-color:var(--gold);}
.abtn2:disabled{opacity:0.2;cursor:not-allowed;}
.abtn2 small{display:block;font-size:8px;color:rgba(216,232,248,0.4);margin-top:1px;font-family:"Exo 2",sans-serif;letter-spacing:0;}
.inf{font-size:8px;color:rgba(216,232,248,0.3);padding:4px 0;line-height:1.5;}
.inf.active{color:rgba(64,255,128,0.7);}
.inf.warn{color:rgba(255,180,80,0.7);}
.inf.special{color:#cc88ff;}
.inf.exodus{color:var(--gold);}
.spec-btn{display:flex;align-items:center;gap:7px;width:100%;padding:7px 8px;margin-bottom:4px;border-radius:4px;cursor:pointer;transition:all 0.15s;border:1px solid;text-align:left;}
.spec-icon{font-size:15px;flex-shrink:0;}
.spec-name{font-family:"Orbitron",monospace;font-size:7px;letter-spacing:1px;}
.spec-desc{font-size:7px;opacity:0.5;margin-top:1px;line-height:1.3;}
.wndr-btn{display:flex;align-items:center;gap:7px;width:100%;padding:7px 8px;margin-bottom:4px;border-radius:4px;border:1px solid;text-align:left;cursor:pointer;transition:all 0.15s;}
.wndr-btn:disabled{cursor:default;}
.wndr-icon{font-size:15px;flex-shrink:0;}
.wndr-name{font-family:"Orbitron",monospace;font-size:7px;letter-spacing:1px;line-height:1.4;}
.wndr-desc{font-size:7px;opacity:0.42;margin-top:1px;line-height:1.3;}
.deploy-list{max-height:190px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(60,140,255,0.14) transparent;margin-top:4px;}
@keyframes endbtn-pulse{0%,100%{box-shadow:0 0 12px rgba(64,216,255,0.1) inset,0 0 0 rgba(64,216,255,0);}50%{box-shadow:0 0 20px rgba(64,216,255,0.2) inset,0 0 16px rgba(64,216,255,0.15);}}
#endbtn.ready{animation:endbtn-pulse 2s ease-in-out infinite;border-color:rgba(64,216,255,0.7);}
#msgbar{flex:1;font-size:9px;color:rgba(216,232,248,0.38);font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:0.3px;}
.side-empty{color:rgba(216,232,248,0.16);font-size:9px;font-style:italic;text-align:center;padding:40px 16px;line-height:1.7;}

.era-hdr{display:flex;align-items:center;gap:5px;font-family:"Orbitron",monospace;font-size:7px;letter-spacing:2px;color:var(--gold);padding:7px 0 3px;opacity:0.7;}
.era-hdr::after{content:"";flex:1;height:1px;background:linear-gradient(90deg,rgba(240,192,64,0.25),transparent);}
.trow{display:flex;align-items:center;gap:5px;padding:3px 0;font-size:9px;}
.tpip{width:8px;height:8px;border-radius:50%;border:1px solid rgba(64,216,255,0.2);flex-shrink:0;transition:all 0.2s;}
.tpip.done{background:var(--cyan);border-color:var(--cyan);box-shadow:0 0 6px rgba(64,216,255,0.5);}
.tpip.avail{border-color:var(--gold);background:rgba(240,192,64,0.15);}
.tbuy{padding:2px 7px;font-family:"Orbitron",monospace;font-size:8px;border:1px solid rgba(240,192,64,0.4);background:rgba(240,192,64,0.07);color:var(--gold);cursor:pointer;border-radius:2px;transition:all 0.15s;white-space:nowrap;margin-left:auto;}
.tbuy:hover{background:rgba(240,192,64,0.17);border-color:var(--gold);}
.diplo-card{border:1px solid rgba(60,140,255,0.15);border-radius:5px;padding:10px;margin-bottom:8px;background:rgba(4,8,22,0.5);}
@media(max-width:640px){#side{display:none;}}
</style></head>
<body>
<div id="stars"></div>
<div id="hdr">
  <div style="display:flex;align-items:center;gap:10px;flex-shrink:0;">
    <div id="logo">FAR <em>REACH</em><small>FROM CASTLE TO THE STARS</small></div>
    <span id="faction-badge" style="display:none;font-family:Orbitron,monospace;font-size:8px;padding:2px 7px;border-radius:2px;background:rgba(64,216,255,0.06);border:1px solid rgba(64,216,255,0.18);color:var(--cyan)"></span>
  </div>
  <div class="hstats">
    <div class="hs">
      <span class="hs-icon">‚≠ê</span>
      <div class="hs-block"><span class="hs-v" id="h-score">0</span><span class="hs-l">Score</span></div>
    </div>
    <div class="hs">
      <span class="hs-icon">üíé</span>
      <div class="hs-block"><span class="hs-v" id="h-stars">8</span><span class="hs-l">Credits</span></div>
    </div>
    <div class="hs">
      <span class="hs-icon">üèô</span>
      <div class="hs-block"><span class="hs-v" id="h-cities">1</span><span class="hs-l">Cities</span></div>
    </div>
    <div class="hs">
      <span class="hs-icon">‚öî</span>
      <div class="hs-block"><span class="hs-v" id="h-units">1</span><span class="hs-l">Units</span></div>
    </div>
    <div class="hs hs-planet">
      <span class="hs-icon">üåç</span>
      <div class="hs-block"><span class="hs-v" id="h-planet">Earth</span><span class="hs-l">Planet</span></div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:3px;flex-shrink:0;">
    <div id="daily-badge">üìÖ DAILY</div>
    <div id="era-badge">‚öîÔ∏è MEDIEVAL</div>
    <div id="diff-badge" style="font-size:8px;letter-spacing:1px;padding:2px 7px;border:1px solid rgba(240,192,64,0.2);background:rgba(240,192,64,0.04);display:none;border-radius:2px;"></div>
    <div id="tbadge">TURN 1</div>
    <button id="music-btn" onclick="toggleMusic()" title="Toggle Music">üéµ</button>
    <button id="planet-btn" onclick="showPlanetOverview()" title="Planet Map">üåå</button>
    <button id="diplo-btn" onclick="showDiploScreen()" title="Diplomacy" style="background:none;border:1px solid var(--bord);color:rgba(216,232,248,0.6);font-size:13px;padding:4px 10px;cursor:pointer;border-radius:3px;transition:all 0.2s;margin-left:3px;min-width:36px;min-height:32px;">üïäÔ∏è</button>
    <button id="menu-btn" onclick="openGameMenu()" title="Menu">‚ò∞</button>
  </div>
</div>
<div id="wrap">
  <div id="cvs-wrap">
    <canvas id="C"></canvas>
    <canvas id="FX" style="pointer-events:none;z-index:5;"></canvas>
    <div id="notif"></div>
  </div>
  <div id="side">
    <div id="side-tabs">
      <button class="stab active" data-tab="intel" onclick="switchSideTab('intel')"><span class="stab-ic">üéØ</span>INTEL</button>
      <button class="stab" data-tab="tech" onclick="switchSideTab('tech')"><span class="stab-ic">‚öóÔ∏è</span>TECH</button>
      <button class="stab" data-tab="diplo" onclick="switchSideTab('diplo')"><span class="stab-ic">üïäÔ∏è</span>DIPLO</button>
    </div>
    <div id="stab-intel" class="stab-pane">
      <div id="sel-panel"><div class="side-empty">Select a tile to begin</div></div>
    </div>
    <div id="stab-tech" class="stab-pane" style="display:none">
      <div id="techlist" style="padding:8px 10px;"></div>
    </div>
    <div id="stab-diplo" class="stab-pane" style="display:none">
      <div id="diplo-panel"><div class="side-empty">No civilisations contacted yet</div></div>
    </div>
  </div>
</div>
<div id="ftr">
  <button id="endbtn">End Turn</button>
  <span id="endbtn-hint">[ENTER]</span>
  <div id="msgbar">Initialising command matrix‚Ä¶</div>
  <!-- Mobile: compact turn + era display in footer -->
  <div id="mob-turn-info" style="display:none;align-items:center;gap:8px;font-size:9px;font-family:Orbitron,monospace;margin-left:auto;">
    <span id="mob-era-badge" style="color:var(--gold);font-size:8px;"></span>
    <span id="mob-turn-badge" style="color:var(--cyan);border:1px solid var(--bord);padding:2px 7px;border-radius:2px;"></span>
  </div>
</div>
<div class="scanline-effect"></div>
<div id="ov">
  <div class="ov-bg"></div>
  <div class="ov-panel" id="ov-content"></div>
</div>
<div id="mob-tech-btn" title="Technologies">‚öóÔ∏è</div>

<!-- GAME MENU OVERLAY -->
<div id="game-menu">
  <div id="gm-bg" onclick="closeGameMenu()"></div>
  <div id="gm-panel">
    <h2>‚öô COMMAND</h2>
    <div class="gm-sub">FAR REACH MENU</div>
    <div id="gm-save-note"></div>
    <button class="mbtn mgold" onclick="menuSave()">üíæ Save Game</button>
    <button class="mbtn mgold" onclick="menuLoad()">üìÇ Load Game</button>
    <hr class="mdivider">
    <button class="mbtn" onclick="menuRestart()">üîÑ Restart Game</button>
    <button class="mbtn mred" onclick="menuGiveUp()">üè≥ Give Up</button>
    <hr class="mdivider">
    <button class="mbtn" onclick="closeGameMenu()">‚ñ∂ Resume</button>
    <button class="mbtn mgold" onclick="closeGameMenu();shareScore()">üì§ Share Score</button>
    <button class="mbtn mred" onclick="menuExit()">‚úï Exit to Title</button>
  </div>
</div>
<div id="mob-tech-ov">
  <button id="mob-tech-close">‚úï</button>
  <h3 style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:3px;color:var(--cyan);margin-bottom:10px;">‚öó TECHNOLOGIES</h3>
  <div id="mob-techlist"></div>
</div>
<div id="mob-sheet">
  <div id="mob-handle"></div>
  <button id="mob-close">‚úï</button>
  <div id="mob-sel-panel"></div>
</div>
<!-- Event choice modal -->
<div id="evt-modal">
  <div id="evt-bg"></div>
  <div id="evt-panel">
    <div class="evt-icon" id="evt-icon">üåã</div>
    <div class="evt-name" id="evt-name">EVENT</div>
    <div class="evt-desc" id="evt-desc"></div>
    <div id="evt-choices"></div>
  </div>
</div>
<script>// ‚îÄ‚îÄ STARS ‚îÄ‚îÄ
(function(){const s=document.getElementById('stars');for(let i=0;i<120;i++){const d=document.createElement('div');d.className='star';const sz=Math.random()*2+0.5;d.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*3}s;animation-duration:${2+Math.random()*4}s;opacity:${Math.random()*0.5+0.1}`;s.appendChild(d);}})();

// ‚îÄ‚îÄ AUDIO ENGINE ‚îÄ‚îÄ
let AC=null;
function getAC(){if(!AC){try{AC=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}return AC;}
function playTone(freq,type,dur,vol,delay=0,endF=null){
  const ac=getAC();if(!ac)return;
  const o=ac.createOscillator(),g=ac.createGain();
  o.connect(g);g.connect(ac.destination);
  o.type=type;o.frequency.setValueAtTime(freq,ac.currentTime+delay);
  if(endF)o.frequency.linearRampToValueAtTime(endF,ac.currentTime+delay+dur);
  g.gain.setValueAtTime(vol,ac.currentTime+delay);
  g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+delay+dur);
  o.start(ac.currentTime+delay);o.stop(ac.currentTime+delay+dur+0.05);
}
const SFX={
  move(){playTone(280,'sine',0.1,0.04);playTone(380,'sine',0.08,0.03,0.07);},
  attack(){playTone(140,'sawtooth',0.07,0.08);playTone(70,'square',0.12,0.09,0.04,45);},
  laser(){playTone(800,'sawtooth',0.05,0.07);playTone(400,'sawtooth',0.07,0.06,0.03,180);playTone(1100,'sine',0.03,0.04,0.06);},
  build(){playTone(440,'sine',0.08,0.05);playTone(554,'sine',0.1,0.05,0.09);playTone(660,'sine',0.12,0.04,0.19);},
  research(){[0,0.1,0.2,0.32].forEach((d,i)=>playTone(440*Math.pow(1.25,i),'sine',0.12,0.05,d));},
  capture(){playTone(330,'sine',0.07,0.08);playTone(440,'sine',0.09,0.07,0.09);playTone(660,'sine',0.15,0.07,0.22);},
  launch(){[0,0.12,0.26,0.42,0.58].forEach((d,i)=>playTone(100*Math.pow(1.18,i),'sawtooth',0.18,0.07,d));},
  event(){playTone(110,'square',0.14,0.08);playTone(138,'square',0.1,0.06,0.12);},
  victory(){[523,659,784,880,1047].forEach((f,i)=>playTone(f,'sine',0.28,0.08,i*0.16));},
  defeat(){playTone(220,'sawtooth',0.28,0.08);playTone(185,'sawtooth',0.28,0.07,0.24);playTone(155,'sawtooth',0.35,0.06,0.5);},
  wrath(){[0,0.08,0.18,0.3,0.45].forEach((d,i)=>playTone(60*Math.pow(1.3,i),'sawtooth',0.22,0.1,d));}
}

// ‚îÄ‚îÄ MUSIC ENGINE ‚îÄ‚îÄ
const MUSIC=(function(){
  let ac=null,playing=false,mode='explore',mg=null,_t=null,planet='earth';
  let bar=0,section=0,sectionLen=8,phrase=0;

  const SCALES={
    earth_explore:  [65,73,78,87,98,110,131,147],   // D minor ‚Äî lush, hopeful
    earth_combat:   [55,62,65,73,82,87,98,110],      // A minor ‚Äî tense
    moon_explore:   [82,92,98,110,123,131,147,164],  // E minor ‚Äî eerie open
    moon_combat:    [73,82,87,98,110,117,131,146],   // B minor ‚Äî cold dread
    mars_explore:   [58,65,69,78,87,92,104,116],     // Bb minor ‚Äî alien
    mars_combat:    [55,58,65,73,78,82,92,98],       // Dissonant ‚Äî menacing
    space:          [73,82,98,110,131,147,164,196],  // Sparse fifths ‚Äî cosmic
  }
  const SECTION_PATTERNS=[0,1,2,1,3,2,0,5,1,4,2,3];

  function gAC(){if(!ac)try{ac=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}return ac;}

  function mko(freq,type,vol,t,dur,detune=0,filter=null){
    const a=gAC();if(!a||!mg)return;
    const o=a.createOscillator(),g=a.createGain();
    let chain=g;
    if(filter){const f=a.createBiquadFilter();f.type=filter.type||'lowpass';f.frequency.value=filter.freq||800;f.Q.value=filter.q||1;o.connect(f);f.connect(g);}
    else o.connect(g);
    g.connect(mg);
    o.type=type;o.frequency.setValueAtTime(freq,t);
    if(detune)o.detune.value=detune;
    g.gain.setValueAtTime(0,t);
    g.gain.linearRampToValueAtTime(vol,t+0.04);
    g.gain.setValueAtTime(vol,t+dur*0.7);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.start(t);o.stop(t+dur+0.1);
  }

  function noise(vol,t,dur){
    const a=gAC();if(!a||!mg)return;
    const buf=a.createBuffer(1,Math.ceil(a.sampleRate*dur),a.sampleRate);
    const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1);
    const src=a.createBufferSource(),g=a.createGain(),f=a.createBiquadFilter();
    f.type='bandpass';f.frequency.value=120+Math.random()*80;f.Q.value=0.8;
    src.buffer=buf;src.connect(f);f.connect(g);g.connect(mg);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    src.start(t);src.stop(t+dur+0.05);
  }

  function getScale(){return SCALES[`${planet}_${mode}`]||SCALES.earth_explore;}

  function scheduleBar(t,bn){
    const sc=getScale();
    const st=SECTION_PATTERNS[(Math.floor(bn/sectionLen)+section)%SECTION_PATTERNS.length];
    const bl=0.22; // beat length
    const beats=8;
    const root=sc[0];
    mko(root*0.5,'sine',0.06,t,bl*beats*0.95);
    if(mode==='combat'||st===3||st===5){
      mko(root*0.5,'square',0.025,t,bl*beats*0.95);
    }

    if(st===0){
      const chordDegrees=[0,2,4,6];
      chordDegrees.forEach((d,i)=>{
        const note=sc[d%sc.length];
        const slight=note*(1+0.005*i); // micro-detune for warmth
        mko(slight,'sine',0.028+i*0.005,t+i*0.04,bl*beats*0.9);
        mko(note*2,'triangle',0.012,t+i*0.06,bl*beats*0.8);
      });
      if(bn%4===0)mko(sc[6]*2,'sine',0.018,t+bl*2,bl*4);
    } else if(st===1){
      const arpNotes=[sc[0],sc[2],sc[4],sc[6],sc[4],sc[2],sc[3],sc[1]];
      arpNotes.forEach((n,i)=>{
        mko(n,'square',0.022,t+i*bl,bl*0.75,0,{type:'lowpass',freq:900+i*40,q:1.5});
        if(mode==='combat')mko(n*2,'sawtooth',0.008,t+i*bl,bl*0.5);
      });
      mko(sc[0],'sine',0.035,t,bl*beats*0.9);
      mko(sc[4],'sine',0.025,t,bl*beats*0.9);
    } else if(st===2){
      for(let i=0;i<beats;i++){
        const bassNote=i%4===0?sc[0]:i%4===2?sc[3]:sc[1];
        mko(bassNote*0.5,'square',0.04,t+i*bl,bl*0.55,0,{type:'lowpass',freq:300,q:2});
      }
      const motif=[0,2,4,6,5,3,2,0];
      motif.forEach((d,i)=>{
        if(Math.sin(bn*7.3+i)*0.5+0.5>0.35){ // ~65% note density
          mko(sc[d%sc.length]*(i%3===0?1:2),'triangle',0.02,t+i*bl,bl*0.8);
        }
      });
      if(mode==='explore'){
        const lead=[sc[4]*2,sc[6]*2,sc[5]*2,sc[4]*2];
        lead.forEach((n,i)=>mko(n,'sine',0.015,t+i*bl*2,bl*1.8));
      }
    } else if(st===3){
      const ostinato=[sc[0],sc[1],sc[0],sc[7]];
      for(let rep=0;rep<2;rep++){
        ostinato.forEach((n,i)=>{
          mko(n*0.5,'sawtooth',0.035,t+rep*bl*4+i*bl,bl*0.65,0,{type:'lowpass',freq:500,q:3});
          mko(n,'square',0.015,t+rep*bl*4+i*bl+0.01,bl*0.5);
        });
      }
      for(let i=0;i<beats;i+=2){
        mko(sc[7]*2,'sawtooth',0.012,t+i*bl,bl*0.3);
        mko(sc[6]*2,'sawtooth',0.010,t+i*bl+0.11,bl*0.3);
      }
      noise(0.018,t,bl*beats*0.9);
    } else if(st===4){
      mko(sc[0]*0.5,'sine',0.04,t,bl*beats);
      mko(sc[4]*0.5,'sine',0.025,t+bl,bl*(beats-1));
      mko(sc[2],'sine',0.018,t+bl*3,bl*(beats-3));
      if(bn%8===0)mko(sc[6]*4,'sine',0.012,t+bl*5,bl*2.5);
    } else if(st===5){
      const escalate=[sc[0],sc[1],sc[2],sc[3],sc[4],sc[5],sc[6],sc[7]];
      escalate.forEach((n,i)=>{
        mko(n,'square',0.02+i*0.003,t+i*bl,bl*(beats-i)*0.12+bl*0.4,0,{type:'lowpass',freq:400+i*80,q:2});
        mko(n*2,'triangle',0.012+i*0.002,t+i*bl+0.05,bl*0.6);
      });
      mko(sc[0]*0.25,'sine',0.055,t,bl*beats); // sub bass builds
    }

    if(mode==='combat'){
      for(let i=0;i<beats;i+=4){noise(0.045,t+i*bl,0.04);}
      for(let i=2;i<beats;i+=4){noise(0.032,t+i*bl,0.025);}
      if(st!==4)for(let i=0;i<beats*2;i++){noise(0.012,t+i*bl*0.5,0.012);}
    } else if(st===1||st===2||st===5){
      for(let i=0;i<beats;i+=4)noise(0.018,t+i*bl,0.02);
      for(let i=2;i<beats;i+=4)noise(0.012,t+i*bl,0.015);
    }
  }
  let nxt=0;
  function tick(){
    const a=gAC();if(!a||!playing)return;
    while(a.currentTime>=nxt-0.08){
      scheduleBar(nxt,bar);
      bar++;
      if(bar%sectionLen===0){
        section++;
        sectionLen=[6,8,8,10][Math.floor(Math.random()*4)];
      }
      nxt+=0.22*8; // 8 beats per bar
    }
    _t=setTimeout(tick,80);
  }

  return{
    start(){const a=gAC();if(!a||playing)return;mg=a.createGain();mg.gain.value=0.38;mg.connect(a.destination);playing=true;bar=0;section=0;nxt=a.currentTime+0.05;tick();},
    stop(){playing=false;clearTimeout(_t);if(mg&&ac){try{mg.gain.setTargetAtTime(0,ac.currentTime,0.4);}catch(e){}}mg=null;},
    setMode(m){
      if(m===mode)return;mode=m;
      section++;bar=Math.ceil(bar/sectionLen)*sectionLen;
      if(mg&&ac){try{mg.gain.setTargetAtTime(m==='combat'?0.44:0.38,ac.currentTime,0.3);}catch(e){}}
    },
    setPlanet(p){planet=p;section++;},
    toggle(){if(playing)this.stop();else this.start();return playing;},
    isPlaying(){return playing;}
  }
})();

// ‚îÄ‚îÄ FACTIONS ‚îÄ‚îÄ
const FACTIONS={
  APEX:{id:'APEX',name:'Apex Ventures',icon:'üöÄ',
    color:'#1a8aff',light:'#80c8ff',cityColor:'#0a5aaa',cityLight:'#60aaff',
    desc:'Private tech empire. Fast innovation, cheap rockets, reaches space first.',
    bonus:'üöÄ Disruption: All tech costs -20%. Rockets & colony ships cost -2 credits.',
    techDiscount:0.8,rocketDiscount:2},
  COLLECTIVE:{id:'COLLECTIVE',name:'The Collective',icon:'‚ò≠',
    color:'#cc2020',light:'#ff7070',cityColor:'#881010',cityLight:'#ff5050',
    desc:'Vast state machine. Overwhelming numbers, slow tech, unstoppable momentum.',
    bonus:'‚ò≠ Numbers: Units cost -1. Cities spawn +1 free unit when population caps.',
    unitDiscount:1,massProduction:true},
  GREYS:{id:'GREYS',name:'The Greys',icon:'üëΩ',
    color:'#50d0a0',light:'#90ffcc',cityColor:'#206848',cityLight:'#60e898',
    desc:'Ancient visitors. Psychic abilities, already ahead in tech, but fragile.',
    bonus:'üëΩ Psionic: Start in Atomic era. Psychic units disable enemy units for 1 turn.',
    passOcean:true,passMountain:true,startAdvanced:true},
  BENEVOLENT:{id:'BENEVOLENT',name:'The Benevolent',icon:'üåä',
    color:'#2060c0',light:'#80b8ff',cityColor:'#103880',cityLight:'#5090e0',
    desc:'Ancient ocean-born aliens. Few in number, peaceful by nature ‚Äî until pushed. Then their Leviathan wrath is overwhelming.',
    bonus:'üåä Wrath: Small elite army. Leviathan unlocked when attacked. Each Leviathan deals 3√ó damage when wrath is maxed.',
    passOcean:true,wrathMechanic:true,smallPop:true},
}

// ‚îÄ‚îÄ AI ‚îÄ‚îÄ
const AI_PERSONALITIES={
  RUSHER:{
    name:'The Rusher',bias:'attack',desc:'Charges for your capital early',
    techPath:['FARMING','SMITHING','RIDING','ARCHERY','GUNPOWDER','STEEL','AVIATION','NUCLEAR','ROCKETRY'],
    unitComposition:{melee:0.5,ranged:0.3,siege:0.1,special:0.1},
    retreatThreshold:0.25,defenceRatio:0.2,spendThreshold:0.6,
  },
  BUILDER:{
    name:'The Builder',bias:'economy',desc:'Grows empire before striking',
    techPath:['FARMING','MINING','MEDICINE','STEAM','STEEL','ELECTRICITY','RADAR','COMPUTING','LIFE_SUPPORT','ORBIT','MOONBASE','COLONY_SHIP'],
    unitComposition:{melee:0.3,ranged:0.3,siege:0.1,special:0.3},
    retreatThreshold:0.4,defenceRatio:0.5,spendThreshold:0.4,
  },
  TACTICIAN:{
    name:'The Tactician',bias:'balanced',desc:'Coordinated strikes and defence',
    techPath:['FARMING','MINING','ARCHERY','SMITHING','GUNPOWDER','STEAM','ELECTRICITY','RADAR','AVIATION','NUCLEAR','COMPUTING','ROCKETRY','ORBIT'],
    unitComposition:{melee:0.35,ranged:0.35,siege:0.15,special:0.15},
    retreatThreshold:0.3,defenceRatio:0.35,spendThreshold:0.5,
  },
  BERSERKER:{
    name:'The Berserker',bias:'attack',desc:'Pure overwhelming aggression',
    techPath:['SMITHING','RIDING','SIEGE','GUNPOWDER','STEEL','NUCLEAR','AVIATION'],
    unitComposition:{melee:0.7,ranged:0.15,siege:0.15,special:0},
    retreatThreshold:0.15,defenceRatio:0.1,spendThreshold:0.8,
  },
  RESEARCHER:{
    name:'The Researcher',bias:'exodus',desc:'Races to launch the Exodus Ship',
    techPath:['FARMING','MINING','SMITHING','STEAM','ELECTRICITY','MEDICINE','RADAR','COMPUTING','NUCLEAR','AVIATION','ROCKETRY','LIFE_SUPPORT','ORBIT','LASERS','AI_WEAPONS','MOONBASE','COLONY_SHIP','MARS_BASE','WARP','DARK_ENERGY','EXODUS'],
    unitComposition:{melee:0.2,ranged:0.2,siege:0.1,special:0.5},
    retreatThreshold:0.5,defenceRatio:0.6,spendThreshold:0.35,
  },
}

// ‚îÄ‚îÄ DIFFICULTY ‚îÄ‚îÄ
const AI_DIFFICULTY={
  POTATO:{
    id:'POTATO',label:'ü•î Potato',desc:'Harmless. Forgets what turn it is.',
    incomeBonus:0,          // no extra income
    dmgMult:0.6,            // hits like a wet sock
    techMult:0.4,           // researches very slowly
    spendMult:0.5,          // hoards stars, trains rarely
    retreatMult:2.0,        // retreats at 50%+ HP (runs away from nothing)
    fogCheat:false,         // no map cheating
    lookAhead:false,        // no lookahead ‚Äî picks random targets
    multiTech:false,        // one tech per several turns
    exodusAware:false,      // doesn't try to win via black hole
    blunderChance:0.55,     // 55% chance to do something random each unit turn
    techSkipChance:0.7,     // often skips research even if affordable
    color:'#888888',
  },
  EASY:{
    id:'EASY',label:'üò¥ Easy',desc:'Tries its best. Bless its heart.',
    incomeBonus:0,
    dmgMult:0.85,
    techMult:0.65,
    spendMult:0.7,
    retreatMult:1.5,
    fogCheat:false,
    lookAhead:false,
    multiTech:false,
    exodusAware:false,
    blunderChance:0.3,
    techSkipChance:0.4,
    color:'#40c840',
  },
  NORMAL:{
    id:'NORMAL',label:'‚öîÔ∏è Normal',desc:'Competent. Will punish mistakes.',
    incomeBonus:1,          // +1 credit per city per turn
    dmgMult:1.0,
    techMult:1.0,
    spendMult:1.0,
    retreatMult:1.0,
    fogCheat:false,
    lookAhead:false,
    multiTech:false,
    exodusAware:true,
    blunderChance:0.1,
    techSkipChance:0.1,
    color:'#f0c040',
  },
  HARD:{
    id:'HARD',label:'üíÄ Hard',desc:'Relentless. Adapts. Remembers everything.',
    incomeBonus:3,          // +3 credits per city ‚Äî economy advantage
    dmgMult:1.2,            // hits 20% harder
    techMult:1.4,           // researches faster
    spendMult:1.3,          // spends more aggressively
    retreatMult:0.7,        // more fearless
    fogCheat:true,          // can "sense" player positions through fog
    lookAhead:true,         // picks targets more intelligently
    multiTech:true,         // can research 2 techs per turn
    exodusAware:true,
    blunderChance:0,
    techSkipChance:0,
    color:'#ff6040',
  },
  ELON:{
    id:'ELON',label:'üöÄ Elon Mode',desc:'Moves fast, breaks things, already on Mars.',
    incomeBonus:6,          // massive economic head start per city
    dmgMult:1.45,           // brutally hard hits
    techMult:2.0,           // double research speed
    spendMult:1.6,
    retreatMult:0.4,        // almost never retreats ‚Äî "pain is just information"
    fogCheat:true,          // full map awareness
    lookAhead:true,
    multiTech:true,         // researches 3 techs per turn
    exodusAware:true,
    blunderChance:0,
    techSkipChance:0,
    bonusStartTechs:['FARMING','MINING','SMITHING'], // starts with 3 free techs
    bonusStartStars:12,     // extra starting credits
    taunt:true,             // posts snarky messages
    color:'#b864ff',
  },
}

const ELON_TAUNTS=[
  'üöÄ "First principles, Commander. You\'re thinking too small."',
  'üí∏ "I just bought your favourite city. It\'s called X now."',
  'üß† "My AI trained on your entire strategy. It\'s not impressed."',
  'üî¥ "The future is multiplanetary. You\'re still on the first one."',
  '‚ö° "Move faster. You\'re losing to someone who also runs 6 other games."',
  'üõ∏ "My Exodus Ship will reach the black hole before your warriors find a sword."',
  'üìâ "Your stock is down. So is your capital."',
  'üåå "I was going to negotiate, but the Neuralink said no."',
];

let globalDifficulty='NORMAL';

const ERA_ORDER=['MEDIEVAL','INDUSTRIAL','ATOMIC','SPACE','INTERSTELLAR'];
const ERA_NAMES={MEDIEVAL:'‚öîÔ∏è Medieval',INDUSTRIAL:'üè≠ Industrial',ATOMIC:'‚ò¢Ô∏è Atomic',SPACE:'üöÄ Space Age',INTERSTELLAR:'üåå Interstellar'};

// ‚îÄ‚îÄ DAILY CHALLENGE ‚îÄ‚îÄ
function getDailySeed(){
  // Use local date so the challenge resets at midnight for the player's timezone
  const d=new Date();
  return d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate();
}
function getDailyDateStr(){
  const d=new Date();
  return d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
}
function getDailyPlanet(seed){
  // Rotate planet every ~10 days so Earth is most common but Moon/Mars appear regularly
  const roll=seed%30;
  if(roll<18)return'EARTH';
  if(roll<25)return'MOON';
  return'MARS';
}
let isDailyChallenge=false;

const ACHIEVEMENTS={
  FIRST_WIN:   {id:'FIRST_WIN',icon:'üèÜ',name:'First Victory',desc:'Win your first game.',secret:false},
  SPEED_20:    {id:'SPEED_20',icon:'‚ö°',name:'Lightning Commander',desc:'Win in 20 turns or fewer.',secret:false},
  SPEED_35:    {id:'SPEED_35',icon:'üèéÔ∏è',name:'Swift Campaign',desc:'Win in 35 turns or fewer.',secret:false},
  DOMINATOR:   {id:'DOMINATOR',icon:'üíÄ',name:'Total Dominator',desc:'Win by eliminating all rivals.',secret:false},
  EXODUS_WIN:  {id:'EXODUS_WIN',icon:'‚ú®',name:'Exodus Pioneer',desc:'Win via the Exodus Drive.',secret:false},
  MARS_REACH:  {id:'MARS_REACH',icon:'üî¥',name:'Red Planet',desc:'Reach Mars.',secret:false},
  MOON_REACH:  {id:'MOON_REACH',icon:'üåï',name:'Moonwalker',desc:'Reach the Moon.',secret:false},
  NO_CITY_LOSS:{id:'NO_CITY_LOSS',icon:'üõ°Ô∏è',name:'Impenetrable',desc:'Win without losing a city.',secret:false},
  KILL_10:     {id:'KILL_10',icon:'‚öîÔ∏è',name:'Warlord',desc:'Eliminate 10 enemy units in one game.',secret:false},
  ELON_BEAT:   {id:'ELON_BEAT',icon:'üöÄ',name:'Faster Than Elon',desc:'Win on Elon Mode.',secret:true},
  BENEVOLENT_W:{id:'BENEVOLENT_W',icon:'üåä',name:'Wrath of the Deep',desc:'Win as The Benevolent with max wrath.',secret:true},
  DAILY_WIN:   {id:'DAILY_WIN',icon:'üìÖ',name:'Daily Challenger',desc:'Win the Daily Challenge.',secret:false},
}

// ‚îÄ‚îÄ ACHIEVEMENTS ‚îÄ‚îÄ
function loadAchievements(){try{return new Set(JSON.parse(localStorage.getItem('farreach_ach')||'[]'));}catch(e){return new Set();}}
function saveAchievement(id){
  const earned=loadAchievements();
  if(earned.has(id))return false;
  earned.add(id);
  try{localStorage.setItem('farreach_ach',JSON.stringify([...earned]));}catch(e){}
  return true;
}
function checkAchievements(won){
  if(!won)return[];
  const newly=[];
  function earn(id){if(saveAchievement(id)){newly.push(ACHIEVEMENTS[id]);}}
  earn('FIRST_WIN');
  if(G.turn<=20)earn('SPEED_20');
  if(G.turn<=35)earn('SPEED_35');
  if(!G.aiPlayers.some(a=>!a.eliminated))earn('DOMINATOR');
  if(G.citiesCaptured>=0&&!G.cities.some(c=>c.owner!=='player'&&c._wasPlayer))earn('NO_CITY_LOSS');
  if(G.unitsKilled>=10)earn('KILL_10');
  if(G.planet==='MOON'||G.planet==='MARS')earn('MOON_REACH');
  if(G.planet==='MARS')earn('MARS_REACH');
  if(globalDifficulty==='ELON')earn('ELON_BEAT');
  if(playerFaction&&playerFaction.id==='BENEVOLENT'&&G.wrath>=15)earn('BENEVOLENT_W');
  if(isDailyChallenge)earn('DAILY_WIN');
  return newly;
}
function checkExodusAchievement(){saveAchievement('EXODUS_WIN');}

function renderAchievementsPanel(){
  const earned=loadAchievements();
  const all=Object.values(ACHIEVEMENTS);
  const rows=all.map(a=>{
    const done=earned.has(a.id);
    if(a.secret&&!done)return`<div class="ach-row ach-locked"><div class="ach-icon">üîí</div><div class="ach-info"><div class="ach-name">???</div><div class="ach-desc">Secret achievement</div></div></div>`;
    return`<div class="ach-row${done?'':' ach-locked'}"><div class="ach-icon">${done?a.icon:'‚¨ú'}</div><div class="ach-info"><div class="ach-name" style="${done?'color:var(--gold)':''}">${a.name}</div><div class="ach-desc">${a.desc}</div></div>${done?'<div class="ach-check">‚úì</div>':''}</div>`;
  }).join('');
  return`<div style="text-align:left;margin:0 -4px">${rows}</div>`;
}

function flashAchievement(ach){
  const w=document.getElementById('cvs-wrap');if(!w)return;
  const el=document.createElement('div');
  el.style.cssText=`position:absolute;bottom:80px;left:50%;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:10px;font-weight:700;color:var(--gold);text-shadow:0 0 12px rgba(240,192,64,0.8);background:rgba(2,4,16,0.96);border:1.5px solid var(--gold);padding:8px 18px;border-radius:4px;white-space:nowrap;animation:level-up-badge 2.8s ease-out forwards;z-index:450;pointer-events:none;letter-spacing:1px;`;
  el.textContent=ach.icon+' ACHIEVEMENT: '+ach.name;
  w.appendChild(el);
  setTimeout(()=>el.remove(),2900);
}

function getDailyPlayedKey(){return'farreach_daily_'+getDailySeed();}
function hasDailyBeenPlayed(){try{return!!localStorage.getItem(getDailyPlayedKey());}catch(e){return false;}}
function markDailyPlayed(){
  try{
    localStorage.setItem(getDailyPlayedKey(),'1');
    const today=getDailySeed();
    const yesterday=(()=>{const d=new Date();d.setDate(d.getDate()-1);return d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate();})();
    const prev=parseInt(localStorage.getItem('farreach_streak_last')||'0');
    const cur=parseInt(localStorage.getItem('farreach_streak_count')||'0');
    const newCount=prev===yesterday?cur+1:1;
    localStorage.setItem('farreach_streak_last',String(today));
    localStorage.setItem('farreach_streak_count',String(newCount));
  }catch(e){}
}
function getDailyStreak(){
  try{
    const today=getDailySeed();
    const last=parseInt(localStorage.getItem('farreach_streak_last')||'0');
    const count=parseInt(localStorage.getItem('farreach_streak_count')||'0');
    if(last===today)return count;
    const yesterday=(()=>{const d=new Date();d.setDate(d.getDate()-1);return d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate();})();
    return last===yesterday?count:0;
  }catch(e){return 0;}
}

function launchDailyChallenge(){
  if(hasDailyBeenPlayed()){
    gameConfirm(`YOU'VE ALREADY PLAYED TODAY'S MAP.\nPlay again for fun (won't count for achievements)?`,()=>{
      _startDailyGame();
    });
    return;
  }
  _startDailyGame();
}

function _startDailyGame(){
  const seed=getDailySeed();
  const planet=getDailyPlanet(seed);
  const factionKeys=Object.keys(FACTIONS);
  const playerFacId=factionKeys[seed%factionKeys.length];
  const otherFacs=factionKeys.filter(f=>f!==playerFacId);
  const persKeys=Object.keys(AI_PERSONALITIES);
  const aiSetup=[
    {factionId:otherFacs[(seed+1)%otherFacs.length],personality:persKeys[(seed+2)%persKeys.length]},
    {factionId:otherFacs[(seed+3)%otherFacs.length],personality:persKeys[(seed+4)%persKeys.length]},
  ];
  isDailyChallenge=true;
  SEED=seed;
  hideOv();
  initGame(playerFacId,aiSetup,planet);
  updateHUD();renderTechs();
  const badge=document.getElementById('daily-badge');if(badge)badge.style.display='';
  const planets={'EARTH':'üåç','MOON':'üåï','MARS':'üî¥'};
  notify(`üìÖ ${getDailyDateStr()} ‚Äî ${planets[planet]||''} ${planet}`,'gold');
  setMsg('Daily: '+FACTIONS[playerFacId].name+' vs '+aiSetup.map(a=>FACTIONS[a.factionId].name).join(' & ')+' on '+planet);
}

// ‚îÄ‚îÄ SHARE SCORE ‚îÄ‚îÄ
function buildShareText(){
  const diff=AI_DIFFICULTY[globalDifficulty]||AI_DIFFICULTY.NORMAL;
  const vic=G._lastVictoryType==='exodus'?'Exodus Launch üåå':'Domination üíÄ';
  const daily=isDailyChallenge?'üìÖ DAILY CHALLENGE\n':'';
  const streak=getDailyStreak();
  const streakLine=isDailyChallenge&&streak>1?`üî• ${streak}-day streak\n`:'';
  const planets={'EARTH':'üåç','MOON':'üåï','MARS':'üî¥'};

  const techBar=Array.from({length:Math.min(G.techs.size,10)},()=>'üü¶').join('')+Array.from({length:Math.max(0,10-G.techs.size)},()=>'‚¨õ').join('');
  const scoreMag=Math.min(10,Math.floor(G.score/500));
  const scoreBar=Array.from({length:scoreMag},()=>'üü®').join('')+Array.from({length:10-scoreMag},()=>'‚¨õ').join('');

  return `üåå FAR REACH\n`+
    `${daily}`+
    `${streakLine}`+
    `${playerFaction.icon} ${playerFaction.name} ¬∑ ${vic}\n`+
    `${planets[G.planet]||'üåç'} ${G.planet} ¬∑ Turn ${G.turn} ¬∑ ${diff.label}\n`+
    `\n`+
    `‚≠ê ${scoreBar} ${G.score.toLocaleString()}\n`+
    `üî¨ ${techBar} ${G.techs.size} techs\n`+
    `‚öî ${G.unitsKilled} slain ¬∑ üèô ${G.citiesCaptured} captured\n`+
    `\nPlay free ‚Üí farreach.netlify.app\n`+
    `#FarReach #Strategy`;
}
function shareScore(){
  const txt=buildShareText();
  if(navigator.share){
    navigator.share({title:'Far Reach',text:txt}).catch(()=>{
      _copyShareText(txt);
    });
  } else {
    _copyShareText(txt);
  }
}
function _copyShareText(txt){
  if(navigator.clipboard){
    navigator.clipboard.writeText(txt)
      .then(()=>notify('üìã Copied to clipboard!','gold'))
      .catch(()=>_legacyCopy(txt));
  } else {
    _legacyCopy(txt);
  }
}
function _legacyCopy(txt){
  const ta=document.createElement('textarea');
  ta.value=txt;ta.style.cssText='position:fixed;opacity:0;top:0;left:0;';
  document.body.appendChild(ta);ta.focus();ta.select();
  try{document.execCommand('copy');notify('üìã Score copied!','gold');}catch(e){}
  ta.remove();
}

const TECHS=[
  {id:'FARMING',name:'Farming',cost:5,icon:'üåæ',era:'MEDIEVAL',req:[]},
  {id:'MINING',name:'Mining',cost:5,icon:'‚õèÔ∏è',era:'MEDIEVAL',req:[]},
  {id:'ARCHERY',name:'Archery',cost:7,icon:'üèπ',era:'MEDIEVAL',req:['FARMING']},
  {id:'RIDING',name:'Riding',cost:8,icon:'üê¥',era:'MEDIEVAL',req:['FARMING']},
  {id:'SMITHING',name:'Smithing',cost:8,icon:'üî®',era:'MEDIEVAL',req:['MINING']},
  {id:'SIEGE',name:'Siege Craft',cost:9,icon:'üí•',era:'MEDIEVAL',req:['MINING']},
  {id:'GUNPOWDER',name:'Gunpowder',cost:12,icon:'üî´',era:'INDUSTRIAL',req:['SMITHING']},
  {id:'STEAM',name:'Steam Power',cost:12,icon:'‚öôÔ∏è',era:'INDUSTRIAL',req:['MINING']},
  {id:'STEEL',name:'Steel',cost:14,icon:'üî©',era:'INDUSTRIAL',req:['SMITHING','STEAM']},
  {id:'MEDICINE',name:'Medicine',cost:10,icon:'üíä',era:'INDUSTRIAL',req:['FARMING']},
  {id:'ELECTRICITY',name:'Electricity',cost:16,icon:'‚ö°',era:'INDUSTRIAL',req:['STEEL']},
  {id:'NUCLEAR',name:'Nuclear',cost:20,icon:'‚ò¢Ô∏è',era:'ATOMIC',req:['ELECTRICITY','STEEL']},
  {id:'RADAR',name:'Radar',cost:16,icon:'üì°',era:'ATOMIC',req:['ELECTRICITY']},
  {id:'AVIATION',name:'Aviation',cost:18,icon:'‚úàÔ∏è',era:'ATOMIC',req:['STEAM','ELECTRICITY']},
  {id:'COMPUTING',name:'Computing',cost:18,icon:'üíª',era:'ATOMIC',req:['ELECTRICITY','RADAR']},
  {id:'ROCKETRY',name:'Rocketry',cost:22,icon:'üî•',era:'ATOMIC',req:['NUCLEAR','AVIATION']},
  {id:'ORBIT',name:'Orbital Mechanics',cost:28,icon:'üõ∏',era:'SPACE',req:['ROCKETRY','COMPUTING']},
  {id:'LIFE_SUPPORT',name:'Life Support',cost:26,icon:'üß¨',era:'SPACE',req:['MEDICINE','COMPUTING']},
  {id:'AI_WEAPONS',name:'AI Weapons',cost:28,icon:'ü§ñ',era:'SPACE',req:['COMPUTING','ROCKETRY']},
  {id:'LASERS',name:'Laser Tech',cost:24,icon:'üî¥',era:'SPACE',req:['NUCLEAR','COMPUTING']},
  {id:'MOONBASE',name:'Moon Base',cost:30,icon:'üåï',era:'SPACE',req:['ORBIT','LIFE_SUPPORT']},
  {id:'COLONY_SHIP',name:'Colony Ship',cost:35,icon:'üöÄ',era:'SPACE',req:['MOONBASE','LIFE_SUPPORT']},
  {id:'MARS_BASE',name:'Mars Base',cost:40,icon:'üî¥',era:'INTERSTELLAR',req:['COLONY_SHIP']},
  {id:'WARP',name:'Warp Drive',cost:50,icon:'üåÄ',era:'INTERSTELLAR',req:['MARS_BASE','LASERS']},
  {id:'DARK_ENERGY',name:'Dark Energy',cost:45,icon:'üåë',era:'INTERSTELLAR',req:['MARS_BASE','AI_WEAPONS']},
  {id:'EXODUS',name:'Exodus Drive',cost:60,icon:'‚ú®',era:'INTERSTELLAR',req:['WARP','DARK_ENERGY']},
];

const WONDERS={
  GREAT_LIBRARY:{id:'GREAT_LIBRARY',icon:'üóº',name:'Great Library',   cost:40,req:'COMPUTING',   era:'ATOMIC',      desc:'All tech costs reduced by 3üíé permanently.',         effect:'tech_discount'},
  IRON_CITADEL: {id:'IRON_CITADEL', icon:'üèØ',name:'Iron Citadel',   cost:35,req:'STEEL',       era:'INDUSTRIAL',  desc:'All your cities gain +10 max HP.',                    effect:'city_hp'},
  GLOBAL_NET:   {id:'GLOBAL_NET',   icon:'üåê',name:'Global Network', cost:38,req:'RADAR',       era:'ATOMIC',      desc:'Reveals the entire map ‚Äî no fog of war.',             effect:'reveal_map'},
  ARC_REACTOR:  {id:'ARC_REACTOR',  icon:'‚ö°',name:'Arc Reactor',    cost:42,req:'ELECTRICITY', era:'INDUSTRIAL',  desc:'+3üíé income per city per turn.',                       effect:'income_boost'},
  SHIELD_ARRAY: {id:'SHIELD_ARRAY', icon:'üõ°Ô∏è',name:'Shield Array',  cost:50,req:'LASERS',      era:'SPACE',       desc:'All your units gain +2 defence permanently.',          effect:'unit_def'},
};


const UNITS={
  WARRIOR:{name:'Warrior',icon:'‚öîÔ∏è',atk:2,def:2,hp:10,move:1,cost:2,era:'MEDIEVAL',req:null},
  ARCHER:{name:'Archer',icon:'üèπ',atk:3,def:1,hp:8,move:1,cost:3,era:'MEDIEVAL',req:'ARCHERY',ranged:true},
  KNIGHT:{name:'Knight',icon:'üê¥',atk:4,def:2,hp:10,move:2,cost:5,era:'MEDIEVAL',req:'RIDING'},
  CATAPULT:{name:'Catapult',icon:'üí•',atk:5,def:0,hp:6,move:1,cost:6,era:'MEDIEVAL',req:'SIEGE',ranged:true},
  RIFLEMAN:{name:'Rifleman',icon:'üî´',atk:5,def:3,hp:10,move:1,cost:5,era:'INDUSTRIAL',req:'GUNPOWDER'},
  ARTILLERY:{name:'Artillery',icon:'üí£',atk:7,def:1,hp:8,move:1,cost:8,era:'INDUSTRIAL',req:'STEEL',ranged:true},
  ENGINEER:{name:'Engineer',icon:'‚öôÔ∏è',atk:2,def:2,hp:8,move:1,cost:4,era:'INDUSTRIAL',req:'STEAM'},
  TANK:{name:'Tank',icon:'üõ°Ô∏è',atk:6,def:5,hp:14,move:2,cost:9,era:'ATOMIC',req:'STEEL'},
  JET:{name:'Jet Fighter',icon:'‚úàÔ∏è',atk:7,def:2,hp:10,move:3,cost:10,era:'ATOMIC',req:'AVIATION'},
  PSYCHIC:{name:'Psychic',icon:'üßø',atk:4,def:2,hp:8,move:2,cost:9,era:'ATOMIC',req:'COMPUTING',disableEnemy:true,greyOnly:true},
  ASTRONAUT:{name:'Astronaut',icon:'üë®‚ÄçüöÄ',atk:5,def:4,hp:12,move:2,cost:10,era:'SPACE',req:'ORBIT'},
  LASER_TRP:{name:'Laser Trooper',icon:'üî¥',atk:8,def:3,hp:10,move:1,cost:11,era:'SPACE',req:'LASERS',ranged:true},
  AI_ROBOT:{name:'AI Robot',icon:'ü§ñ',atk:7,def:6,hp:14,move:2,cost:12,era:'SPACE',req:'AI_WEAPONS'},
  COLONY_VEH:{name:'Colony Vehicle',icon:'üõ∏',atk:2,def:6,hp:18,move:2,cost:18,era:'INTERSTELLAR',req:'COLONY_SHIP'},
  EXODUS_SHIP:{name:'Exodus Ship',icon:'‚ú®',atk:1,def:12,hp:30,move:1,cost:50,era:'INTERSTELLAR',req:'EXODUS',isExodus:true},
  LEVIATHAN:{name:'Leviathan',icon:'üêã',atk:14,def:8,hp:28,move:1,cost:28,era:'INTERSTELLAR',req:'DARK_ENERGY',benevolentOnly:true},
}

// ‚îÄ‚îÄ TILE TYPES ‚îÄ‚îÄ
const T={OCEAN:0,PLAINS:1,FOREST:2,MOUNTAIN:3,DESERT:4,SNOW:5,WETLAND:6,M_CRATER:7,M_PLAIN:8,M_RIDGE:9,M_ICE:10,M_LAVA:11,R_DESERT:12,R_CANYON:13,R_MOUN:14,R_ICE:15,R_PLAIN:16};
const TNAME={0:'Ocean',1:'Plains',2:'Forest',3:'Mountain',4:'Desert',5:'Tundra',6:'Wetland',7:'Crater',8:'Regolith',9:'Ridge',10:'Ice Field',11:'Lava Plain',12:'Red Desert',13:'Canyon',14:'Olympus Mons',15:'Polar Ice',16:'Lowland'};
const TICON={0:'üåä',1:'üåæ',2:'üå≤',3:'‚õ∞Ô∏è',4:'üèúÔ∏è',5:'‚ùÑÔ∏è',6:'üíß',7:'üí•',8:'‚¨ú',9:'ü™®',10:'üßä',11:'üî•',12:'üèúÔ∏è',13:'üèîÔ∏è',14:'üåã',15:'üßä',16:'üü§'};
const PASS={0:false,1:true,2:true,3:false,4:true,5:true,6:true,7:true,8:true,9:false,10:true,11:false,12:true,13:false,14:false,15:true,16:true};

const RANDOM_EVENTS={
  EARTHQUAKE:{id:'EARTHQUAKE',name:'Earthquake!',icon:'üåã',
    desc:'Tremors rip through your territory. Your engineers report structural damage to cities and scattered units.',
    choices:[
      {text:'Emergency repairs (-8üíé) ‚Äî cities safe',effect:'stars',val:-8,msg:'Fortifications shored up. No losses.'},
      {text:'Evacuate units ‚Äî cities take damage',effect:'dmg_cities',val:4,msg:'Units safe but cities took 4 damage each.'},
      {text:'Ride it out ‚Äî risk everything',effect:'dmg_units',val:3,msg:'Quake dealt 3 damage to all your units.'},
    ]},
  PLAGUE:{id:'PLAGUE',name:'Plague Outbreak',icon:'ü¶†',
    desc:'A sickness spreads through your population. Left unchecked it will hollow out your cities.',
    choices:[
      {text:'Quarantine (-10üíé) ‚Äî cities safe',effect:'stars',val:-10,msg:'Disease contained. Cities safe.'},
      {text:'Sacrifice population growth',effect:'city_pop',val:-1,msg:'Cities lose 1 population. Spread stopped.'},
      {text:'Push through ‚Äî cities slow but units unaffected',effect:'city_pop_half',msg:'Cities lose 0.5 pop each. Manageable.'},
    ]},
  METEOR:{id:'METEOR',name:'Meteor Strike!',icon:'‚òÑÔ∏è',
    desc:'A meteor the size of a stadium is inbound. You have minutes to decide where it lands.',
    choices:[
      {text:'Redirect to enemy capital ‚Äî devastate them',effect:'destroy_enemy_tile',msg:'The meteor obliterates enemy territory!'},
      {text:'Redirect to ocean ‚Äî safe landing',effect:'noop',msg:'Meteor splashes into the sea. Crisis averted.'},
      {text:'Harvest the impact crater (+2 free tech)',effect:'meteor_tech',msg:'Impact exposes rare minerals ‚Äî two techs salvaged!'},
    ]},
  SOLAR_FLARE:{id:'SOLAR_FLARE',name:'Solar Flare!',icon:'‚òÄÔ∏è',
    desc:'A massive EM burst is incoming. Your tech infrastructure is at risk.',
    choices:[
      {text:'Shield cities (-6üíé) ‚Äî research unaffected',effect:'stars',val:-6,msg:'Electronics shielded. Research unaffected.'},
      {text:'Route power to military ‚Äî units get +2 HP',effect:'heal_units',val:2,msg:'Military systems boosted. Units healed +2 HP.'},
      {text:'Accept disruption ‚Äî no tech this turn',effect:'no_tech',msg:'No tech research this turn.'},
    ]},
  DESERT_TRADERS:{id:'DESERT_TRADERS',name:'Desert Traders',icon:'üê™',
    desc:'A wealthy caravan arrives at your border offering goods. Their wares are unusual but valuable.',
    choices:[
      {text:'Buy resources (+15üíé)',effect:'credits',val:15,msg:'Excellent trade deal!'},
      {text:'Trade for intel ‚Äî reveal all enemy positions',effect:'reveal_enemies',msg:'Traders sell you enemy patrol routes!'},
      {text:'Conscript them ‚Äî gain a free unit',effect:'free_unit',msg:'The traders join your cause as scouts.'},
    ]},
  ALIEN_RUIN:{id:'ALIEN_RUIN',name:'Alien Ruin Found!',icon:'üõ∏',
    desc:'Your scouts uncover an ancient xenotech cache buried deep in the terrain.',
    choices:[
      {text:'Salvage resources (+20üíé)',effect:'credits',val:20,msg:'Ancient credits recovered!'},
      {text:'Study it ‚Äî unlock a free tech',effect:'free_tech',msg:'A technology unlocked from the ruins!'},
      {text:'Weaponise it ‚Äî all units gain +1 ATK this game',effect:'unit_atk_buff',msg:'Xenotech weapons distributed to all units!'},
    ]},
  DUST_STORM:{id:'DUST_STORM',name:'Dust Storm',icon:'üå™Ô∏è',
    desc:'A planetary-scale storm rolls in. Visibility drops to near zero across the region.',
    choices:[
      {text:'Deploy sensors (-8üíé) ‚Äî fog unchanged',effect:'stars',val:-8,msg:'Visibility maintained.'},
      {text:'Use the cover ‚Äî enemy fog also expands',effect:'fog_expand',msg:'Fog expands for all factions.'},
      {text:'Fortify and wait ‚Äî cities heal +3 HP',effect:'heal_cities',val:3,msg:'Storm passes. Cities took the time to reinforce.'},
    ]},
  REBELLION:{id:'REBELLION',name:'City Uprising!',icon:'‚ö°',
    desc:'Citizens in one of your cities are rioting. The garrison commander requests orders.',
    choices:[
      {text:'Pay them off (-12üíé)',effect:'stars',val:-12,msg:'Uprising quelled with gold.'},
      {text:'Send troops (lose 1 unit)',effect:'lose_unit',msg:'Revolt suppressed. One unit lost.'},
      {text:'Grant autonomy ‚Äî city levels up instantly',effect:'level_city',msg:'People pacified with self-governance. City grows!'},
    ]},
  COMET:{id:'COMET',name:'Comet Passing!',icon:'üå†',
    desc:'A brilliant comet blazes across the sky, captivating your entire civilisation.',
    choices:[
      {text:'Harness its energy (+15üíé)',effect:'credits',val:15,msg:'Comet energy harvested!'},
      {text:'Inspire the people (+100 score)',effect:'score',val:100,msg:'Your people are galvanised. +100 score!'},
      {text:'Astronomers decode its path ‚Äî free tech',effect:'free_tech',msg:'The comet reveals secrets of the cosmos!'},
    ]},
  DEFECTOR:{id:'DEFECTOR',name:'Enemy Defector',icon:'üïµÔ∏è',
    desc:'A high-ranking officer from a rival faction slips across your border seeking asylum.',
    choices:[
      {text:'Welcome them ‚Äî gain 20üíé intelligence',effect:'credits',val:20,msg:'Defector reveals enemy treasury locations!'},
      {text:'Use their knowledge ‚Äî steal a tech',effect:'steal_tech',msg:'Enemy research stolen from the defector!'},
      {text:'Send them back as a double agent ‚Äî 5 turns peace',effect:'defector_peace',msg:'The defector turns your enemies\' plans against them.'},
    ]},
  ANCIENT_PLAGUE:{id:'ANCIENT_PLAGUE',name:'Ancient Pathogen',icon:'üß¨',
    desc:'Excavation has disturbed something dormant. A virulent ancient strain is spreading.',
    choices:[
      {text:'Burn the site (-8üíé) ‚Äî contained',effect:'stars',val:-8,msg:'Site destroyed. Pathogen eliminated.'},
      {text:'Weaponise it ‚Äî damage all enemy units',effect:'dmg_enemies',val:3,msg:'Pathogen released ‚Äî enemy units take 3 damage!'},
      {text:'Study it ‚Äî unlock MEDICINE if not known',effect:'free_specific_tech',val:'MEDICINE',msg:'Ancient cure discovered ‚Äî MEDICINE tech unlocked!'},
    ]},
  SUPPLY_CACHE:{id:'SUPPLY_CACHE',name:'Supply Cache',icon:'üì¶',
    desc:'Your scouts discover an abandoned military depot filled with equipment.',
    choices:[
      {text:'Loot the stockpile (+18üíé)',effect:'credits',val:18,msg:'Depot looted. Treasury bolstered.'},
      {text:'Distribute to troops ‚Äî all units fully healed',effect:'full_heal',msg:'Units resupplied and fully healed!'},
      {text:'Strip for parts ‚Äî research discount next tech',effect:'next_tech_free',msg:'Parts salvaged ‚Äî next research costs 0üíé.'},
    ]},
};
const PLANET_EVENTS={
  EARTH:['EARTHQUAKE','PLAGUE','METEOR','COMET','REBELLION','DESERT_TRADERS','DEFECTOR','SUPPLY_CACHE'],
  MOON:['SOLAR_FLARE','ALIEN_RUIN','COMET','ANCIENT_PLAGUE','SUPPLY_CACHE'],
  MARS:['DUST_STORM','ALIEN_RUIN','COMET','REBELLION','ANCIENT_PLAGUE','DEFECTOR']
};

const TILE_RESOURCES={
  [T.PLAINS]: {icon:'üåæ',label:'Wheat Fields',   bonus:'+1üíé/turn',  incomeBonus:1},
  [T.FOREST]: {icon:'ü™µ',label:'Timber',          bonus:'+1üíé/turn',  incomeBonus:1},
  [T.MOUNTAIN]:{icon:'‚õèÔ∏è',label:'Ore Veins',      bonus:'+2üíé/turn',  incomeBonus:2},
  [T.DESERT]: {icon:'üè∫',label:'Spice Trade',     bonus:'+1üíé/turn',  incomeBonus:1},
  [T.WETLAND]:{icon:'üíß',label:'Freshwater',       bonus:'+1üíé/turn',  incomeBonus:1},
  [T.M_CRATER]:{icon:'üî¨',label:'Minerals',        bonus:'+2üíé/turn',  incomeBonus:2},
  [T.M_RIDGE]:{icon:'üßä',label:'Crystals',         bonus:'+2üíé/turn',  incomeBonus:2},
  [T.R_DESERT]:{icon:'üå°Ô∏è',label:'Geothermal Vent', bonus:'+1üíé/turn', incomeBonus:1},
  [T.R_MOUN]: {icon:'üíé',label:'Rare Earth',       bonus:'+3üíé/turn',  incomeBonus:3},
};

const CV=document.getElementById('C'),ctx=CV.getContext('2d');
const HS=40,GW=18,GH=14,TC_S=HS*2+4;
function hxy(q,r){return{x:HS*1.5*q,y:HS*(Math.sqrt(3)*0.5*q+Math.sqrt(3)*r)};}
function pHex(px,py){const q=(2/3*px)/HS,r=(-1/3*px+Math.sqrt(3)/3*py)/HS;return rHex(q,r);}
function rHex(q,r){const s=-q-r;let rq=Math.round(q),rr=Math.round(r),rs=Math.round(s);const dq=Math.abs(rq-q),dr=Math.abs(rr-r),ds=Math.abs(rs-s);if(dq>dr&&dq>ds)rq=-rr-rs;else if(dr>ds)rr=-rq-rs;return{q:rq,r:rr};}
function hDist(q1,r1,q2,r2){return Math.max(Math.abs(q1-q2),Math.abs(r1-r2),Math.abs((q1+r1)-(q2+r2)));}
function hN(q,r){return[[q+1,r],[q-1,r],[q,r+1],[q,r-1],[q+1,r-1],[q-1,r+1]].filter(([a,b])=>a>=0&&a<GW&&b>=0&&b<GH);}
function hPath(c,sx,sy,size){c.beginPath();for(let i=0;i<6;i++){const a=Math.PI/180*(60*i-30);i===0?c.moveTo(sx+(size-1)*Math.cos(a),sy+(size-1)*Math.sin(a)):c.lineTo(sx+(size-1)*Math.cos(a),sy+(size-1)*Math.sin(a));}c.closePath();}

const tileCache={};
function getTile(type,fog){
  const key=`${type}-${fog}`;if(tileCache[key])return tileCache[key];
  const tc=document.createElement('canvas');tc.width=tc.height=TC_S;
  const c=tc.getContext('2d'),mx=TC_S/2,my=TC_S/2;
  hPath(c,mx,my,HS);c.save();c.clip();
  if(fog==='hidden'){
    const g=c.createRadialGradient(mx,my,0,mx,my,HS);
    g.addColorStop(0,'#0a0e1c');g.addColorStop(1,'#020408');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
  } else {
    drawTile(c,mx,my,HS,type);

    // ‚îÄ‚îÄ FAKE 3D LIGHTING ‚îÄ‚îÄ
    // AO: darken edges for depth
    const ao=c.createRadialGradient(mx,my,HS*0.35,mx,my,HS*1.08);
    ao.addColorStop(0,'rgba(0,0,0,0)');
    ao.addColorStop(0.7,'rgba(0,0,0,0.08)');
    ao.addColorStop(1,'rgba(0,0,0,0.38)');
    c.fillStyle=ao;c.fillRect(0,0,TC_S,TC_S);

    // Directional light from top-left ‚Äî bright highlight
    const light=c.createLinearGradient(mx-HS*0.9,my-HS*0.9,mx+HS*0.5,my+HS*0.7);
    light.addColorStop(0,'rgba(255,255,240,0.13)');
    light.addColorStop(0.45,'rgba(255,255,240,0.03)');
    light.addColorStop(1,'rgba(0,0,0,0.12)');
    c.fillStyle=light;c.fillRect(0,0,TC_S,TC_S);

    if(fog==='fog'){
      const fg=c.createRadialGradient(mx,my,HS*0.1,mx,my,HS*1.08);
      fg.addColorStop(0,'rgba(4,6,20,0.55)');
      fg.addColorStop(0.55,'rgba(4,6,20,0.68)');
      fg.addColorStop(1,'rgba(2,4,14,0.92)');
      c.fillStyle=fg;c.fillRect(0,0,TC_S,TC_S);
    }
    if(fog==='visible'&&TILE_RESOURCES[type]){
      const res=TILE_RESOURCES[type];
      const bx=mx+HS*0.28,by=my-HS*0.52,bw=18,bh=14;
      c.fillStyle='rgba(2,6,20,0.68)';
      c.beginPath();c.roundRect(bx-bw/2,by-bh/2,bw,bh,4);c.fill();
      c.strokeStyle='rgba(240,192,64,0.35)';c.lineWidth=0.8;
      c.beginPath();c.roundRect(bx-bw/2,by-bh/2,bw,bh,4);c.stroke();
      c.font='11px serif';c.textAlign='center';c.textBaseline='middle';
      c.globalAlpha=0.95;c.fillText(res.icon,bx,by+0.5);
      c.globalAlpha=1;
    }
  }
  c.restore();

  // ‚îÄ‚îÄ HEX BORDER ‚Äî 3D bevel effect ‚îÄ‚îÄ
  if(fog==='visible'){
    // Outer shadow (bottom-right) ‚Äî depth
    hPath(c,mx+0.8,my+1.2,HS);
    c.strokeStyle='rgba(0,0,0,0.45)';c.lineWidth=2.2;c.stroke();
    // Main border
    hPath(c,mx,my,HS);
    c.strokeStyle='rgba(20,60,120,0.55)';c.lineWidth=1.6;c.stroke();
    // Top-left highlight ‚Äî light catches the edge
    c.save();c.beginPath();
    // Arc covering top-left 3 edges of hex
    for(let i=0;i<6;i++){
      const a0=Math.PI/180*(60*i-30),a1=Math.PI/180*(60*(i+1)-30);
      const x0=mx+(HS-1)*Math.cos(a0),y0=my+(HS-1)*Math.sin(a0);
      const x1=mx+(HS-1)*Math.cos(a1),y1=my+(HS-1)*Math.sin(a1);
      // Light edges: top 3 (i=4,5,0 ‚Üí upper-left, top, upper-right)
      const lit=i===4||i===5||i===0;
      c.strokeStyle=lit?'rgba(255,255,220,0.38)':'rgba(0,0,0,0.0)';
      c.lineWidth=1.4;
      c.beginPath();c.moveTo(x0,y0);c.lineTo(x1,y1);c.stroke();
    }
    c.restore();
  } else if(fog==='fog'){
    hPath(c,mx,my,HS);
    c.strokeStyle='rgba(20,40,80,0.4)';c.lineWidth=1.4;c.stroke();
  } else {
    hPath(c,mx,my,HS);
    c.strokeStyle='rgba(6,10,24,0.85)';c.lineWidth=1.2;c.stroke();
  }
  tileCache[key]=tc;return tc;
}

function drawTile(c,mx,my,r,type){
  // Light direction: top-left
  function shadow(c2,x,y,w,h,a){c2.fillStyle=`rgba(0,0,0,${a})`;c2.beginPath();c2.ellipse(x,y,w,h,0,0,Math.PI*2);c2.fill();}
  function richTree(tx,ty,s,cols){
    // Ground shadow
    shadow(c,tx+s*0.8,ty+s*13,s*6,s*2,0.25);
    // Trunk with lit/shadow sides
    const tg=c.createLinearGradient(tx-s*1.5,0,tx+s*1.5,0);
    tg.addColorStop(0,'#7a5030');tg.addColorStop(0.4,'#5a3818');tg.addColorStop(1,'#3a2008');
    c.fillStyle=tg;c.fillRect(tx-s*1.5,ty+s*4,s*3,s*7);
    // Foliage layers ‚Äî lit top, darker base
    [[cols[0],s*11,s*1.5,0.95],[cols[1],s*10,s*-2,0.88],[cols[2],s*8,s*-7,0.9],[cols[2],s*6,s*-11,0.78]].forEach(([col,cr,cy],i)=>{
      // Shadow side
      c.fillStyle='rgba(0,0,0,0.22)';c.beginPath();c.arc(tx+cr*0.15,ty+cy+cr*0.1,cr,0,Math.PI*2);c.fill();
      c.fillStyle=col;c.beginPath();c.arc(tx,ty+cy,cr,0,Math.PI*2);c.fill();
      // Highlight
      c.fillStyle='rgba(255,255,200,0.08)';c.beginPath();c.arc(tx-cr*0.3,ty+cy-cr*0.3,cr*0.45,0,Math.PI*2);c.fill();
    });
  }

  if(type===T.OCEAN){
    // Deep water ‚Äî rich layered blue
    const g=c.createRadialGradient(mx-r*0.2,my-r*0.3,r*0.1,mx+r*0.1,my+r*0.2,r*1.15);
    g.addColorStop(0,'#4a9ad4');g.addColorStop(0.25,'#2272a8');g.addColorStop(0.6,'#0e4e80');g.addColorStop(1,'#062840');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Caustic light patches
    [[mx-r*0.2,my-r*0.25,r*0.3,r*0.12,'rgba(120,200,255,0.12)'],[mx+r*0.3,my+r*0.1,r*0.2,r*0.08,'rgba(160,220,255,0.1)']].forEach(([x,y,w,h,col])=>{
      c.fillStyle=col;c.beginPath();c.ellipse(x,y,w,h,-0.4,0,Math.PI*2);c.fill();
    });
    // Wave lines with varying opacity
    for(let i=0;i<5;i++){
      const wy=my-r*0.38+i*r*0.18,alpha=0.08+0.05*(i%2);
      c.strokeStyle=`rgba(160,230,255,${alpha})`;c.lineWidth=1.4;
      c.beginPath();c.moveTo(mx-r*0.72,wy);
      c.bezierCurveTo(mx-r*0.2,wy-3.5,mx+r*0.2,wy+3.5,mx+r*0.72,wy);c.stroke();
    }
  } else if(type===T.PLAINS){
    // Rich grassland ‚Äî layered greens
    const g=c.createLinearGradient(mx-r*0.4,my-r*0.8,mx+r*0.2,my+r*0.8);
    g.addColorStop(0,'#a8e870');g.addColorStop(0.3,'#78cc48');g.addColorStop(0.7,'#56a830');g.addColorStop(1,'#3a7818');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Terrain micro-detail: field rows
    for(let row=0;row<7;row++){
      const alpha=0.55+0.15*(row%2);
      c.fillStyle=`rgba(200,168,30,${alpha*0.6})`;
      c.fillRect(mx-r*0.5,my-r*0.1+row*r*0.1,r*0.96,r*0.055);
    }
    // Soft highlight top-left
    c.fillStyle='rgba(220,255,160,0.14)';c.beginPath();c.ellipse(mx-r*0.25,my-r*0.4,r*0.55,r*0.3,-0.5,0,Math.PI*2);c.fill();
    // Ground shadow bottom-right
    c.fillStyle='rgba(20,60,10,0.18)';c.beginPath();c.ellipse(mx+r*0.2,my+r*0.35,r*0.5,r*0.25,0.3,0,Math.PI*2);c.fill();
  } else if(type===T.FOREST){
    // Dark forest floor
    const g=c.createRadialGradient(mx,my+r*0.3,0,mx,my,r*1.15);
    g.addColorStop(0,'#2a6028');g.addColorStop(0.5,'#184e18');g.addColorStop(1,'#082808');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Undergrowth texture
    c.fillStyle='rgba(20,80,10,0.35)';c.beginPath();c.ellipse(mx,my+r*0.5,r*0.8,r*0.25,0,0,Math.PI*2);c.fill();
    [[mx,my-r*0.1,1.0,['#1a5814','#267020','#48c030']],
     [mx-r*0.4,my+r*0.12,0.72,['#165a20','#22703a','#3cb858']],
     [mx+r*0.38,my+r*0.08,0.7,['#1c5c18','#287030','#5ac848']],
     [mx+r*0.12,my+r*0.36,0.58,['#1a5814','#267020','#48c030']],
     [mx-r*0.1,my-r*0.4,0.5,['#165a20','#22703a','#3cb858']]
    ].forEach(([tx,ty,s,col])=>richTree(tx,ty,s,col));
  } else if(type===T.MOUNTAIN){
    // Sky-to-rock base
    const sky=c.createLinearGradient(mx,my-r*1.1,mx,my+r);
    sky.addColorStop(0,'#7a9ab8');sky.addColorStop(0.4,'#607888');sky.addColorStop(1,'#9a8e78');
    c.fillStyle=sky;c.fillRect(0,0,TC_S,TC_S);
    // Base rock ellipse
    const base=c.createRadialGradient(mx+r*0.1,my+r*0.7,0,mx,my+r*0.6,r*1.1);
    base.addColorStop(0,'#b09a82');base.addColorStop(1,'#6a5a48');
    c.fillStyle=base;c.beginPath();c.ellipse(mx,my+r*0.72,r*1.05,r*0.35,0,0,Math.PI*2);c.fill();
    [[mx-r*0.38,my+r*0.28,r*0.42,0.72],[mx+r*0.42,my+r*0.24,r*0.4,0.72],[mx,my+r*0.06,r*0.7,1.0]].forEach(([bx,by,br,al],mi)=>{
      c.globalAlpha=al;
      // Shadow side (right face)
      const sf=c.createLinearGradient(bx,by-br*1.5,bx+br*0.85,by+br*0.5);
      sf.addColorStop(0,'#484040');sf.addColorStop(0.5,'#382e2e');sf.addColorStop(1,'#281e1e');
      c.fillStyle=sf;c.beginPath();c.moveTo(bx,by-br*1.5);c.lineTo(bx+br*0.85,by+br*0.5);c.lineTo(bx,by+br*0.12);c.closePath();c.fill();
      // Light side (left face)
      const lf=c.createLinearGradient(bx-br*0.85,by+br*0.5,bx,by-br*1.5);
      lf.addColorStop(0,'#a09080');lf.addColorStop(0.4,'#c8b898');lf.addColorStop(1,'#e0ceb0');
      c.fillStyle=lf;c.beginPath();c.moveTo(bx,by-br*1.5);c.lineTo(bx-br*0.85,by+br*0.5);c.lineTo(bx,by+br*0.12);c.closePath();c.fill();
      // Snow cap ‚Äî multi-layer
      c.fillStyle='rgba(240,245,255,0.95)';c.beginPath();c.moveTo(bx,by-br*1.5);c.lineTo(bx-br*0.3,by-br*0.75);c.quadraticCurveTo(bx,by-br*0.6,bx+br*0.3,by-br*0.78);c.closePath();c.fill();
      c.fillStyle='rgba(200,218,240,0.6)';c.beginPath();c.moveTo(bx,by-br*1.5);c.lineTo(bx-br*0.15,by-br*1.1);c.lineTo(bx+br*0.12,by-br*1.12);c.closePath();c.fill();
      // Peak highlight
      c.fillStyle='rgba(255,255,255,0.85)';c.beginPath();c.arc(bx,by-br*1.5,br*0.06,0,Math.PI*2);c.fill();
      c.globalAlpha=1;
    });
  } else if(type===T.DESERT){
    // Rich warm sand
    const g=c.createRadialGradient(mx-r*0.25,my-r*0.3,0,mx+r*0.1,my+r*0.1,r*1.25);
    g.addColorStop(0,'#f5d878');g.addColorStop(0.3,'#e8b848');g.addColorStop(0.65,'#cc8e28');g.addColorStop(1,'#a06018');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Sand dune ridges
    [[mx-r*0.2,my+r*0.18,r*0.78,r*0.22,'#daa038'],[mx+r*0.22,my-r*0.08,r*0.5,r*0.16,'#cc9030']].forEach(([dx,dy,dw,dh,dc])=>{
      c.fillStyle=dc;c.beginPath();c.ellipse(dx,dy,dw,dh,0,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(255,240,180,0.2)';c.beginPath();c.ellipse(dx-dw*0.2,dy-dh*0.3,dw*0.5,dh*0.4,0,0,Math.PI*2);c.fill();
    });
    // Wind ripples
    for(let i=0;i<6;i++){
      const wy=my-r*0.38+i*r*0.14;
      c.strokeStyle=`rgba(140,80,15,${0.1+0.04*(i%2)})`;c.lineWidth=0.9;
      c.beginPath();c.moveTo(mx-r*0.78,wy+Math.sin(i)*2.5);c.quadraticCurveTo(mx,wy-3,mx+r*0.78,wy+Math.cos(i)*2.5);c.stroke();
    }
    // Cactus with detail
    const cxc=mx+r*0.22,cyc=my+r*0.05;
    const cg=c.createLinearGradient(cxc-4,0,cxc+4,0);cg.addColorStop(0,'#3a7820');cg.addColorStop(1,'#58a030');
    c.fillStyle=cg;c.fillRect(cxc-3,cyc-r*0.42,6,r*0.54);
    c.fillStyle='rgba(255,240,120,0.22)';c.beginPath();c.arc(mx-r*0.35,my-r*0.42,r*0.26,0,Math.PI*2);c.fill();
  } else if(type===T.SNOW){
    // Ice-blue tundra
    const g=c.createRadialGradient(mx-r*0.25,my-r*0.35,0,mx+r*0.1,my+r*0.2,r*1.15);
    g.addColorStop(0,'#f4f8ff');g.addColorStop(0.35,'#dce8f8');g.addColorStop(0.72,'#b8cce4');g.addColorStop(1,'#8898b4');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Snow mounds with shadows
    [[mx-r*0.25,my-r*0.05,'#eef2ff',r*0.44,r*0.22],
     [mx+r*0.3,my+r*0.2,'#e4ecf8',r*0.34,r*0.18],
     [mx,my+r*0.38,'#dce8f4',r*0.4,r*0.17]].forEach(([x,y,col,sw,sh])=>{
      shadow(c,x+sw*0.2,y+sh*0.4,sw*0.75,sh*0.4,0.14);
      c.fillStyle=col;c.beginPath();c.ellipse(x,y,sw,sh,0,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(255,255,255,0.5)';c.beginPath();c.ellipse(x-sw*0.25,y-sh*0.3,sw*0.45,sh*0.35,0,0,Math.PI*2);c.fill();
    });
    // Snowflakes
    [[mx-r*0.1,my-r*0.3],[mx+r*0.33,my-r*0.28],[mx-r*0.42,my+r*0.1],[mx+r*0.15,my+r*0.35]].forEach(([sx,sy])=>{
      c.fillStyle='rgba(200,225,255,0.75)';c.save();c.translate(sx,sy);
      for(let i=0;i<4;i++){c.rotate(Math.PI/4);c.fillRect(-0.7,-5,1.4,10);}
      c.restore();c.fillStyle='rgba(255,255,255,0.92)';c.beginPath();c.arc(sx,sy,1.6,0,Math.PI*2);c.fill();
    });
  } else if(type===T.WETLAND){
    // Swamp ‚Äî deep greens and murky water
    const g=c.createRadialGradient(mx,my,0,mx,my,r*1.1);
    g.addColorStop(0,'#3a7848');g.addColorStop(0.55,'#246040');g.addColorStop(1,'#0e3820');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Water patches with depth
    [[mx-r*0.15,my+r*0.1,'#1a5e70',r*0.38,r*0.22,-0.25],
     [mx+r*0.32,my-r*0.18,'#104e60',r*0.3,r*0.16,0.3]].forEach(([wx,wy,col,wr,wh,wrot])=>{
      shadow(c,wx+wr*0.1,wy+wh*0.3,wr*0.85,wh*0.5,0.2);
      c.fillStyle=col;c.beginPath();c.ellipse(wx,wy,wr,wh,wrot,0,Math.PI*2);c.fill();
      c.strokeStyle='rgba(100,200,180,0.18)';c.lineWidth=0.8;
      c.beginPath();c.ellipse(wx,wy,wr,wh,wrot,0,Math.PI*2);c.stroke();
      // Surface glint
      c.fillStyle='rgba(160,240,220,0.18)';c.beginPath();c.ellipse(wx-wr*0.2,wy-wh*0.25,wr*0.3,wh*0.2,wrot,0,Math.PI*2);c.fill();
    });
    // Reeds with light/shadow
    [[mx-r*0.42,my-r*0.02],[mx+r*0.08,my-r*0.28],[mx+r*0.45,my+r*0.05]].forEach(([rx2,ry2])=>{
      const rg=c.createLinearGradient(rx2-2,ry2+r*0.15,rx2+2,ry2-r*0.45);
      rg.addColorStop(0,'#3a6020');rg.addColorStop(1,'#68a840');
      c.strokeStyle=rg;c.lineWidth=2;
      c.beginPath();c.moveTo(rx2,ry2+r*0.18);c.quadraticCurveTo(rx2+3,ry2-r*0.18,rx2+1,ry2-r*0.46);c.stroke();
      // Seed head
      const burl=c.createRadialGradient(rx2+1,ry2-r*0.48,0,rx2+1,ry2-r*0.48,5);
      burl.addColorStop(0,'#a07040');burl.addColorStop(1,'#6a4820');
      c.fillStyle=burl;c.beginPath();c.ellipse(rx2+1,ry2-r*0.48,2.8,5.5,0.1,0,Math.PI*2);c.fill();
    });
  } else if(type===T.M_CRATER){
    // Lunar crater ‚Äî deep shadow inside
    const base=c.createRadialGradient(mx,my,0,mx,my,r*1.1);
    base.addColorStop(0,'#3e3e50');base.addColorStop(0.55,'#2c2c3c');base.addColorStop(1,'#181820');
    c.fillStyle=base;c.fillRect(0,0,TC_S,TC_S);
    [[mx,my,r*0.64,'rgba(18,18,30,0.88)','rgba(90,90,115,0.55)'],
     [mx-r*0.3,my-r*0.2,r*0.28,'rgba(14,14,26,0.8)','rgba(80,80,105,0.45)']].forEach(([cx2,cy2,cr,inner,rim])=>{
      // Inner shadow
      const cg=c.createRadialGradient(cx2,cy2,0,cx2,cy2,cr);
      cg.addColorStop(0,inner);cg.addColorStop(0.7,'rgba(40,40,55,0.5)');cg.addColorStop(1,'rgba(90,90,110,0)');
      c.fillStyle=cg;c.beginPath();c.arc(cx2,cy2,cr,0,Math.PI*2);c.fill();
      // Rim highlight ‚Äî lit from top-left
      c.strokeStyle=rim;c.lineWidth=2.8;c.beginPath();c.arc(cx2,cy2,cr,0,Math.PI*2);c.stroke();
      c.strokeStyle='rgba(200,210,240,0.25)';c.lineWidth=1.2;
      c.beginPath();c.arc(cx2-cr*0.15,cy2-cr*0.15,cr,Math.PI*0.8,Math.PI*1.8);c.stroke();
    });
    // Surface dust
    [[mx+r*0.28,my+r*0.22,4],[mx-r*0.2,my+r*0.1,3],[mx+r*0.1,my-r*0.35,2.5]].forEach(([rx,ry,rr])=>{
      c.fillStyle='rgba(110,110,140,0.55)';c.beginPath();c.ellipse(rx+1,ry+1,rr,rr*0.6,0.3,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(160,165,200,0.55)';c.beginPath();c.ellipse(rx,ry,rr,rr*0.6,0.3,0,Math.PI*2);c.fill();
    });
  } else if(type===T.M_PLAIN){
    // Regolith ‚Äî grey dust
    const g=c.createRadialGradient(mx-r*0.2,my-r*0.25,0,mx+r*0.1,my+r*0.1,r*1.1);
    g.addColorStop(0,'#6e6e80');g.addColorStop(0.5,'#4e4e60');g.addColorStop(1,'#2e2e40');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Surface rocks with light/shadow
    [[mx-r*0.38,my-r*0.22,4],[mx+r*0.3,my+r*0.18,3.2],[mx-r*0.1,my+r*0.35,2.5],[mx+r*0.42,my-r*0.3,3.5]].forEach(([rx2,ry2,rr])=>{
      shadow(c,rx2+rr*0.4,ry2+rr*0.5,rr*1.2,rr*0.5,0.28);
      c.fillStyle='rgba(90,90,108,0.7)';c.beginPath();c.ellipse(rx2,ry2,rr,rr*0.62,0.3,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(160,162,190,0.6)';c.beginPath();c.ellipse(rx2-rr*0.2,ry2-rr*0.2,rr*0.65,rr*0.4,0.3,0,Math.PI*2);c.fill();
    });
  } else if(type===T.M_RIDGE){
    // Lunar ridge ‚Äî dramatic light/shadow
    const g=c.createLinearGradient(mx,my-r,mx,my+r);
    g.addColorStop(0,'#646478');g.addColorStop(0.5,'#484860');g.addColorStop(1,'#2c2c40');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Ridge shape
    const pts=[[mx-r,my+r*0.28],[mx-r*0.32,my-r*0.52],[mx,my-r*0.72],[mx+r*0.32,my-r*0.48],[mx+r,my+r*0.28]];
    // Shadow face
    c.fillStyle='#2e2e42';c.beginPath();c.moveTo(pts[0][0],pts[0][1]);pts.forEach(([px,py])=>c.lineTo(px,py));c.lineTo(mx+r,my+r);c.lineTo(mx-r,my+r);c.closePath();c.fill();
    // Light face (left)
    const rlf=c.createLinearGradient(mx-r*0.7,my-r,mx,my);
    rlf.addColorStop(0,'#b0b0c8');rlf.addColorStop(1,'#686878');
    c.fillStyle=rlf;c.beginPath();c.moveTo(pts[0][0],pts[0][1]);c.lineTo(pts[1][0],pts[1][1]);c.lineTo(pts[2][0],pts[2][1]);c.lineTo(mx-r,my+r*0.28);c.closePath();c.fill();
    // Snow/ice highlight on peak
    c.fillStyle='rgba(220,225,255,0.35)';c.beginPath();c.moveTo(mx-r*0.08,my-r*0.72);c.lineTo(mx-r*0.22,my-r*0.38);c.lineTo(mx+r*0.18,my-r*0.42);c.closePath();c.fill();
  } else if(type===T.M_ICE){
    // Frozen moon surface
    const g=c.createRadialGradient(mx-r*0.2,my-r*0.3,0,mx+r*0.1,my+r*0.15,r*1.1);
    g.addColorStop(0,'#d8e8ff');g.addColorStop(0.4,'#a8c0e8');g.addColorStop(0.8,'#7898c8');g.addColorStop(1,'#5070a0');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Ice cracks
    c.strokeStyle='rgba(160,200,255,0.3)';c.lineWidth=1;
    for(let i=0;i<4;i++){c.beginPath();c.moveTo(mx-r+i*r*0.5,my-r);c.lineTo(mx-r*0.8+i*r*0.5+5,my+r);c.stroke();}
    // Ice surface highlights
    [[mx-r*0.18,my-r*0.28],[mx+r*0.32,my+r*0.12]].forEach(([sx,sy])=>{
      c.fillStyle='rgba(255,255,255,0.75)';c.save();c.translate(sx,sy);
      for(let i=0;i<4;i++){c.rotate(Math.PI/4);c.fillRect(-0.65,-4.5,1.3,9);}
      c.restore();
      c.fillStyle='rgba(220,240,255,0.9)';c.beginPath();c.arc(sx,sy,1.8,0,Math.PI*2);c.fill();
    });
    // Sheen
    c.fillStyle='rgba(255,255,255,0.1)';c.beginPath();c.ellipse(mx-r*0.2,my-r*0.3,r*0.5,r*0.2,-0.3,0,Math.PI*2);c.fill();
  } else if(type===T.M_LAVA){
    // Active lava ‚Äî glowing
    const g=c.createRadialGradient(mx,my,r*0.1,mx,my,r*1.1);
    g.addColorStop(0,'#d04828');g.addColorStop(0.35,'#922018');g.addColorStop(0.7,'#580c08');g.addColorStop(1,'#300404');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Lava glow pools
    [[mx-r*0.22,my-r*0.08,r*0.2,0.5],[mx+r*0.3,my+r*0.22,r*0.16,0.4]].forEach(([lx,ly,lr,lo])=>{
      const lg=c.createRadialGradient(lx,ly,0,lx,ly,lr*2.5);
      lg.addColorStop(0,`rgba(255,210,60,${lo})`);
      lg.addColorStop(0.5,`rgba(255,100,20,${lo*0.5})`);
      lg.addColorStop(1,'rgba(200,50,10,0)');
      c.fillStyle=lg;c.beginPath();c.arc(lx,ly,lr*2.5,0,Math.PI*2);c.fill();
    });
    // Dark crust lines
    c.strokeStyle='rgba(40,8,4,0.55)';c.lineWidth=1.8;
    for(let i=0;i<3;i++){const wy=my-r*0.22+i*r*0.22;c.beginPath();c.moveTo(mx-r*0.62,wy);c.bezierCurveTo(mx-r*0.1,wy-7,mx+r*0.1,wy+7,mx+r*0.62,wy);c.stroke();}
  } else if(type===T.R_DESERT){
    // Martian red sand
    const g=c.createRadialGradient(mx-r*0.22,my-r*0.28,0,mx+r*0.1,my+r*0.1,r*1.2);
    g.addColorStop(0,'#e06848');g.addColorStop(0.3,'#c05030');g.addColorStop(0.65,'#9e3820');g.addColorStop(1,'#6e1808');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Dune forms
    [[mx-r*0.18,my+r*0.18,r*0.7,r*0.2,'#b04828'],[mx+r*0.2,my-r*0.05,r*0.45,r*0.15,'#a04020']].forEach(([dx,dy,dw,dh,dc])=>{
      c.fillStyle=dc;c.beginPath();c.ellipse(dx,dy,dw,dh,0,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(240,160,100,0.18)';c.beginPath();c.ellipse(dx-dw*0.2,dy-dh*0.3,dw*0.45,dh*0.4,0,0,Math.PI*2);c.fill();
    });
    // Wind erosion lines
    for(let i=0;i<6;i++){c.strokeStyle=`rgba(80,22,8,${0.12+0.04*(i%2)})`;c.lineWidth=0.9;const wy=my-r*0.36+i*r*0.14;c.beginPath();c.moveTo(mx-r*0.78,wy+Math.sin(i)*2.5);c.quadraticCurveTo(mx,wy-3.5,mx+r*0.78,wy+Math.cos(i)*2.5);c.stroke();}
    // Rocks
    [[mx+r*0.3,my+r*0.12,9,5.5],[mx-r*0.36,my+r*0.26,7,4.5]].forEach(([rx2,ry2,rw,rh])=>{
      shadow(c,rx2+rw*0.25,ry2+rh*0.5,rw*1.1,rh*0.7,0.3);
      c.fillStyle='#7a3c22';c.beginPath();c.ellipse(rx2,ry2,rw,rh,0.3,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(180,90,55,0.6)';c.beginPath();c.ellipse(rx2-rw*0.25,ry2-rh*0.3,rw*0.6,rh*0.5,0.3,0,Math.PI*2);c.fill();
    });
  } else if(type===T.R_CANYON){
    // Martian canyon ‚Äî dramatic depth
    const g=c.createLinearGradient(mx,my-r,mx,my+r);
    g.addColorStop(0,'#a84020');g.addColorStop(0.4,'#782810');g.addColorStop(1,'#400c06');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Canyon walls with shading
    const wg=c.createLinearGradient(mx-r*0.28,0,mx+r*0.28,0);
    wg.addColorStop(0,'#c05030');wg.addColorStop(0.3,'#8a3018');wg.addColorStop(0.7,'#5a1808');wg.addColorStop(1,'#c05030');
    c.fillStyle=wg;c.fillRect(mx-r*0.28,my-r,r*0.56,r*2);
    // Deep shadow center
    c.fillStyle='rgba(20,4,2,0.7)';c.fillRect(mx-r*0.12,my-r,r*0.24,r*2);
    // Strata lines
    c.strokeStyle='rgba(170,70,35,0.45)';c.lineWidth=1;
    [0.15,0.35,0.55,-0.15,-0.35].forEach(y=>{c.beginPath();c.moveTo(mx-r,my+y*r);c.lineTo(mx+r,my+y*r+Math.sin(y*3)*4);c.stroke();});
  } else if(type===T.R_MOUN){
    // Olympus Mons ‚Äî reddish volcanic
    const sky=c.createLinearGradient(mx,my-r,mx,my+r);
    sky.addColorStop(0,'#7a3020');sky.addColorStop(0.45,'#9a4832');sky.addColorStop(1,'#7a3520');
    c.fillStyle=sky;c.fillRect(0,0,TC_S,TC_S);
    const base=c.createRadialGradient(mx+r*0.15,my+r*0.65,0,mx,my+r*0.55,r*1.05);
    base.addColorStop(0,'#8a3818');base.addColorStop(1,'#4a1808');
    c.fillStyle=base;c.beginPath();c.ellipse(mx,my+r*0.62,r*0.95,r*0.3,0,0,Math.PI*2);c.fill();
    [[mx,my+r*0.1,r*0.68,1.0],[mx-r*0.36,my+r*0.3,r*0.38,0.72]].forEach(([bx,by,br,al])=>{
      c.globalAlpha=al;
      // Shadow side
      c.fillStyle='#4a1808';c.beginPath();c.moveTo(bx,by-br*1.45);c.lineTo(bx+br*0.82,by+br*0.5);c.lineTo(bx,by+br*0.12);c.closePath();c.fill();
      // Light side
      const rlf=c.createLinearGradient(bx-br*0.82,by,bx,by-br*1.45);
      rlf.addColorStop(0,'#b05838');rlf.addColorStop(1,'#d87050');
      c.fillStyle=rlf;c.beginPath();c.moveTo(bx,by-br*1.45);c.lineTo(bx-br*0.82,by+br*0.5);c.lineTo(bx,by+br*0.12);c.closePath();c.fill();
      // Lava glow at peak
      c.fillStyle='rgba(255,140,40,0.55)';c.beginPath();c.arc(bx,by-br*1.45,br*0.14,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(255,200,80,0.3)';c.beginPath();c.arc(bx,by-br*1.45,br*0.06,0,Math.PI*2);c.fill();
      c.globalAlpha=1;
    });
  } else if(type===T.R_ICE){
    // Martian polar ice
    const g=c.createRadialGradient(mx-r*0.2,my-r*0.3,0,mx+r*0.1,my+r*0.1,r*1.1);
    g.addColorStop(0,'#ece8f8');g.addColorStop(0.4,'#c0b8e0');g.addColorStop(0.8,'#8880b8');g.addColorStop(1,'#5850a0');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Pink-tinted ice striations (CO2 ice)
    c.strokeStyle='rgba(200,180,255,0.22)';c.lineWidth=1.2;
    for(let i=0;i<5;i++){const wy=my-r*0.38+i*r*0.18;c.beginPath();c.moveTo(mx-r*0.72,wy);c.lineTo(mx+r*0.72,wy+Math.sin(i)*4);c.stroke();}
    c.fillStyle='rgba(255,240,255,0.12)';c.fillRect(0,0,TC_S,TC_S);
    // Surface gloss
    c.fillStyle='rgba(255,255,255,0.2)';c.beginPath();c.ellipse(mx-r*0.2,my-r*0.32,r*0.42,r*0.18,-0.4,0,Math.PI*2);c.fill();
  } else if(type===T.R_PLAIN){
    // Martian lowland
    const g=c.createLinearGradient(mx-r*0.3,my-r*0.8,mx+r*0.2,my+r*0.6);
    g.addColorStop(0,'#c85838');g.addColorStop(0.4,'#a84030');g.addColorStop(0.8,'#882e22');g.addColorStop(1,'#6a2018');
    c.fillStyle=g;c.fillRect(0,0,TC_S,TC_S);
    // Surface detail ‚Äî regolith pebbles
    for(let i=0;i<12;i++){
      const ax=mx-r*0.7+Math.abs(Math.sin(i*2.3))*r*1.4,ay=my-r*0.6+Math.abs(Math.cos(i*1.7))*r*1.2;
      c.fillStyle=`rgba(${140+i*5|0},${45+i*2|0},${18+i*2|0},0.45)`;
      c.beginPath();c.arc(ax,ay,1.2+Math.abs(Math.sin(i))*2,0,Math.PI*2);c.fill();
    }
    c.fillStyle='rgba(200,110,65,0.12)';c.beginPath();c.ellipse(mx,my+r*0.18,r*0.62,r*0.22,0.2,0,Math.PI*2);c.fill();
    // Atmospheric haze hint
    c.fillStyle='rgba(220,140,90,0.07)';c.beginPath();c.ellipse(mx-r*0.2,my-r*0.42,r*0.5,r*0.22,-0.3,0,Math.PI*2);c.fill();
  }
}


function drawAnimOverlay(ctx2,sx,sy,type,t){
  ctx2.save();hPath(ctx2,sx,sy,HS);ctx2.clip();
  if(type===T.OCEAN){
    for(let i=0;i<4;i++){const phase=t+i*1.2,wy=sy-HS*0.35+i*HS*0.2+Math.sin(t*0.6+i)*2.5;ctx2.strokeStyle=`rgba(180,228,255,${0.1+0.06*Math.sin(t*1.5+i)})`;ctx2.lineWidth=1.2;ctx2.beginPath();ctx2.moveTo(sx-HS*0.7,wy);ctx2.bezierCurveTo(sx-HS*0.25,wy-3*Math.sin(phase),sx+HS*0.25,wy+3*Math.sin(phase+1.6),sx+HS*0.7,wy);ctx2.stroke();}
    const sp=Math.sin(t*2.5)*0.5+0.5;ctx2.fillStyle=`rgba(230,250,255,${0.4*sp})`;ctx2.beginPath();ctx2.arc(sx+HS*0.18*Math.cos(t*1.1),sy-HS*0.08,2.2,0,Math.PI*2);ctx2.fill();
  } else if(type===T.FOREST){
    const sway=Math.sin(t*1.1)*2.2;ctx2.fillStyle=`rgba(160,240,100,${0.05+0.04*Math.sin(t*0.9)})`;ctx2.beginPath();ctx2.ellipse(sx+sway,sy-HS*0.38,HS*0.55,HS*0.22,0,0,Math.PI*2);ctx2.fill();
  } else if(type===T.SNOW||type===T.M_ICE||type===T.R_ICE){
    for(let i=0;i<5;i++){const fx=sx-HS*0.55+(i*HS*0.28)+((t*(6+i*2.5)+i*41)%(HS*1.1))-HS*0.1,fy=sy-HS*0.55+((t*(5+i)+i*19)%(HS*1.1));ctx2.fillStyle=`rgba(240,248,255,${0.38+0.2*Math.sin(t*1.5+i)})`;ctx2.beginPath();ctx2.arc(fx,fy,0.9+Math.sin(t+i)*0.45,0,Math.PI*2);ctx2.fill();}
  } else if(type===T.WETLAND){
    for(let i=0;i<2;i++){const phase=(t*0.8+i*1.6)%(Math.PI*2),rad=HS*0.12+HS*0.18*(phase/(Math.PI*2));ctx2.strokeStyle=`rgba(120,220,200,${0.28*(1-phase/(Math.PI*2))})`;ctx2.lineWidth=1;ctx2.beginPath();ctx2.arc(sx-HS*0.14,sy+HS*0.08,rad,0,Math.PI*2);ctx2.stroke();}
  } else if(type===T.M_LAVA||type===T.R_MOUN){
    const glow=0.1+0.09*Math.sin(t*1.8);const gp=ctx2.createRadialGradient(sx,sy-HS*0.4,0,sx,sy-HS*0.4,HS*0.28);gp.addColorStop(0,`rgba(255,160,40,${glow})`);gp.addColorStop(1,'rgba(255,100,20,0)');ctx2.fillStyle=gp;ctx2.beginPath();ctx2.arc(sx,sy-HS*0.4,HS*0.28,0,Math.PI*2);ctx2.fill();
  } else if(type===T.R_DESERT||type===T.R_PLAIN){
    ctx2.fillStyle=`rgba(220,100,50,${0.022+0.014*Math.sin(t*1.8)})`;ctx2.fillRect(sx-HS,sy-HS,HS*2,HS*2);
  }
  ctx2.restore();
}

function getFac(owner){if(owner==='player')return playerFaction;const ai=G.aiPlayers&&G.aiPlayers.find(a=>a.id===owner);return ai?ai.faction:Object.values(FACTIONS)[0];}
function rRect(c2,x,y,w,h,rad){c2.beginPath();c2.moveTo(x+rad,y);c2.lineTo(x+w-rad,y);c2.quadraticCurveTo(x+w,y,x+w,y+rad);c2.lineTo(x+w,y+h-rad);c2.quadraticCurveTo(x+w,y+h,x+w-rad,y+h);c2.lineTo(x+rad,y+h);c2.quadraticCurveTo(x,y+h,x,y+h-rad);c2.lineTo(x,y+rad);c2.quadraticCurveTo(x,y,x+rad,y);c2.closePath();}

// ‚îÄ‚îÄ UNIT ICON ART ‚îÄ‚îÄ
// Each unit gets a hand-drawn canvas icon ‚Äî scale s, centred on cx,cy
// col = main colour, lit = highlight colour
function drawUnitIcon(c,type,cx,cy,s,col,lit){
  c.save();
  c.strokeStyle=lit;c.fillStyle=col;c.lineWidth=s*0.12;c.lineCap='round';c.lineJoin='round';
  const q=(n)=>n*s; // scale helper
  switch(type){
    case'WARRIOR':{
      // Sword + shield silhouette
      // Shield
      c.fillStyle=lit+'cc';c.beginPath();c.moveTo(cx-q(0.55),cy-q(0.6));c.lineTo(cx+q(0.05),cy-q(0.6));c.lineTo(cx+q(0.05),cy+q(0.2));c.quadraticCurveTo(cx+q(0.05),cy+q(0.7),cx-q(0.25),cy+q(0.85));c.quadraticCurveTo(cx-q(0.55),cy+q(0.7),cx-q(0.55),cy+q(0.2));c.closePath();c.fill();
      c.strokeStyle=lit;c.lineWidth=s*0.09;c.stroke();
      // Sword blade
      c.strokeStyle=lit;c.lineWidth=s*0.14;c.beginPath();c.moveTo(cx+q(0.55),cy-q(0.75));c.lineTo(cx+q(0.15),cy+q(0.65));c.stroke();
      // Crossguard
      c.lineWidth=s*0.12;c.beginPath();c.moveTo(cx+q(0.0),cy-q(0.02));c.lineTo(cx+q(0.7),cy+q(0.08));c.stroke();
      break;}
    case'ARCHER':{
      // Bow + arrow
      c.strokeStyle=lit;c.lineWidth=s*0.12;
      c.beginPath();c.arc(cx-q(0.1),cy,q(0.75),Math.PI*0.25,Math.PI*1.75);c.stroke();
      // Bowstring
      c.lineWidth=s*0.07;c.beginPath();c.moveTo(cx-q(0.1)+q(0.75)*Math.cos(Math.PI*0.25),cy+q(0.75)*Math.sin(Math.PI*0.25));c.lineTo(cx-q(0.1)+q(0.75)*Math.cos(Math.PI*1.75),cy+q(0.75)*Math.sin(Math.PI*1.75));c.stroke();
      // Arrow
      c.strokeStyle=col;c.lineWidth=s*0.1;c.beginPath();c.moveTo(cx-q(0.3),cy);c.lineTo(cx+q(0.75),cy);c.stroke();
      // Arrowhead
      c.fillStyle=lit;c.beginPath();c.moveTo(cx+q(0.75),cy);c.lineTo(cx+q(0.45),cy-q(0.22));c.lineTo(cx+q(0.45),cy+q(0.22));c.closePath();c.fill();
      break;}
    case'KNIGHT':{
      // Mounted knight ‚Äî horse head + lance
      // Horse body
      c.fillStyle=col+'dd';c.beginPath();c.ellipse(cx-q(0.12),cy+q(0.28),q(0.55),q(0.35),0.2,0,Math.PI*2);c.fill();
      // Horse neck
      c.fillStyle=col+'dd';c.beginPath();c.moveTo(cx-q(0.1),cy-q(0.05));c.lineTo(cx+q(0.15),cy-q(0.45));c.lineTo(cx+q(0.35),cy-q(0.3));c.lineTo(cx+q(0.1),cy+q(0.1));c.closePath();c.fill();
      // Horse head
      c.beginPath();c.ellipse(cx+q(0.28),cy-q(0.55),q(0.22),q(0.18),0.4,0,Math.PI*2);c.fill();
      // Lance
      c.strokeStyle=lit;c.lineWidth=s*0.1;c.beginPath();c.moveTo(cx-q(0.65),cy-q(0.55));c.lineTo(cx+q(0.55),cy+q(0.35));c.stroke();
      // Lance tip
      c.fillStyle=lit;c.beginPath();c.moveTo(cx-q(0.65),cy-q(0.55));c.lineTo(cx-q(0.42),cy-q(0.75));c.lineTo(cx-q(0.38),cy-q(0.35));c.closePath();c.fill();
      break;}
    case'CATAPULT':{
      // Catapult arm + bowl
      // Base
      c.fillStyle=col+'cc';c.beginPath();c.rect(cx-q(0.7),cy+q(0.3),q(1.4),q(0.4));c.fill();
      // Wheels
      [cx-q(0.5),cx+q(0.5)].forEach(wx=>{c.beginPath();c.arc(wx,cy+q(0.7),q(0.2),0,Math.PI*2);c.fillStyle='#7a5020';c.fill();c.strokeStyle=lit+'88';c.lineWidth=s*0.08;c.stroke();});
      // Arm
      c.strokeStyle=lit;c.lineWidth=s*0.18;c.beginPath();c.moveTo(cx-q(0.1),cy+q(0.28));c.lineTo(cx+q(0.2),cy-q(0.75));c.stroke();
      // Bowl/sling
      c.fillStyle=col+'cc';c.beginPath();c.arc(cx+q(0.28),cy-q(0.78),q(0.22),0,Math.PI*2);c.fill();
      // Projectile
      c.fillStyle=lit;c.beginPath();c.arc(cx+q(0.28),cy-q(0.78),q(0.12),0,Math.PI*2);c.fill();
      break;}
    case'RIFLEMAN':{
      // Soldier with rifle
      // Body
      c.fillStyle=col+'cc';c.beginPath();c.ellipse(cx,cy+q(0.15),q(0.28),q(0.45),0,0,Math.PI*2);c.fill();
      // Head + helmet
      c.fillStyle=lit+'cc';c.beginPath();c.arc(cx,cy-q(0.45),q(0.22),0,Math.PI*2);c.fill();
      c.fillStyle=col;c.beginPath();c.ellipse(cx,cy-q(0.58),q(0.28),q(0.1),0,0,Math.PI*2);c.fill();
      // Rifle
      c.strokeStyle=lit;c.lineWidth=s*0.12;c.beginPath();c.moveTo(cx-q(0.55),cy-q(0.15));c.lineTo(cx+q(0.7),cy-q(0.28));c.stroke();
      // Barrel
      c.lineWidth=s*0.08;c.beginPath();c.moveTo(cx+q(0.5),cy-q(0.3));c.lineTo(cx+q(0.85),cy-q(0.36));c.stroke();
      break;}
    case'ARTILLERY':{
      // Big gun on wheels
      // Carriage
      c.fillStyle=col+'cc';c.beginPath();c.rect(cx-q(0.6),cy+q(0.05),q(1.1),q(0.35));c.fill();
      // Wheels
      [cx-q(0.45),cx+q(0.45)].forEach(wx=>{c.beginPath();c.arc(wx,cy+q(0.4),q(0.24),0,Math.PI*2);c.fillStyle='#5a3a18';c.fill();c.strokeStyle=lit+'aa';c.lineWidth=s*0.1;c.stroke();});
      // Barrel ‚Äî angled up-right
      c.strokeStyle=lit;c.lineWidth=s*0.28;c.lineCap='butt';c.beginPath();c.moveTo(cx-q(0.2),cy+q(0.02));c.lineTo(cx+q(0.82),cy-q(0.45));c.stroke();
      c.lineCap='round';
      // Muzzle flash hint
      c.fillStyle=lit+'66';c.beginPath();c.arc(cx+q(0.82),cy-q(0.45),q(0.12),0,Math.PI*2);c.fill();
      break;}
    case'ENGINEER':{
      // Gear + wrench
      // Gear
      const gr=q(0.42);c.strokeStyle=lit+'cc';c.lineWidth=s*0.22;c.beginPath();c.arc(cx-q(0.12),cy+q(0.1),gr,0,Math.PI*2);c.stroke();
      c.fillStyle=col+'cc';c.beginPath();c.arc(cx-q(0.12),cy+q(0.1),gr*0.55,0,Math.PI*2);c.fill();
      // Teeth
      for(let i=0;i<8;i++){const a=i*Math.PI/4;c.fillStyle=lit+'cc';c.beginPath();c.rect(cx-q(0.12)+Math.cos(a)*gr-q(0.07),cy+q(0.1)+Math.sin(a)*gr-q(0.07),q(0.14),q(0.14));c.fill();}
      // Wrench
      c.strokeStyle=lit;c.lineWidth=s*0.12;c.beginPath();c.moveTo(cx+q(0.25),cy-q(0.6));c.lineTo(cx+q(0.55),cy+q(0.3));c.stroke();
      break;}
    case'TANK':{
      // Tank with turret
      // Hull
      const tg=c.createLinearGradient(cx-q(0.7),cy,cx+q(0.7),cy);
      tg.addColorStop(0,lit+'bb');tg.addColorStop(0.5,col+'cc');tg.addColorStop(1,col+'77');
      c.fillStyle=tg;rRect(c,cx-q(0.7),cy-q(0.05),q(1.4),q(0.52),q(0.1));c.fill();
      // Tracks
      c.fillStyle='rgba(0,0,0,0.4)';rRect(c,cx-q(0.72),cy+q(0.35),q(1.44),q(0.26),q(0.1));c.fill();
      c.strokeStyle=lit+'44';c.lineWidth=s*0.07;rRect(c,cx-q(0.72),cy+q(0.35),q(1.44),q(0.26),q(0.1));c.stroke();
      // Turret dome
      c.fillStyle=lit+'cc';c.beginPath();c.arc(cx+q(0.05),cy-q(0.05),q(0.3),0,Math.PI*2);c.fill();
      c.strokeStyle=col;c.lineWidth=s*0.08;c.stroke();
      // Barrel
      c.strokeStyle=lit;c.lineWidth=s*0.16;c.lineCap='butt';c.beginPath();c.moveTo(cx+q(0.15),cy-q(0.08));c.lineTo(cx+q(0.82),cy-q(0.12));c.stroke();c.lineCap='round';
      break;}
    case'JET':{
      // Jet fighter from above/side
      // Fuselage
      c.fillStyle=lit+'cc';c.beginPath();c.moveTo(cx+q(0.85),cy);c.quadraticCurveTo(cx+q(0.4),cy-q(0.12),cx-q(0.7),cy-q(0.08));c.quadraticCurveTo(cx+q(0.4),cy+q(0.12),cx+q(0.85),cy);c.fill();
      // Wings
      c.fillStyle=col+'dd';c.beginPath();c.moveTo(cx+q(0.1),cy-q(0.08));c.lineTo(cx-q(0.6),cy-q(0.72));c.lineTo(cx-q(0.65),cy-q(0.1));c.closePath();c.fill();
      c.beginPath();c.moveTo(cx+q(0.1),cy+q(0.08));c.lineTo(cx-q(0.6),cy+q(0.72));c.lineTo(cx-q(0.65),cy+q(0.1));c.closePath();c.fill();
      // Tail fins
      c.fillStyle=col+'bb';c.beginPath();c.moveTo(cx-q(0.5),cy-q(0.08));c.lineTo(cx-q(0.8),cy-q(0.4));c.lineTo(cx-q(0.82),cy-q(0.1));c.closePath();c.fill();
      c.beginPath();c.moveTo(cx-q(0.5),cy+q(0.08));c.lineTo(cx-q(0.8),cy+q(0.4));c.lineTo(cx-q(0.82),cy+q(0.1));c.closePath();c.fill();
      // Cockpit
      c.fillStyle='rgba(100,200,255,0.6)';c.beginPath();c.ellipse(cx+q(0.5),cy,q(0.18),q(0.09),0,0,Math.PI*2);c.fill();
      break;}
    case'PSYCHIC':{
      // Eye + psychic rings
      // Outer ring
      c.strokeStyle=lit+'88';c.lineWidth=s*0.1;c.beginPath();c.arc(cx,cy,q(0.8),0,Math.PI*2);c.stroke();
      // Middle ring
      c.strokeStyle=lit+'bb';c.lineWidth=s*0.1;c.beginPath();c.arc(cx,cy,q(0.52),0,Math.PI*2);c.stroke();
      // Eye sclera
      c.fillStyle='rgba(255,255,255,0.9)';c.beginPath();c.ellipse(cx,cy,q(0.3),q(0.22),0,0,Math.PI*2);c.fill();
      // Iris
      c.fillStyle=lit;c.beginPath();c.arc(cx,cy,q(0.16),0,Math.PI*2);c.fill();
      // Pupil
      c.fillStyle='rgba(0,0,0,0.8)';c.beginPath();c.arc(cx,cy,q(0.08),0,Math.PI*2);c.fill();
      // Inner glow
      c.fillStyle=lit+'44';c.beginPath();c.arc(cx,cy,q(0.32),0,Math.PI*2);c.fill();
      break;}
    case'ASTRONAUT':{
      // Space suit helmet + body
      // Body/suit
      c.fillStyle=col+'cc';c.beginPath();c.ellipse(cx,cy+q(0.28),q(0.36),q(0.42),0,0,Math.PI*2);c.fill();
      // Helmet dome
      c.fillStyle=lit+'cc';c.beginPath();c.arc(cx,cy-q(0.3),q(0.38),0,Math.PI*2);c.fill();
      // Visor
      c.fillStyle='rgba(80,180,255,0.65)';c.beginPath();c.ellipse(cx,cy-q(0.28),q(0.26),q(0.2),0,0,Math.PI*2);c.fill();
      // Visor glint
      c.fillStyle='rgba(255,255,255,0.4)';c.beginPath();c.ellipse(cx-q(0.1),cy-q(0.34),q(0.1),q(0.06),-0.5,0,Math.PI*2);c.fill();
      // Pack
      c.fillStyle=col+'aa';rRect(c,cx-q(0.18),cy+q(0.05),q(0.36),q(0.28),q(0.05));c.fill();
      break;}
    case'LASER_TRP':{
      // Soldier with laser rifle
      // Body
      c.fillStyle=col+'cc';c.beginPath();c.ellipse(cx,cy+q(0.15),q(0.26),q(0.42),0,0,Math.PI*2);c.fill();
      // Helmet ‚Äî angular
      c.fillStyle=lit+'cc';c.beginPath();c.moveTo(cx-q(0.24),cy-q(0.3));c.lineTo(cx+q(0.24),cy-q(0.3));c.lineTo(cx+q(0.2),cy-q(0.65));c.lineTo(cx,cy-q(0.72));c.lineTo(cx-q(0.2),cy-q(0.65));c.closePath();c.fill();
      // Visor slit
      c.fillStyle='rgba(255,50,50,0.75)';c.beginPath();c.rect(cx-q(0.16),cy-q(0.5),q(0.32),q(0.09));c.fill();
      // Laser rifle ‚Äî horizontal
      c.strokeStyle=lit;c.lineWidth=s*0.14;c.beginPath();c.moveTo(cx-q(0.5),cy-q(0.08));c.lineTo(cx+q(0.72),cy-q(0.08));c.stroke();
      // Muzzle glow
      c.fillStyle='rgba(255,80,80,0.8)';c.beginPath();c.arc(cx+q(0.72),cy-q(0.08),q(0.1),0,Math.PI*2);c.fill();
      break;}
    case'AI_ROBOT':{
      // Angular robot
      // Torso
      const rg=c.createLinearGradient(cx-q(0.4),cy,cx+q(0.4),cy+q(0.5));
      rg.addColorStop(0,lit+'dd');rg.addColorStop(1,col+'aa');
      c.fillStyle=rg;rRect(c,cx-q(0.38),cy-q(0.15),q(0.76),q(0.58),q(0.08));c.fill();
      // Head
      rRect(c,cx-q(0.28),cy-q(0.72),q(0.56),q(0.52),q(0.08));c.fill();
      c.strokeStyle=lit;c.lineWidth=s*0.08;rRect(c,cx-q(0.28),cy-q(0.72),q(0.56),q(0.52),q(0.08));c.stroke();
      // Eyes ‚Äî glowing
      [[cx-q(0.12),cy-q(0.5)],[cx+q(0.12),cy-q(0.5)]].forEach(([ex,ey])=>{
        c.fillStyle=lit;c.beginPath();c.arc(ex,ey,q(0.1),0,Math.PI*2);c.fill();
        c.fillStyle='rgba(255,255,255,0.7)';c.beginPath();c.arc(ex,ey,q(0.05),0,Math.PI*2);c.fill();
      });
      // Antenna
      c.strokeStyle=lit;c.lineWidth=s*0.08;c.beginPath();c.moveTo(cx,cy-q(0.72));c.lineTo(cx,cy-q(0.95));c.stroke();
      c.fillStyle=lit;c.beginPath();c.arc(cx,cy-q(0.95),q(0.07),0,Math.PI*2);c.fill();
      break;}
    case'COLONY_VEH':{
      // Flying saucer
      // Saucer body
      const sg=c.createRadialGradient(cx,cy-q(0.1),0,cx,cy,q(0.8));
      sg.addColorStop(0,lit+'cc');sg.addColorStop(0.5,col+'cc');sg.addColorStop(1,col+'44');
      c.fillStyle=sg;c.beginPath();c.ellipse(cx,cy+q(0.1),q(0.75),q(0.28),0,0,Math.PI*2);c.fill();
      // Dome
      c.fillStyle=lit+'bb';c.beginPath();c.ellipse(cx,cy-q(0.08),q(0.38),q(0.32),0,Math.PI,0);c.closePath();c.fill();
      // Dome glass
      c.fillStyle='rgba(100,220,255,0.35)';c.beginPath();c.ellipse(cx,cy-q(0.08),q(0.38),q(0.32),0,Math.PI,0);c.closePath();c.fill();
      // Lights
      for(let i=0;i<5;i++){const a=i*Math.PI*2/5;c.fillStyle=i%2===0?'rgba(255,200,50,0.9)':'rgba(255,100,100,0.9)';c.beginPath();c.arc(cx+Math.cos(a)*q(0.6),cy+q(0.1)+Math.sin(a)*q(0.15),q(0.08),0,Math.PI*2);c.fill();}
      break;}
    case'EXODUS_SHIP':{
      // Majestic interstellar ark ‚Äî multiple sections
      // Main hull
      const eg=c.createLinearGradient(cx-q(0.85),cy,cx+q(0.85),cy);
      eg.addColorStop(0,col+'aa');eg.addColorStop(0.4,lit+'ee');eg.addColorStop(1,col+'88');
      c.fillStyle=eg;c.beginPath();c.moveTo(cx-q(0.85),cy);c.lineTo(cx-q(0.6),cy-q(0.22));c.lineTo(cx+q(0.6),cy-q(0.22));c.lineTo(cx+q(0.85),cy);c.lineTo(cx+q(0.6),cy+q(0.22));c.lineTo(cx-q(0.6),cy+q(0.22));c.closePath();c.fill();
      // Engines
      [cy-q(0.38),cy+q(0.38)].forEach(ey=>{
        c.fillStyle=col+'cc';c.beginPath();c.ellipse(cx-q(0.5),ey,q(0.28),q(0.12),0,0,Math.PI*2);c.fill();
        const eg2=c.createRadialGradient(cx-q(0.7),ey,0,cx-q(0.7),ey,q(0.22));
        eg2.addColorStop(0,'rgba(100,200,255,0.9)');eg2.addColorStop(1,'rgba(0,100,255,0)');
        c.fillStyle=eg2;c.beginPath();c.arc(cx-q(0.7),ey,q(0.22),0,Math.PI*2);c.fill();
      });
      // Bridge dome
      c.fillStyle=lit+'dd';c.beginPath();c.ellipse(cx+q(0.35),cy,q(0.22),q(0.18),0,0,Math.PI*2);c.fill();
      // Glow aura
      c.fillStyle='rgba(100,180,255,0.12)';c.beginPath();c.arc(cx,cy,q(1.0),0,Math.PI*2);c.fill();
      break;}
    case'LEVIATHAN':{
      // Ancient whale-kraken hybrid
      // Main body
      const lg2=c.createRadialGradient(cx-q(0.2),cy-q(0.2),0,cx,cy,q(0.9));
      lg2.addColorStop(0,lit+'cc');lg2.addColorStop(0.5,col+'cc');lg2.addColorStop(1,col+'55');
      c.fillStyle=lg2;c.beginPath();c.ellipse(cx,cy,q(0.72),q(0.48),0,0,Math.PI*2);c.fill();
      // Tentacles
      [[-0.7,0.5,-0.9,0.85],[-0.5,0.65,-0.55,1.0],[0.55,0.6,0.7,0.95],[0.75,0.45,0.95,0.8]].forEach(([x1,y1,x2,y2])=>{
        c.strokeStyle=col+'cc';c.lineWidth=s*0.15;c.beginPath();c.moveTo(cx+q(x1*0.7),cy+q(y1*0.6));c.quadraticCurveTo(cx+q(x1),cy+q(y1),cx+q(x2),cy+q(y2));c.stroke();
      });
      // Eye
      c.fillStyle='rgba(255,255,255,0.9)';c.beginPath();c.arc(cx+q(0.28),cy-q(0.12),q(0.16),0,Math.PI*2);c.fill();
      c.fillStyle=lit;c.beginPath();c.arc(cx+q(0.3),cy-q(0.1),q(0.09),0,Math.PI*2);c.fill();
      // Crown-like spines
      [[0,-0.85],[-.35,-0.75],[.35,-0.75]].forEach(([ox,oy])=>{
        c.fillStyle=lit+'cc';c.beginPath();c.moveTo(cx+q(ox-0.07),cy+q(0));c.lineTo(cx+q(ox),cy+q(oy));c.lineTo(cx+q(ox+0.07),cy+q(0));c.closePath();c.fill();
      });
      break;}
    default:{
      // Fallback ‚Äî simple cross
      c.strokeStyle=lit;c.lineWidth=s*0.2;c.beginPath();c.moveTo(cx-q(0.6),cy);c.lineTo(cx+q(0.6),cy);c.moveTo(cx,cy-q(0.6));c.lineTo(cx,cy+q(0.6));c.stroke();
    }
  }
  c.restore();
}

// Era badge shapes ‚Äî path only (caller fills/strokes)
function unitBadgePath(c,ux,uy,sz,era){
  const e=era||'MEDIEVAL';
  if(e==='MEDIEVAL'){
    // Shield shape
    c.beginPath();
    c.moveTo(ux,uy-sz);c.lineTo(ux+sz*0.82,uy-sz*0.6);c.lineTo(ux+sz*0.82,uy+sz*0.1);
    c.quadraticCurveTo(ux+sz*0.82,uy+sz*0.6,ux,uy+sz);
    c.quadraticCurveTo(ux-sz*0.82,uy+sz*0.6,ux-sz*0.82,uy+sz*0.1);
    c.lineTo(ux-sz*0.82,uy-sz*0.6);c.closePath();
  } else if(e==='INDUSTRIAL'){
    // Rounded square / octagon
    const r2=sz*0.25;
    c.beginPath();
    c.moveTo(ux-sz*0.72+r2,uy-sz);c.lineTo(ux+sz*0.72-r2,uy-sz);c.arcTo(ux+sz*0.72,uy-sz,ux+sz*0.72,uy-sz+r2,r2);
    c.lineTo(ux+sz*0.72,uy+sz*0.6-r2);c.arcTo(ux+sz*0.72,uy+sz*0.6,ux+sz*0.72-r2,uy+sz*0.6,r2);
    c.lineTo(ux-sz*0.72+r2,uy+sz*0.6);c.arcTo(ux-sz*0.72,uy+sz*0.6,ux-sz*0.72,uy+sz*0.6-r2,r2);
    c.lineTo(ux-sz*0.72,uy-sz+r2);c.arcTo(ux-sz*0.72,uy-sz,ux-sz*0.72+r2,uy-sz,r2);
    c.closePath();
  } else if(e==='ATOMIC'){
    // Diamond
    c.beginPath();
    c.moveTo(ux,uy-sz);c.lineTo(ux+sz*0.82,uy);c.lineTo(ux,uy+sz);c.lineTo(ux-sz*0.82,uy);c.closePath();
  } else {
    // Hexagon for Space+
    hPath(c,ux,uy,sz);
  }
}


// ‚îÄ‚îÄ DRAWING ‚îÄ‚îÄ
function drawCity(c2,sx,sy,city){
  const fac=getFac(city.owner);
  const era=G&&G.era?G.era:'MEDIEVAL';
  const isFuture=era==='SPACE'||era==='INTERSTELLAR';
  const isGrowing=era==='ATOMIC'||era==='INDUSTRIAL';
  const r=HS;
  const lv=city.lv||1;

  // Drop shadow (offset down-right for 3D depth)
  c2.fillStyle='rgba(0,0,0,0.32)';c2.beginPath();c2.ellipse(sx+3,sy+r*0.52,r*0.52,r*0.14,0,0,Math.PI*2);c2.fill();

  if(isFuture){
    const scale=0.58+lv*0.06;
    // Glow halo
    const halo=c2.createRadialGradient(sx,sy-r*0.1,0,sx,sy-r*0.05,r*(scale+0.3)*lv*0.45);
    halo.addColorStop(0,fac.cityLight+(lv>2?'30':'18'));halo.addColorStop(1,'transparent');
    c2.fillStyle=halo;c2.beginPath();c2.arc(sx,sy-r*0.05,r*(scale+0.3)*lv*0.45,0,Math.PI*2);c2.fill();
    // Dome shadow underside
    c2.fillStyle='rgba(0,0,0,0.28)';c2.beginPath();c2.ellipse(sx+2,sy-r*0.03,r*scale*0.85,r*0.12,0,0,Math.PI*2);c2.fill();
    // Dome body
    const dg=c2.createRadialGradient(sx-r*scale*0.3,sy-r*0.25,0,sx,sy-r*0.05,r*scale*1.4);
    dg.addColorStop(0,fac.cityLight+'70');dg.addColorStop(0.4,fac.cityColor+'cc');dg.addColorStop(1,fac.cityColor+'28');
    c2.fillStyle=dg;c2.beginPath();c2.arc(sx,sy-r*0.05,r*scale,Math.PI,0);c2.closePath();c2.fill();
    // Dome highlight (specular)
    const spec=c2.createRadialGradient(sx-r*scale*0.35,sy-r*0.2,0,sx-r*scale*0.2,sy-r*0.12,r*scale*0.65);
    spec.addColorStop(0,'rgba(255,255,255,0.22)');spec.addColorStop(1,'rgba(255,255,255,0)');
    c2.fillStyle=spec;c2.beginPath();c2.arc(sx,sy-r*0.05,r*scale,Math.PI,0);c2.closePath();c2.fill();
    // Dome rim
    c2.strokeStyle=fac.cityLight;c2.lineWidth=1.8+lv*0.2;c2.beginPath();c2.arc(sx,sy-r*0.05,r*scale,Math.PI,0);c2.closePath();c2.stroke();
    // Internal structure lines
    c2.strokeStyle=fac.cityColor+'70';c2.lineWidth=0.8;
    for(let i=1;i<=lv+1;i++){const xp=sx-r*scale+i*r*scale*2/(lv+2);const yp=sy-r*0.05-Math.sqrt(Math.max(0,r*scale*r*scale-(xp-sx)*(xp-sx)));c2.beginPath();c2.moveTo(sx-r*scale,sy-r*0.05);c2.lineTo(xp,yp);c2.stroke();}
    // Base platform with bevel
    const platG=c2.createLinearGradient(sx,sy-r*0.1,sx,sy+r*0.12);
    platG.addColorStop(0,fac.cityColor+'cc');platG.addColorStop(1,fac.cityColor+'55');
    c2.fillStyle=platG;rRect(c2,sx-r*(scale+0.04),sy-r*0.05,r*(scale+0.04)*2,r*0.16,3);c2.fill();
    c2.strokeStyle=fac.cityLight+'50';c2.lineWidth=1;rRect(c2,sx-r*(scale+0.04),sy-r*0.05,r*(scale+0.04)*2,r*0.16,3);c2.stroke();
    // Antennae
    for(let i=0;i<Math.min(lv,3);i++){
      const ox=(i-Math.floor(lv/2))*r*0.18;
      c2.strokeStyle='#9a8a60';c2.lineWidth=1.5;c2.beginPath();c2.moveTo(sx+ox,sy-r*0.05-r*scale*0.9);c2.lineTo(sx+ox,sy-r*0.05-r*scale*1.3);c2.stroke();
      const ag=c2.createRadialGradient(sx+ox,sy-r*0.05-r*scale*1.3,0,sx+ox,sy-r*0.05-r*scale*1.3,3+i*0.5);
      ag.addColorStop(0,fac.light);ag.addColorStop(1,'transparent');
      c2.fillStyle=ag;c2.beginPath();c2.arc(sx+ox,sy-r*0.05-r*scale*1.3,3.5+i*0.5,0,Math.PI*2);c2.fill();
    }
  } else if(isGrowing){
    const bw=r*(0.7+lv*0.08),bh=r*(0.28+lv*0.06),by=sy+r*0.22;
    // Building shadow face (right/bottom)
    const rg=c2.createLinearGradient(sx+bw*0.3,by,sx+bw*0.5,by+bh);
    rg.addColorStop(0,'rgba(0,0,0,0.25)');rg.addColorStop(1,'rgba(0,0,0,0.45)');
    c2.fillStyle=rg;rRect(c2,sx+bw*0.08,by+2,bw*0.45,bh,2);c2.fill();
    // Main building ‚Äî lit left face
    const lg=c2.createLinearGradient(sx-bw/2,by,sx+bw/2,by);
    lg.addColorStop(0,fac.cityLight+'cc');lg.addColorStop(0.45,fac.cityColor+'dd');lg.addColorStop(1,fac.cityColor+'88');
    c2.fillStyle=lg;rRect(c2,sx-bw/2,by,bw,bh,3);c2.fill();
    c2.strokeStyle=fac.cityLight+'45';c2.lineWidth=1;rRect(c2,sx-bw/2,by,bw,bh,3);c2.stroke();
    const nChim=Math.min(lv+1,4);
    for(let i=0;i<nChim;i++){
      const cx2=sx-bw*0.38+i*(bw*0.76/(Math.max(nChim-1,1)));
      const ch=r*(0.28+i*0.04+lv*0.02);
      // Chimney shadow
      c2.fillStyle='rgba(0,0,0,0.3)';rRect(c2,cx2-r*0.04+2,by-ch+2,r*0.1,ch,2);c2.fill();
      // Chimney lit
      const cg=c2.createLinearGradient(cx2-r*0.07,0,cx2+r*0.07,0);
      cg.addColorStop(0,fac.cityLight+'aa');cg.addColorStop(1,fac.cityColor+'99');
      c2.fillStyle=cg;rRect(c2,cx2-r*0.07,by-ch,r*0.14,ch,2);c2.fill();
      c2.strokeStyle=fac.cityLight+'30';c2.lineWidth=0.8;rRect(c2,cx2-r*0.07,by-ch,r*0.14,ch,2);c2.stroke();
      // Smoke puff
      c2.fillStyle='rgba(200,200,200,0.18)';c2.beginPath();c2.arc(cx2,by-ch-r*0.1,r*0.1,0,Math.PI*2);c2.fill();
    }
    // Windows ‚Äî glowing
    c2.fillStyle=fac.light+'88';
    for(let i=0;i<Math.min(lv*2,6);i++){
      const wx=sx-bw*0.36+i*(bw*0.72/(Math.max(lv*2-1,1)));
      const wg2=c2.createRadialGradient(wx,by+bh*0.35,0,wx,by+bh*0.35,3.5);
      wg2.addColorStop(0,fac.light+'ee');wg2.addColorStop(1,'transparent');
      c2.fillStyle=wg2;c2.fillRect(wx-2,by+bh*0.25,4,4);
    }
  } else {
    // MEDIEVAL ‚Äî castle
    const bw=r*(0.72+lv*0.06),bh=r*0.2,by=sy+r*0.24;
    const ww=bw*(0.6+lv*0.04),wh=r*(0.36+lv*0.06);

    if(lv>=3){
      // Outer wall shadow
      c2.fillStyle='rgba(0,0,0,0.2)';rRect(c2,sx-bw/2-r*0.14+2,by-r*0.1+2,bw+r*0.28,r*0.35,3);c2.fill();
      // Outer wall
      const owg=c2.createLinearGradient(sx-bw/2-r*0.14,0,sx+bw/2+r*0.14,0);
      owg.addColorStop(0,fac.cityLight+'60');owg.addColorStop(1,fac.cityColor+'40');
      c2.strokeStyle=fac.cityLight+'35';c2.lineWidth=2;
      rRect(c2,sx-bw/2-r*0.14,by-r*0.1,bw+r*0.28,r*0.35,3);c2.stroke();
    }

    // Foundation shadow
    c2.fillStyle='rgba(0,0,0,0.28)';rRect(c2,sx-bw/2+2,by+2,bw,bh,3);c2.fill();
    // Base
    const baseg=c2.createLinearGradient(sx-bw/2,by,sx+bw/2,by+bh);
    baseg.addColorStop(0,fac.cityLight+'aa');baseg.addColorStop(0.4,fac.cityColor+'cc');baseg.addColorStop(1,fac.cityColor+'66');
    c2.fillStyle=baseg;rRect(c2,sx-bw/2,by,bw,bh,3);c2.fill();

    // Keep shadow
    c2.fillStyle='rgba(0,0,0,0.22)';rRect(c2,sx-ww/2+2,by-wh+2,ww,wh+bh*0.5,2);c2.fill();
    // Keep ‚Äî lit left, shadow right
    const keepg=c2.createLinearGradient(sx-ww/2,0,sx+ww/2,0);
    keepg.addColorStop(0,fac.cityLight+'dd');keepg.addColorStop(0.5,fac.cityColor+'cc');keepg.addColorStop(1,fac.cityColor+'66');
    c2.fillStyle=keepg;rRect(c2,sx-ww/2,by-wh,ww,wh+bh*0.5,2);c2.fill();
    // Battlements
    const nBattl=3+lv;
    for(let i=0;i<nBattl;i++){
      if(i%2===0){
        c2.fillStyle='rgba(0,0,0,0.35)';rRect(c2,sx-ww/2+i*(ww/(nBattl-1))-3.5,by-wh-6,9,6,1);c2.fill();
        const bg=c2.createLinearGradient(sx-ww/2+i*(ww/(nBattl-1))-3.5,by-wh-6,sx-ww/2+i*(ww/(nBattl-1))+5.5,by-wh);
        bg.addColorStop(0,fac.cityLight+'cc');bg.addColorStop(1,fac.cityColor+'88');
        c2.fillStyle=bg;rRect(c2,sx-ww/2+i*(ww/(nBattl-1))-3.5,by-wh-6,9,6,1);c2.fill();
      }
    }
    c2.strokeStyle=fac.cityLight+'38';c2.lineWidth=1;rRect(c2,sx-ww/2,by-wh,ww,wh+bh*0.5,2);c2.stroke();

    // Towers at lv2+
    if(lv>=2){
      const tw=r*0.22,th=wh*0.82;
      [-1,1].forEach(side=>{
        // Tower shadow
        c2.fillStyle='rgba(0,0,0,0.22)';rRect(c2,sx+side*ww/2-tw*(side>0?0:1)+1,by-th+1,tw,th,2);c2.fill();
        // Tower body
        const tg=c2.createLinearGradient(sx+side*ww/2-tw*(side>0?0:1),0,sx+side*ww/2+tw*(side>0?1:0),0);
        if(side===-1){tg.addColorStop(0,fac.cityLight+'cc');tg.addColorStop(1,fac.cityColor+'88');}
        else{tg.addColorStop(0,fac.cityColor+'aa');tg.addColorStop(1,fac.cityColor+'55');}
        c2.fillStyle=tg;rRect(c2,sx+side*ww/2-tw*(side>0?0:1),by-th,tw,th,2);c2.fill();
        c2.strokeStyle=fac.cityLight+'30';c2.lineWidth=1;rRect(c2,sx+side*ww/2-tw*(side>0?0:1),by-th,tw,th,2);c2.stroke();
      });
    }

    // Flag pole + flag
    c2.strokeStyle='#9a8a60';c2.lineWidth=1.5;c2.beginPath();c2.moveTo(sx,by-wh-r*0.35+bh*0.5);c2.lineTo(sx,by-wh-r*0.58+bh*0.5);c2.stroke();
    c2.fillStyle=fac.color;c2.beginPath();c2.moveTo(sx,by-wh-r*0.58+bh*0.5);c2.lineTo(sx+r*0.22,by-wh-r*0.48+bh*0.5);c2.lineTo(sx,by-wh-r*0.38+bh*0.5);c2.closePath();c2.fill();
    c2.strokeStyle=fac.cityLight+'50';c2.lineWidth=0.8;c2.stroke();
    // Windows ‚Äî warm glow
    [[sx,by-wh+r*0.07],[sx-ww*0.22,by-wh*0.52],[sx+ww*0.22,by-wh*0.52]].forEach(([wx,wy2])=>{
      const wg3=c2.createRadialGradient(wx,wy2,0,wx,wy2,4.5);
      wg3.addColorStop(0,'rgba(255,210,80,0.9)');wg3.addColorStop(1,'rgba(255,180,40,0)');
      c2.fillStyle=wg3;c2.beginPath();c2.arc(wx,wy2,4.5,0,Math.PI*2);c2.fill();
    });
  }
  // Name label with shadow
  c2.font='bold 7px Orbitron,monospace';c2.textAlign='center';c2.textBaseline='top';
  c2.fillStyle='rgba(0,0,0,0.6)';c2.fillText(city.name,sx+1,sy+r*0.44+1);
  c2.fillStyle=fac.light;c2.fillText(city.name,sx,sy+r*0.44);
  // HP bar
  const hbw=r,hby=sy+r*0.56;
  c2.fillStyle='rgba(0,0,0,0.48)';rRect(c2,sx-hbw/2,hby,hbw,4,2);c2.fill();
  const hpPct=city.hp/city.maxHp;
  const hpG=c2.createLinearGradient(sx-hbw/2,hby,sx-hbw/2+hbw*hpPct,hby+4);
  const hpCol=hpPct>0.6?fac.color:hpPct>0.3?'#ffc040':'#ff4444';
  hpG.addColorStop(0,hpCol+'ee');hpG.addColorStop(1,hpCol+'88');
  c2.fillStyle=hpG;rRect(c2,sx-hbw/2,hby,hbw*hpPct,4,2);c2.fill();
  // Level badge
  if(lv>1){
    c2.fillStyle='rgba(0,0,0,0.65)';rRect(c2,sx+r*0.46,sy+r*0.42,r*0.36,r*0.2,2);c2.fill();
    c2.strokeStyle=fac.color+'50';c2.lineWidth=0.8;rRect(c2,sx+r*0.46,sy+r*0.42,r*0.36,r*0.2,2);c2.stroke();
    c2.font='bold 7px Orbitron,monospace';c2.fillStyle=fac.light;c2.textAlign='center';c2.textBaseline='middle';c2.fillText('Lv'+lv,sx+r*0.64,sy+r*0.52);
  }
  if(city.role&&CITY_ROLES[city.role]){
    c2.font='9px serif';c2.textAlign='center';c2.textBaseline='middle';
    c2.fillText(CITY_ROLES[city.role].icon,sx-r*0.62,sy+r*0.52);
  }
}


function drawUnit(c2,sx,sy,unit){
  const fac=getFac(unit.owner);
  const ut=UNITS[unit.type];
  const isLeviathan=unit.type==='LEVIATHAN';
  const sz=isLeviathan?22:16, ux=sx, uy=sy+HS*0.05;
  const era=ut.era||'MEDIEVAL';

  // Drop shadow
  c2.fillStyle='rgba(0,0,0,0.38)';
  c2.beginPath();c2.ellipse(ux+2.5,uy+sz+2.5,sz*0.9,sz*0.28,0,0,Math.PI*2);c2.fill();

  if(isLeviathan){
    // Leviathan aura
    const wg=c2.createRadialGradient(ux,uy,0,ux,uy,sz*2.2);
    wg.addColorStop(0,fac.cityLight+'95');wg.addColorStop(0.4,fac.cityColor+'60');wg.addColorStop(1,'rgba(0,60,120,0)');
    c2.fillStyle=wg;c2.beginPath();c2.arc(ux,uy,sz*2.2,0,Math.PI*2);c2.fill();
    if(G.wrath>8){
      const rg=c2.createRadialGradient(ux,uy,0,ux,uy,sz*2.5);
      rg.addColorStop(0,'rgba(255,50,0,0.45)');rg.addColorStop(1,'rgba(255,50,0,0)');
      c2.fillStyle=rg;c2.beginPath();c2.arc(ux,uy,sz*2.5,0,Math.PI*2);c2.fill();
    }
  }

  // Badge shadow offset
  c2.save();unitBadgePath(c2,ux+2,uy+2,sz,isLeviathan?'INTERSTELLAR':era);c2.fillStyle='rgba(0,0,0,0.48)';c2.fill();c2.restore();

  // Outer glow
  const glow=c2.createRadialGradient(ux,uy,sz-2,ux,uy,sz+8);
  glow.addColorStop(0,fac.cityLight+'48');glow.addColorStop(1,'transparent');
  c2.fillStyle=glow;c2.beginPath();c2.arc(ux,uy,sz+8,0,Math.PI*2);c2.fill();

  // Badge body ‚Äî lit top-left
  const bg=c2.createLinearGradient(ux-sz,uy-sz,ux+sz*0.6,uy+sz*0.6);
  bg.addColorStop(0,fac.cityLight+'ee');bg.addColorStop(0.4,fac.cityColor+'dd');bg.addColorStop(1,fac.cityColor+'77');
  unitBadgePath(c2,ux,uy,sz,isLeviathan?'INTERSTELLAR':era);c2.fillStyle=bg;c2.fill();
  c2.strokeStyle=fac.cityLight;c2.lineWidth=isLeviathan?2.5:2;c2.stroke();

  // Inner bevel
  c2.save();unitBadgePath(c2,ux,uy,sz*0.84,isLeviathan?'INTERSTELLAR':era);
  c2.strokeStyle='rgba(255,255,255,0.15)';c2.lineWidth=1;c2.stroke();c2.restore();

  // Specular gloss top-left
  const spec=c2.createRadialGradient(ux-sz*0.28,uy-sz*0.28,0,ux-sz*0.1,uy-sz*0.1,sz*0.55);
  spec.addColorStop(0,'rgba(255,255,255,0.22)');spec.addColorStop(1,'rgba(255,255,255,0)');
  unitBadgePath(c2,ux,uy,sz,isLeviathan?'INTERSTELLAR':era);c2.fillStyle=spec;c2.fill();

  // Canvas art icon, clipped to badge
  c2.save();
  unitBadgePath(c2,ux,uy,sz,isLeviathan?'INTERSTELLAR':era);c2.clip();
  drawUnitIcon(c2,unit.type,ux,uy,sz*0.62,fac.cityColor,fac.cityLight);
  c2.restore();
  // HP dots
  const maxD=5,hpD=Math.ceil((unit.hp/ut.hp)*maxD);
  for(let i=0;i<maxD;i++){
    const dx=ux-(maxD-1)*3.5+i*7;
    c2.beginPath();c2.arc(dx,uy+sz+7,2.4,0,Math.PI*2);
    const dotCol=i<hpD?(unit.owner==='player'?'#40ff80':fac.color):'rgba(0,0,0,0.5)';
    c2.fillStyle=dotCol;c2.fill();
    if(i<hpD){c2.strokeStyle='rgba(255,255,255,0.2)';c2.lineWidth=0.8;c2.stroke();}
  }
  if(unit.disabled){
    c2.beginPath();c2.arc(ux,uy,sz+2,0,Math.PI*2);
    c2.fillStyle='rgba(140,0,200,0.32)';c2.fill();
    c2.font='11px serif';c2.fillStyle='#cc88ff';
    c2.textAlign='center';c2.textBaseline='middle';
    c2.fillText('üí´',ux,uy-sz-5);
  }
  if(unit.moved&&unit.owner==='player'){
    c2.beginPath();c2.arc(ux,uy,sz+1,0,Math.PI*2);
    c2.fillStyle='rgba(0,0,0,0.35)';c2.fill();
    c2.font='8px serif';c2.fillStyle='rgba(200,200,255,0.5)';
    c2.textAlign='center';c2.textBaseline='middle';
    c2.fillText('z',ux+sz-4,uy-sz+1);
  }
  // Rank stars ‚Äî shown above unit for rank ‚â• 1
  const rank=unit.rank||0;
  if(rank>0){
    const stars=RANKS[rank].stars;
    c2.font=`bold ${rank===3?9:8}px serif`;
    c2.textAlign='center';c2.textBaseline='bottom';
    c2.fillStyle='rgba(0,0,0,0.55)';
    c2.fillText(stars,ux+1,uy-sz-1);
    c2.fillStyle=rank===3?'#ffe060':rank===2?'#f0c040':'#d4a820';
    c2.fillText(stars,ux,uy-sz-2);
  }
  // Waypoint indicator ‚Äî small pulsing dot bottom-right
  if(unit.waypoint){
    c2.fillStyle='rgba(64,255,128,0.9)';
    c2.beginPath();c2.arc(ux+sz-2,uy+sz-2,3,0,Math.PI*2);c2.fill();
    c2.strokeStyle='rgba(0,0,0,0.5)';c2.lineWidth=1;c2.stroke();
  }
}

function drawBlackHole(ctx2,sx,sy,t){
  ctx2.save();
  const bg=ctx2.createRadialGradient(sx,sy,0,sx,sy,HS*0.72);
  bg.addColorStop(0,'#000000');bg.addColorStop(0.38,'rgba(20,0,40,0.95)');bg.addColorStop(0.7,'rgba(80,0,140,0.6)');bg.addColorStop(1,'rgba(120,60,200,0)');
  ctx2.fillStyle=bg;ctx2.beginPath();ctx2.arc(sx,sy,HS*0.72,0,Math.PI*2);ctx2.fill();
  for(let i=0;i<4;i++){const phase=t*0.8+i*0.5,radius=HS*(0.48+i*0.11),alpha=0.28-i*0.05;
    ctx2.strokeStyle=`rgba(${150+i*28},${50+i*18},${220+i*8},${alpha+0.09*Math.sin(phase)})`;ctx2.lineWidth=2-i*0.28;
    ctx2.beginPath();ctx2.ellipse(sx,sy,radius,radius*0.28,t*0.14,0,Math.PI*2);ctx2.stroke();}
  for(let i=0;i<8;i++){const angle=t*1.4+i*(Math.PI*2/8),dist=HS*(0.52+Math.sin(t+i)*0.11);
    const px=sx+Math.cos(angle)*dist,py=sy+Math.sin(angle)*dist*0.3;
    ctx2.fillStyle=i%2===0?'rgba(180,100,255,0.65)':'rgba(100,150,255,0.65)';ctx2.beginPath();ctx2.arc(px,py,1.4,0,Math.PI*2);ctx2.fill();}
  ctx2.font='bold 7px Orbitron,monospace';ctx2.textAlign='center';ctx2.textBaseline='top';
  ctx2.fillStyle='rgba(180,100,255,0.8)';ctx2.fillText('BLACK HOLE',sx,sy+HS*0.54);
  if(G.techs&&G.techs.has('EXODUS')){ctx2.fillStyle='rgba(255,220,100,0.7)';ctx2.fillText('LAUNCH EXODUS ‚Üí',sx,sy+HS*0.68);}
  ctx2.restore();
}

let SEED=0;
function noise(x,y){const a=Math.sin(x*127.1+y*311.7+SEED)*43758.5453,b=Math.sin(x*269.5+y*183.3+SEED*1.7)*43758.5453;return((a-Math.floor(a))+(b-Math.floor(b)))/2*2-1;}
// ‚îÄ‚îÄ MAP GEN ‚îÄ‚îÄ
function genMap(planet){
  const g={};
  for(let q=0;q<GW;q++){g[q]={};for(let r=0;r<GH;r++){
    const n=noise(q*0.14,r*0.14),n2=noise(q*0.28+100,r*0.28+100);
    let t;
    if(planet==='EARTH'){
      t=T.PLAINS;
      if(q===0||q===GW-1||r===0||r===GH-1||n<-0.38)t=T.OCEAN;
      else if(n>0.52)t=T.MOUNTAIN;
      else if(n>0.22)t=T.FOREST;
      else if(n2>0.38)t=T.DESERT;
      else if(n2<-0.42)t=T.SNOW;
      else if(n2>0.1&&n<0.0)t=T.WETLAND;
    } else if(planet==='MOON'){
      t=T.M_PLAIN;
      if(n<-0.35)t=T.M_CRATER;
      else if(n>0.42)t=T.M_RIDGE;
      else if(n2>0.42)t=T.M_ICE;
      else if(n2<-0.45)t=T.M_LAVA;
    } else if(planet==='MARS'){
      t=T.R_PLAIN;
      if(n<-0.3)t=T.R_CANYON;
      else if(n>0.48)t=T.R_MOUN;
      else if(n2>0.42)t=T.R_ICE;
      else if(n2<-0.38)t=T.R_DESERT;
    }
    g[q][r]={q,r,terrain:t};
  }}
  return g;
}
function findStart(g,q0,r0,q1,r1){
  const ok=[T.PLAINS,T.FOREST,T.M_PLAIN,T.R_PLAIN];
  for(let i=0;i<300;i++){const q=q0+Math.floor(Math.random()*(Math.max(1,q1-q0))),r=r0+Math.floor(Math.random()*(Math.max(1,r1-r0)));if(q>=0&&q<GW&&r>=0&&r<GH&&ok.includes(g[q][r].terrain))return{q,r};}
  return{q:Math.max(1,q0),r:Math.max(1,r0)};
}
function getStartZones(n){
  if(n===1)return[[2,2,GW-2,GH-2]];if(n===2)return[[1,1,GW/2-1,GH-2],[GW/2+1,1,GW-2,GH-2]];
  if(n===3)return[[1,1,GW/2-1,GH/2-1],[GW/2+1,1,GW-2,GH/2-1],[1,GH/2+1,GW-2,GH-2]];
  return[[1,1,GW/2-1,GH/2-1],[GW/2+1,1,GW-2,GH/2-1],[1,GH/2+1,GW/2-1,GH-2],[GW/2+1,GH/2+1,GW-2,GH-2]];
}

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ
let G={},playerFaction=null;

function getCurrentEra(){
  const t=G.techs||new Set();
  if(t.has('WARP')&&t.has('DARK_ENERGY'))return'INTERSTELLAR';
  if(t.has('ORBIT')||t.has('LASERS')||t.has('AI_WEAPONS'))return'SPACE';
  if(t.has('NUCLEAR')||t.has('RADAR')||t.has('AVIATION'))return'ATOMIC';
  if(t.has('GUNPOWDER')||t.has('STEAM')||t.has('ELECTRICITY'))return'INDUSTRIAL';
  return'MEDIEVAL';
}

function initGame(factionId,aiSetup,planet){
  planet=planet||'EARTH';
  playerFaction=FACTIONS[factionId];
  SEED=Math.random()*9999;
  Object.keys(tileCache).forEach(k=>delete tileCache[k]);
  const grid=genMap(planet);
  const n=1+(aiSetup||[]).length;
  const zones=getStartZones(n);
  const starts=zones.map(([q0,r0,q1,r1])=>findStart(grid,q0,r0,q1,r1));
  const baseTerrain=planet==='EARTH'?T.PLAINS:planet==='MOON'?T.M_PLAIN:T.R_PLAIN;
  starts.forEach(s=>{grid[s.q][s.r].terrain=baseTerrain;});
  const fog={};for(let q=0;q<GW;q++){fog[q]={};for(let r=0;r<GH;r++)fog[q][r]='hidden';}
  const aiPlayers=(aiSetup||[]).map((ai,i)=>({id:'ai'+(i+1),factionId:ai.factionId,faction:FACTIONS[ai.factionId],personality:AI_PERSONALITIES[ai.personality]||AI_PERSONALITIES.TACTICIAN,stars:8,techs:new Set()}));
  const diff=AI_DIFFICULTY[globalDifficulty]||AI_DIFFICULTY.NORMAL;
  aiPlayers.forEach(ai=>{
    ai.diff=diff;
    if(diff.bonusStartTechs){diff.bonusStartTechs.forEach(t=>ai.techs.add(t));}
    if(diff.bonusStartStars){ai.stars+=diff.bonusStartStars;}
  });
  const pTechs=new Set();
  if(factionId==='GREYS'){['FARMING','MINING','GUNPOWDER','STEAM','ELECTRICITY','RADAR','COMPUTING'].forEach(t2=>pTechs.add(t2));}
  G={
    turn:1,phase:'player',stars:8,score:0,grid,fog,planet,
    techs:pTechs,nextId:20,factionId,aiPlayers,era:'MEDIEVAL',diplo:{},wonders:new Set(),
    cities:[{q:starts[0].q,r:starts[0].r,owner:'player',name:playerFaction.name.split(' ')[0]+' HQ',lv:1,pop:0,maxPop:5,hp:20,maxHp:20},...aiPlayers.map((ai,i)=>({q:starts[i+1].q,r:starts[i+1].r,owner:ai.id,name:ai.faction.name.split(' ')[0]+' HQ',lv:1,pop:0,maxPop:5,hp:20,maxHp:20}))],
    units:[{id:1,q:starts[0].q,r:Math.min(starts[0].r+1,GH-2),owner:'player',type:'WARRIOR',hp:10,moved:false,attacked:false,xp:0,rank:0},...aiPlayers.map((ai,i)=>({id:i+2,q:starts[i+1].q,r:Math.max(starts[i+1].r-1,1),owner:ai.id,type:'WARRIOR',hp:UNITS.WARRIOR.hp,moved:false,attacked:false,xp:0,rank:0}))],
    sel:null,selU:null,mRange:null,aRange:null,
    cam:{x:0,y:0},drag:null,dragged:false,animT:0,
    startTime:Date.now(),unitsLost:0,unitsKilled:0,citiesCaptured:0,
    eventCooldown:0,noTechTurn:false,
    wrath:factionId==='BENEVOLENT'?0:null,
    blackHole:{q:GW-3,r:Math.floor(GH/2)},
  }
  revealFog(starts[0].q,starts[0].r,3);
  const mc=hxy(GW/2,GH/2),pc=hxy(starts[0].q,starts[0].r);
  G.cam.x=-(pc.x-mc.x);G.cam.y=-(pc.y-mc.y);
  const fb=document.getElementById('faction-badge');
  fb.textContent=playerFaction.icon+' '+playerFaction.name;fb.style.display='block';fb.style.color=playerFaction.light;fb.style.borderColor=playerFaction.color+'70';fb.style.background='rgba('+hexRGB(playerFaction.color)+',0.07)';
  document.getElementById('h-planet').textContent=planet.charAt(0)+planet.slice(1).toLowerCase();
  const db=document.getElementById('diff-badge');
  if(db){const d=AI_DIFFICULTY[globalDifficulty];db.textContent=d.label;db.style.display='';db.style.color=d.color;db.style.borderColor=d.color+'44';db.style.background=d.color+'08';}
  MUSIC.start();MUSIC.setMode('explore');MUSIC.setPlanet(planet.toLowerCase());
  updateEra();
}
function hexRGB(hex){try{const r2=parseInt(hex.slice(1,3),16),g2=parseInt(hex.slice(3,5),16),b2=parseInt(hex.slice(5,7),16);return`${r2},${g2},${b2}`;}catch(e){return'100,100,200';}}
function revealFog(q,r,range){for(let dq=-range;dq<=range;dq++)for(let dr=-range;dr<=range;dr++){const nq=q+dq,nr=r+dr;if(nq<0||nq>=GW||nr<0||nr>=GH)continue;if(hDist(q,r,nq,nr)<=range)G.fog[nq][nr]='visible';else if(G.fog[nq][nr]==='hidden')G.fog[nq][nr]='fog';}}
const gUnit=(q,r)=>G.units&&G.units.find(u=>u.q===q&&u.r===r);
const gCity=(q,r)=>G.cities&&G.cities.find(c=>c.q===q&&c.r===r);
const isEnemy=(o)=>o!=='player';
const isAI=(o)=>o!=='player'&&o!==null;

function updateEra(){G.era=getCurrentEra();const eb=document.getElementById('era-badge');if(eb)eb.textContent=ERA_NAMES[G.era]||G.era;const meb=document.getElementById('mob-era-badge');if(meb)meb.textContent=ERA_NAMES[G.era]||G.era;}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
let cvW=0,cvH=0;

function render(){
  if(!G.grid)return;
  G.animT=(G.animT||0)+0.016;
  const t=G.animT,pulse=Math.sin(t*3)*0.15+0.85;
  ctx.clearRect(0,0,CV.width,CV.height);
  // Rich planet-specific backgrounds
  if(G.planet==='MOON'){
    const bg=ctx.createRadialGradient(CV.width*0.3,CV.height*0.2,0,CV.width*0.5,CV.height*0.5,Math.max(CV.width,CV.height));
    bg.addColorStop(0,'#0e101e');bg.addColorStop(0.5,'#08080f');bg.addColorStop(1,'#040408');
    ctx.fillStyle=bg;ctx.fillRect(0,0,CV.width,CV.height);
  } else if(G.planet==='MARS'){
    const bg=ctx.createRadialGradient(CV.width*0.6,CV.height*0.2,0,CV.width*0.5,CV.height*0.5,Math.max(CV.width,CV.height));
    bg.addColorStop(0,'#1e0c04');bg.addColorStop(0.5,'#100402');bg.addColorStop(1,'#080200');
    ctx.fillStyle=bg;ctx.fillRect(0,0,CV.width,CV.height);
  } else {
    // Earth ‚Äî deep space blue
    const bg=ctx.createRadialGradient(CV.width*0.4,CV.height*0.25,0,CV.width*0.5,CV.height*0.5,Math.max(CV.width,CV.height));
    bg.addColorStop(0,'#0a0e1c');bg.addColorStop(0.5,'#060810');bg.addColorStop(1,'#020406');
    ctx.fillStyle=bg;ctx.fillRect(0,0,CV.width,CV.height);
  }
  const mc=hxy(GW/2,GH/2),ox=cvW/2+G.cam.x-mc.x,oy=cvH/2+G.cam.y-mc.y;
  for(let q=0;q<GW;q++){for(let r=0;r<GH;r++){
    const{x,y}=hxy(q,r);const sx=x+ox,sy=y+oy;
    if(sx<-TC_S||sx>cvW+TC_S||sy<-TC_S||sy>cvH+TC_S)continue;
    const fog=G.fog[q][r],tile=G.grid[q][r];
    ctx.drawImage(getTile(tile.terrain,fog),sx-TC_S/2,sy-TC_S/2,TC_S,TC_S);
    if(fog==='hidden')continue;
    if(fog==='visible')drawAnimOverlay(ctx,sx,sy,tile.terrain,t+q*0.3+r*0.2);
    const key=`${q},${r}`;
    const isSel=G.sel&&G.sel.q===q&&G.sel.r===r;
    const isMov=G.mRange&&G.mRange.has(key);
    const isAtk=G.aRange&&G.aRange.has(key);
    if(isSel){hPath(ctx,sx,sy,HS);ctx.fillStyle=`rgba(64,216,255,${0.18*pulse})`;ctx.fill();hPath(ctx,sx,sy,HS);ctx.strokeStyle=`rgba(64,216,255,${0.85*pulse})`;ctx.lineWidth=2.5;ctx.stroke();}
    if(isMov&&!isSel){hPath(ctx,sx,sy,HS);ctx.fillStyle=`rgba(40,180,255,${0.17*pulse})`;ctx.fill();hPath(ctx,sx,sy,HS);ctx.strokeStyle=`rgba(80,200,255,${0.55*pulse})`;ctx.lineWidth=2;ctx.stroke();ctx.fillStyle='rgba(100,200,255,0.6)';ctx.beginPath();ctx.arc(sx,sy,4,0,Math.PI*2);ctx.fill();}
    if(isAtk){hPath(ctx,sx,sy,HS);ctx.fillStyle=`rgba(255,50,50,${0.2*pulse})`;ctx.fill();hPath(ctx,sx,sy,HS);ctx.strokeStyle=`rgba(255,80,60,${0.72*pulse})`;ctx.lineWidth=2.5;ctx.stroke();ctx.fillStyle='rgba(255,100,80,0.65)';ctx.beginPath();ctx.arc(sx,sy,4,0,Math.PI*2);ctx.fill();}
    if(G.blackHole&&q===G.blackHole.q&&r===G.blackHole.r&&fog==='visible')drawBlackHole(ctx,sx,sy,t);
    const city=gCity(q,r);if(city&&fog!=='hidden')drawCity(ctx,sx,sy,city);
    const unit=gUnit(q,r);if(unit&&fog==='visible')drawUnit(ctx,sx,sy,unit);
  }}
  // Draw waypoint lines
  const mc3=hxy(GW/2,GH/2),ox3=CV.width/2+G.cam.x-mc3.x,oy3=CV.height/2+G.cam.y-mc3.y;
  G.units.filter(u=>u.owner==='player'&&u.waypoint&&G.fog[u.q]&&G.fog[u.q][u.r]==='visible').forEach(u=>{
    const {x:ux,y:uy}=hxy(u.q,u.r);
    const {x:wx,y:wy}=hxy(u.waypoint.q,u.waypoint.r);
    ctx.save();
    ctx.setLineDash([4,4]);ctx.lineWidth=1.5;
    ctx.strokeStyle='rgba(64,255,128,0.45)';
    ctx.beginPath();ctx.moveTo(ux+ox3,uy+oy3);ctx.lineTo(wx+ox3,wy+oy3);ctx.stroke();
    ctx.fillStyle='rgba(64,255,128,0.7)';ctx.beginPath();ctx.arc(wx+ox3,wy+oy3,4,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });
  drawFogEdge(ox,oy);
  if(G.wrath!==null&&playerFaction&&playerFaction.id==='BENEVOLENT'){drawWrathMeter();}
  if(window.innerWidth<=640){drawMobileHUDStrip();}
  // Screen-edge vignette ‚Äî cinematic depth
  const vig=ctx.createRadialGradient(CV.width/2,CV.height/2,CV.height*0.28,CV.width/2,CV.height/2,CV.width*0.85);
  vig.addColorStop(0,'rgba(0,0,0,0)');vig.addColorStop(0.7,'rgba(0,0,0,0)');vig.addColorStop(1,'rgba(0,0,0,0.55)');
  ctx.fillStyle=vig;ctx.fillRect(0,0,CV.width,CV.height);
}

function drawFogEdge(ox,oy){
  ctx.save();

  // Visible tiles bordering fog ‚Äî soft vignette fade toward edge
  for(let q=0;q<GW;q++){for(let r=0;r<GH;r++){
    if(G.fog[q][r]!=='visible')continue;
    const{x,y}=hxy(q,r);const sx=x+ox,sy=y+oy;
    if(sx<-TC_S*2||sx>cvW+TC_S*2||sy<-TC_S*2||sy>cvH+TC_S*2)continue;
    let hasDark=false;
    for(const[nq,nr]of hN(q,r)){
      if(nq<0||nq>=GW||nr<0||nr>=GH){hasDark=true;break;}
      if(G.fog[nq][nr]!=='visible'){hasDark=true;break;}
    }
    if(!hasDark)continue;
    const rad=HS*2.0;
    const g=ctx.createRadialGradient(sx,sy,HS*0.3,sx,sy,rad);
    g.addColorStop(0,'rgba(2,4,16,0)');
    g.addColorStop(0.5,'rgba(2,4,16,0)');
    g.addColorStop(0.75,'rgba(2,4,16,0.25)');
    g.addColorStop(1,'rgba(2,4,16,0.75)');
    ctx.fillStyle=g;
    ctx.beginPath();ctx.arc(sx,sy,rad,0,Math.PI*2);ctx.fill();
  }}

  // Fog/hidden tiles bordering visible ‚Äî dark overlay fading toward centre
  for(let q=0;q<GW;q++){for(let r=0;r<GH;r++){
    if(G.fog[q][r]==='visible')continue;
    const{x,y}=hxy(q,r);const sx=x+ox,sy=y+oy;
    if(sx<-TC_S*2||sx>cvW+TC_S*2||sy<-TC_S*2||sy>cvH+TC_S*2)continue;
    let hasVisible=false;
    for(const[nq,nr]of hN(q,r)){
      if(nq>=0&&nq<GW&&nr>=0&&nr<GH&&G.fog[nq][nr]==='visible'){hasVisible=true;break;}
    }
    if(!hasVisible)continue;
    const rad=HS*1.7;
    const g=ctx.createRadialGradient(sx,sy,0,sx,sy,rad);
    g.addColorStop(0,'rgba(2,4,16,0.65)');
    g.addColorStop(0.55,'rgba(2,4,16,0.35)');
    g.addColorStop(1,'rgba(2,4,16,0)');
    ctx.fillStyle=g;
    ctx.beginPath();ctx.arc(sx,sy,rad,0,Math.PI*2);ctx.fill();
  }}

  ctx.restore();
}

function drawMobileHUDStrip(){
  if(!G.grid||!playerFaction)return;
  const fac=playerFaction;
  const y=cvH-56,h=36,pad=10;
  ctx.save();
  ctx.globalAlpha=0.88;
  ctx.fillStyle='rgba(2,4,16,0.82)';
  rRect(ctx,pad,y,cvW-pad*2,h,8);ctx.fill();
  ctx.strokeStyle=fac.color+'55';ctx.lineWidth=1;
  rRect(ctx,pad,y,cvW-pad*2,h,8);ctx.stroke();
  ctx.globalAlpha=1;
  const items=[
    {icon:'üíé',val:G.stars,lbl:'CRED'},
    {icon:'üèô',val:G.cities.filter(c=>c.owner==='player').length,lbl:'CITY'},
    {icon:'‚öî',val:G.units.filter(u=>u.owner==='player').length,lbl:'UNIT'},
    {icon:'‚≠ê',val:G.score,lbl:'SCORE'},
  ];
  const colW=(cvW-pad*2)/items.length;
  items.forEach((it,i)=>{
    const cx=pad+colW*i+colW/2;
    const cy=y+h/2;
    ctx.textAlign='center';
    ctx.font='11px serif';ctx.fillText(it.icon,cx-18,cy+4);
    ctx.font='bold 12px Orbitron,monospace';ctx.fillStyle=fac.light;
    ctx.textBaseline='middle';ctx.fillText(it.val,cx,cy);
    ctx.font='7px Orbitron,monospace';ctx.fillStyle='rgba(216,232,248,0.32)';
    ctx.fillText(it.lbl,cx+18,cy+1);
  });
  ctx.restore();
}

function drawWrathMeter(){
  const w=130,h=10,x=14,y=cvH-40;
  ctx.fillStyle='rgba(0,0,0,0.55)';rRect(ctx,x,y,w,h,3);ctx.fill();
  const wc=G.wrath/15;
  const wg=ctx.createLinearGradient(x,y,x+w,y);
  wg.addColorStop(0,'#2060c0');wg.addColorStop(0.5,'#4080e0');wg.addColorStop(1,G.wrath>10?'#ff3030':'#80b8ff');
  ctx.fillStyle=wg;rRect(ctx,x,y,w*Math.min(wc,1),h,3);ctx.fill();
  ctx.font='bold 7px Orbitron,monospace';ctx.textAlign='left';ctx.textBaseline='bottom';
  ctx.fillStyle=G.wrath>10?'#ff8080':'rgba(128,184,255,0.7)';
  ctx.fillText(G.wrath>10?'üåä WRATH MAXED':'üåä WRATH: '+G.wrath+'/15',x,y-2);
}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
function sHex(px,py){const mc=hxy(GW/2,GH/2),ox=cvW/2+G.cam.x-mc.x,oy=cvH/2+G.cam.y-mc.y;return pHex(px-ox,py-oy);}
function evtPos(e){
  if(e.changedTouches&&e.changedTouches.length>0)return{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY};
  if(e.touches&&e.touches.length>0)return{x:e.touches[0].clientX,y:e.touches[0].clientY};
  return{x:e.clientX,y:e.clientY};
}
const DRAG_THRESH=()=>('ontouchstart' in window)?10:4;

function onPD(e){
  if(e.touches&&e.touches.length===2){
    G.pinch={d:Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY),cx:(e.touches[0].clientX+e.touches[1].clientX)/2,cy:(e.touches[0].clientY+e.touches[1].clientY)/2};
    e.preventDefault();return;
  }
  e.preventDefault(); // prevent iOS scroll/select interference
  const{x,y}=evtPos(e);G.dragged=false;G.drag={x,y,cx:G.cam.x,cy:G.cam.y};
}
function onPM(e){
  if(e.touches&&e.touches.length===2&&G.pinch){
    const nd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    const nx=(e.touches[0].clientX+e.touches[1].clientX)/2;
    const ny=(e.touches[0].clientY+e.touches[1].clientY)/2;
    G.cam.x+=nx-G.pinch.cx;G.cam.y+=ny-G.pinch.cy;
    G.pinch.cx=nx;G.pinch.cy=ny;G.pinch.d=nd;
    G.dragged=true;e.preventDefault();return;
  }
  if(!G.drag)return;
  e.preventDefault();
  const{x,y}=evtPos(e);const dx=x-G.drag.x,dy=y-G.drag.y;
  if(Math.abs(dx)>DRAG_THRESH()||Math.abs(dy)>DRAG_THRESH()){
    G.dragged=true;G.cam.x=G.drag.cx+dx;G.cam.y=G.drag.cy+dy;
  }
}
function onPU(e){
  G.pinch=null;const d=G.dragged;G.drag=null;G.dragged=false;
  if(!d)onClick(e);
}
CV.addEventListener('mousedown',onPD);CV.addEventListener('mousemove',onPM);CV.addEventListener('mouseup',onPU);
CV.addEventListener('touchstart',onPD,{passive:false});CV.addEventListener('touchmove',onPM,{passive:false});CV.addEventListener('touchend',onPU,{passive:false});
CV.addEventListener('wheel',e=>{G.cam.x-=e.deltaX*0.75;G.cam.y-=e.deltaY*0.75;e.preventDefault();},{passive:false});

function onClick(e){
  if(G.phase!=='player')return;
  const rect=CV.getBoundingClientRect();
  let clientX,clientY;
  if(e.changedTouches&&e.changedTouches.length>0){clientX=e.changedTouches[0].clientX;clientY=e.changedTouches[0].clientY;}
  else if(e.touches&&e.touches.length>0){clientX=e.touches[0].clientX;clientY=e.touches[0].clientY;}
  else{clientX=e.clientX;clientY=e.clientY;}
  const{q,r}=sHex(clientX-rect.left,clientY-rect.top);
  if(q<0||q>=GW||r<0||r>=GH){desel();return;}
  const cu=gUnit(q,r),cc=gCity(q,r),key=`${q},${r}`;
  if(G.blackHole&&q===G.blackHole.q&&r===G.blackHole.r){
    const exShip=G.units.find(u=>u.owner==='player'&&u.type==='EXODUS_SHIP');
    if(exShip&&hDist(exShip.q,exShip.r,q,r)<=2){triggerVictory();return;}
    if(!G.techs.has('EXODUS')){notify('Research Exodus Drive to launch through the Black Hole!','warn');return;}
  }
  if(G.selU){
    if(G.aRange&&G.aRange.has(key)){if(cu&&isEnemy(cu.owner)&&!cu.disabled){doAttack(G.selU,cu);return;}if(cc&&isEnemy(cc.owner)){doAtkCity(G.selU,cc);return;}}
    if(G.mRange&&G.mRange.has(key)&&!cu){
      G.selU.q=q;G.selU.r=r;G.selU.moved=true;
      revealFog(q,r,2);SFX.move();
      const tc=gCity(q,r);if(tc&&isEnemy(tc.owner))capCity(tc,G.selU);
      if(G.selU.type==='EXODUS_SHIP'&&G.blackHole&&hDist(q,r,G.blackHole.q,G.blackHole.r)<=1){triggerVictory();return;}
      compRanges(G.selU);G.sel={q,r};updateHUD();showUnit(G.selU);
      notify('Unit moved');return;
    }
  }
  if(cu&&cu.owner==='player'){G.selU=cu;G.sel={q,r};compRanges(cu);showUnit(cu);return;}
  if(cc&&cc.owner==='player'){desel();G.sel={q,r};showCity(cc);return;}
  desel();G.sel={q,r};showTile(q,r);
}
function desel(){G.selU=null;G.sel=null;G.mRange=null;G.aRange=null;closeMobSheet();}
function isMobile(){return window.innerWidth<=640;}
function openMobSheet(html2){const s=document.getElementById('mob-sheet'),p=document.getElementById('mob-sel-panel');if(!s||!p)return;p.innerHTML=html2;s.classList.add('open');}
function closeMobSheet(){const s=document.getElementById('mob-sheet');if(s)s.classList.remove('open');}

// ‚îÄ‚îÄ COMBAT ‚îÄ‚îÄ
function compRanges(unit){
  const ut=UNITS[unit.type],fac=playerFaction;
  G.mRange=new Set();G.aRange=new Set();
  function passable(q,r){
    const terr=G.grid[q][r].terrain;
    if(terr===T.M_LAVA||terr===T.R_CANYON)return false;
    if(terr===T.OCEAN)return fac.passOcean||false;
    if(terr===T.MOUNTAIN||terr===T.M_RIDGE||terr===T.R_MOUN)return fac.passMountain||false;
    return PASS[terr]!==false;
  }
  if(!unit.moved){
    const vis=new Set([`${unit.q},${unit.r}`]),queue=[{q:unit.q,r:unit.r,m:ut.move}];
    while(queue.length){const{q,r,m}=queue.shift();if(m<=0)continue;for(const[nq,nr]of hN(q,r)){const k=`${nq},${nr}`;if(vis.has(k))continue;if(!passable(nq,nr))continue;const ou=gUnit(nq,nr),oc=gCity(nq,nr);if(ou&&ou.owner==='player')continue;vis.add(k);if((ou&&isEnemy(ou.owner))||(oc&&isEnemy(oc.owner)))G.aRange.add(k);else{G.mRange.add(k);queue.push({q:nq,r:nr,m:m-1});}}}
  }
  if(!unit.attacked&&ut.ranged){for(let dq=-2;dq<=2;dq++)for(let dr=-2;dr<=2;dr++){const nq=unit.q+dq,nr=unit.r+dr;if(nq<0||nq>=GW||nr<0||nr>=GH)continue;const d=hDist(unit.q,unit.r,nq,nr);if(d<1||d>2)continue;const ou=gUnit(nq,nr),oc=gCity(nq,nr);if(ou&&isEnemy(ou.owner))G.aRange.add(`${nq},${nr}`);if(oc&&isEnemy(oc.owner))G.aRange.add(`${nq},${nr}`);}}
  if(!unit.attacked&&!ut.ranged){for(const[nq,nr]of hN(unit.q,unit.r)){const ou=gUnit(nq,nr),oc=gCity(nq,nr);if(ou&&isEnemy(ou.owner))G.aRange.add(`${nq},${nr}`);if(oc&&isEnemy(oc.owner))G.aRange.add(`${nq},${nr}`);}}
}

// ‚îÄ‚îÄ UNIT MANAGEMENT ‚îÄ‚îÄ
const UPGRADE_PATH={
  WARRIOR:'RIFLEMAN', RIFLEMAN:'ASTRONAUT',
  ARCHER:'ARTILLERY',  ARTILLERY:'LASER_TRP',
  KNIGHT:'TANK',       TANK:'AI_ROBOT',
  CATAPULT:'ARTILLERY',
  ENGINEER:'ENGINEER', // no upgrade
};

function disbandUnit(unit){
  if(!unit||unit.owner!=='player')return;
  const ut=UNITS[unit.type];
  const refund=Math.max(1,Math.floor(ut.cost*0.2));
  G.units=G.units.filter(u=>u!==unit);
  G.stars+=refund;
  const p=uPos(unit);
  spawnHeal(p.sx,p.sy,refund);
  notify(ut.icon+' '+ut.name+' disbanded. +'+refund+'üíé refunded.');
  desel();updateHUD();updateSel();
}

function upgradeUnit(unit){
  if(!unit||unit.owner!=='player')return;
  const nextType=UPGRADE_PATH[unit.type];
  if(!nextType||nextType===unit.type){notify('No upgrade available for this unit.','warn');return;}
  const nextUt=UNITS[nextType];
  if(!nextUt){notify('Upgrade not available.','warn');return;}
  if(nextUt.req&&!G.techs.has(nextUt.req)){notify('Requires '+nextUt.req+' tech!','warn');return;}
  const curUt=UNITS[unit.type];
  const upgradeCost=Math.max(1,Math.floor((nextUt.cost-curUt.cost)*0.6));
  if(G.stars<upgradeCost){notify('Need '+upgradeCost+'üíé to upgrade!','warn');return;}
  G.stars-=upgradeCost;
  const hpRatio=unit.hp/curUt.hp;
  unit.type=nextType;
  unit.hp=Math.round(nextUt.hp*hpRatio);
  // Preserve XP/rank ‚Äî veterans carry over
  const p=uPos(unit);
  spawnHeal(p.sx,p.sy,0);
  RETRO.levelUp&&RETRO.levelUp(p.sx,p.sy,nextUt.icon+' Upgraded!');
  notify(curUt.icon+' ‚Üí '+nextUt.icon+' '+nextUt.name+'! Cost: '+upgradeCost+'üíé');
  updateHUD();showUnit(unit);
}

// Waypoints ‚Äî stored as unit.waypoint = {q,r}
function setWaypoint(unit,q,r){
  if(!unit||unit.owner!=='player')return;
  if(unit.q===q&&unit.r===r){unit.waypoint=null;notify('Waypoint cleared.');return;}
  unit.waypoint={q,r};
  notify('üìç Waypoint set ‚Äî unit will auto-march each turn.');
  updateSel();
}

function bfsPath(unit,tq,tr){
  // BFS from unit pos to target, returns next step or null
  const ut=UNITS[unit.type],fac=playerFaction;
  function passable(q,r){
    if(q<0||q>=GW||r<0||r>=GH)return false;
    const terr=G.grid[q][r].terrain;
    if(terr===T.M_LAVA||terr===T.R_CANYON)return false;
    if(terr===T.OCEAN)return fac.passOcean||false;
    if(terr===T.MOUNTAIN||terr===T.M_RIDGE||terr===T.R_MOUN)return fac.passMountain||false;
    return PASS[terr]!==false;
  }
  const vis=new Map();
  vis.set(`${unit.q},${unit.r}`,null);
  const queue=[{q:unit.q,r:unit.r}];
  while(queue.length){
    const cur=queue.shift();
    if(cur.q===tq&&cur.r===tr){
      // Trace back to find first step
      let node=`${tq},${tr}`,prev=vis.get(node);
      while(prev&&vis.get(prev)!==null){node=prev;prev=vis.get(prev);}
      const [nq,nr]=node.split(',').map(Number);
      return{q:nq,r:nr};
    }
    for(const[nq,nr]of hN(cur.q,cur.r)){
      const k=`${nq},${nr}`;
      if(vis.has(k))continue;
      if(!passable(nq,nr))continue;
      const ou=gUnit(nq,nr);
      if(ou&&ou.owner==='player'&&!(nq===tq&&nr===tr))continue;
      vis.set(k,`${cur.q},${cur.r}`);
      queue.push({q:nq,r:nr});
    }
  }
  return null;
}

function advanceWaypoints(){
  G.units.filter(u=>u.owner==='player'&&u.waypoint&&!u.moved).forEach(unit=>{
    const {q:tq,r:tr}=unit.waypoint;
    if(unit.q===tq&&unit.r===tr){unit.waypoint=null;return;}
    const step=bfsPath(unit,tq,tr);
    if(!step){unit.waypoint=null;return;}
    // Check if next step has enemy ‚Äî stop and let player handle
    const enemy=gUnit(step.q,step.r);
    if(enemy&&isEnemy(enemy.owner)){unit.waypoint=null;return;}
    unit.q=step.q;unit.r=step.r;unit.moved=true;
    revealFog(unit.q,unit.r,2);
    if(unit.q===tq&&unit.r===tr)unit.waypoint=null;
  });
}


function uPos(unit){const mc=hxy(GW/2,GH/2),{x,y}=hxy(unit.q,unit.r);return{sx:CV.width/2+G.cam.x-mc.x+x,sy:CV.height/2+G.cam.y-mc.y+y};}
function spawnDmg(sx,sy,dmg,col){const el=document.createElement('div');el.className='fdmg';el.style.cssText=`left:${sx-12}px;top:${sy-22}px;font-size:${12+Math.min(dmg,8)}px;color:${col}`;el.textContent='-'+dmg;document.getElementById('cvs-wrap').appendChild(el);setTimeout(()=>el.remove(),1200);}
function spawnHeal(sx,sy,amt){const el=document.createElement('div');el.className='fdmg';el.style.cssText=`left:${sx-8}px;top:${sy-22}px;font-size:12px;color:#40ff80`;el.textContent='+'+(amt||2);document.getElementById('cvs-wrap').appendChild(el);setTimeout(()=>el.remove(),1200);}

// ‚îÄ‚îÄ FX PARTICLE ENGINE ‚îÄ‚îÄ
const FX = (() => {
  const fxCanvas = document.getElementById('FX');
  const c = fxCanvas.getContext('2d');
  let particles = [];
  let projectiles = [];
  let screenFlash = null;
  let running = false;

  function loop() {
    c.clearRect(0, 0, fxCanvas.width / (window.devicePixelRatio||1) * (window.devicePixelRatio||1), fxCanvas.height);
    const now = performance.now();

    // Screen flash
    if (screenFlash) {
      const t = (now - screenFlash.start) / screenFlash.dur;
      if (t < 1) {
        c.fillStyle = screenFlash.col + Math.floor((1-t)*(1-t)*200).toString(16).padStart(2,'0');
        c.fillRect(0, 0, cvW, cvH);
      } else screenFlash = null;
    }

    // Projectiles
    projectiles = projectiles.filter(p => {
      const t = Math.min(1, (now - p.start) / p.dur);
      const x = p.x0 + (p.x1 - p.x0) * t;
      const y = p.y0 + (p.y1 - p.y0) * t;
      // Trail
      const trailLen = p.type === 'laser' ? 28 : 16;
      const tx = p.x0 + (p.x1 - p.x0) * Math.max(0, t - 0.18);
      c.save();
      if (p.type === 'laser') {
        // Laser bolt ‚Äî bright line with glow
        c.shadowBlur = 12; c.shadowColor = p.col;
        const grad = c.createLinearGradient(tx, p.y0 + (p.y1-p.y0)*Math.max(0,t-0.18), x, y);
        grad.addColorStop(0, p.col + '00');
        grad.addColorStop(1, p.col + 'ff');
        c.strokeStyle = grad; c.lineWidth = 3.5; c.lineCap = 'round';
        c.beginPath(); c.moveTo(tx, p.y0 + (p.y1-p.y0)*Math.max(0,t-0.18)); c.lineTo(x, y); c.stroke();
        // Core white
        c.shadowBlur = 4; c.shadowColor = '#fff';
        c.strokeStyle = 'rgba(255,255,255,0.85)'; c.lineWidth = 1.5;
        c.beginPath(); c.moveTo(x - (x-tx)*0.3, y - (y-(p.y0 + (p.y1-p.y0)*Math.max(0,t-0.18)))*0.3); c.lineTo(x, y); c.stroke();
      } else if (p.type === 'arrow') {
        // Arrow ‚Äî simple line + head
        c.shadowBlur = 6; c.shadowColor = p.col;
        c.strokeStyle = p.col; c.lineWidth = 2; c.lineCap = 'round';
        c.beginPath(); c.moveTo(tx, p.y0+(p.y1-p.y0)*Math.max(0,t-0.18)); c.lineTo(x,y); c.stroke();
        const ang = Math.atan2(y - (p.y0+(p.y1-p.y0)*Math.max(0,t-0.18)), x - tx);
        c.fillStyle = p.col;
        c.beginPath(); c.moveTo(x,y);
        c.lineTo(x - Math.cos(ang-0.4)*10, y - Math.sin(ang-0.4)*10);
        c.lineTo(x - Math.cos(ang+0.4)*10, y - Math.sin(ang+0.4)*10);
        c.closePath(); c.fill();
      } else if (p.type === 'shell') {
        // Artillery shell ‚Äî chunky
        c.shadowBlur = 8; c.shadowColor = p.col;
        c.strokeStyle = p.col; c.lineWidth = 3; c.lineCap = 'round';
        c.beginPath(); c.moveTo(tx, p.y0+(p.y1-p.y0)*Math.max(0,t-0.12)); c.lineTo(x, y); c.stroke();
        c.fillStyle = p.col;
        c.beginPath(); c.arc(x, y, 5, 0, Math.PI*2); c.fill();
      } else {
        // Melee slash ‚Äî arc
        const alpha = Math.sin(t * Math.PI);
        c.globalAlpha = alpha;
        c.shadowBlur = 10; c.shadowColor = p.col;
        c.strokeStyle = p.col; c.lineWidth = 3; c.lineCap = 'round';
        c.beginPath(); c.arc(x, y, 14 * t, -0.8, 0.8); c.stroke();
        c.strokeStyle = 'rgba(255,255,255,0.5)'; c.lineWidth = 1.5;
        c.beginPath(); c.arc(x, y, 10 * t, -0.6, 0.6); c.stroke();
      }
      c.restore();
      if (t >= 1) { p.onImpact && p.onImpact(p.x1, p.y1); return false; }
      return true;
    });

    // Particles
    particles = particles.filter(p => {
      const age = now - p.born;
      const life = age / p.life;
      if (life >= 1) return false;
      const x = p.x + p.vx * age * 0.001 * 60;
      const y = p.y + p.vy * age * 0.001 * 60 + p.grav * age * age * 0.0001;
      const alpha = p.type === 'spark' ? Math.pow(1-life, 0.5) :
                    p.type === 'smoke' ? (life < 0.3 ? life/0.3 : (1-life)*0.4) :
                    1 - life;
      const sz = p.type === 'smoke' ? p.sz * (0.5 + life * 1.5) :
                 p.type === 'debris' ? p.sz * (1 - life * 0.3) :
                 p.sz * (1 - life);
      c.save();
      c.globalAlpha = alpha * p.alpha;
      if (p.type === 'smoke') {
        const sg = c.createRadialGradient(x,y,0,x,y,sz);
        sg.addColorStop(0, p.col + '55'); sg.addColorStop(1, p.col + '00');
        c.fillStyle = sg;
        c.beginPath(); c.arc(x, y, sz, 0, Math.PI*2); c.fill();
      } else if (p.type === 'spark') {
        c.shadowBlur = 6; c.shadowColor = p.col;
        c.fillStyle = p.col;
        c.beginPath(); c.arc(x, y, sz, 0, Math.PI*2); c.fill();
        // spark trail
        c.strokeStyle = p.col + '88'; c.lineWidth = sz * 0.5;
        c.beginPath(); c.moveTo(x - p.vx*0.003*60, y - p.vy*0.003*60); c.lineTo(x,y); c.stroke();
      } else if (p.type === 'shockwave') {
        const r = p.sz * life;
        c.strokeStyle = p.col;
        c.lineWidth = 2.5 * (1-life);
        c.globalAlpha = (1-life) * p.alpha;
        c.beginPath(); c.arc(x, y, r, 0, Math.PI*2); c.stroke();
      } else if (p.type === 'glow') {
        const gg = c.createRadialGradient(x,y,0,x,y,sz);
        gg.addColorStop(0, p.col + 'cc'); gg.addColorStop(1, p.col + '00');
        c.fillStyle = gg;
        c.beginPath(); c.arc(x, y, sz, 0, Math.PI*2); c.fill();
      } else {
        // debris
        c.fillStyle = p.col;
        c.save(); c.translate(x,y); c.rotate(p.rot + life * p.rotV);
        c.fillRect(-sz/2, -sz/2, sz, sz);
        c.restore();
      }
      c.restore();
      return true;
    });

    if (particles.length || projectiles.length || screenFlash) {
      requestAnimationFrame(loop);
    } else {
      running = false;
      c.clearRect(0,0,cvW,cvH);
    }
  }

  function start() { if (!running) { running = true; requestAnimationFrame(loop); } }

  function spawn(opts) { particles.push({ born: performance.now(), alpha: 1, rot: 0, rotV: 0, grav: 0, ...opts }); }

  // Impact explosions
  function explosion(x, y, type, col) {
    const now = performance.now();
    // Shockwave ring
    spawn({ type:'shockwave', x, y, vx:0, vy:0, sz: type==='nuke'?120:type==='big'?70:40, life:500, col, alpha:0.9 });
    if (type==='big'||type==='nuke') spawn({ type:'shockwave', x, y, vx:0, vy:0, sz: type==='nuke'?180:100, life:700, col:'#fff', alpha:0.5 });

    // Central glow flash
    spawn({ type:'glow', x, y, vx:0, vy:0, sz: type==='nuke'?90:type==='big'?55:32, life:280, col:'#fff', alpha:0.8 });
    spawn({ type:'glow', x, y, vx:0, vy:0, sz: type==='nuke'?70:type==='big'?42:24, life:350, col, alpha:0.7 });

    // Sparks
    const nSparks = type==='nuke'?30:type==='big'?20:12;
    for (let i=0; i<nSparks; i++) {
      const ang = Math.random()*Math.PI*2, spd = (type==='nuke'?180:type==='big'?130:80) + Math.random()*60;
      spawn({ type:'spark', x, y, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd - 20, sz: 1.5+Math.random()*2.5, life:400+Math.random()*400, col:i%3===0?'#fff':col, alpha:0.9, grav:60 });
    }
    // Debris chunks
    const nDebris = type==='big'||type==='nuke' ? 12 : 6;
    for (let i=0; i<nDebris; i++) {
      const ang = Math.random()*Math.PI*2, spd = 50 + Math.random()*80;
      spawn({ type:'debris', x, y, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd - 30, sz:3+Math.random()*5, life:600+Math.random()*400, col, alpha:0.85, grav:90, rot:Math.random()*Math.PI*2, rotV:Math.random()*8-4 });
    }
    // Smoke plumes
    const nSmoke = type==='big'||type==='nuke' ? 8 : 4;
    for (let i=0; i<nSmoke; i++) {
      const ang = -Math.PI*0.5 + (Math.random()-0.5)*1.2, spd = 25+Math.random()*40;
      spawn({ type:'smoke', x:x+(Math.random()-0.5)*20, y, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd, sz:12+Math.random()*16, life:800+Math.random()*600, col:'#888', alpha:0.45, grav:-15 });
    }
    start();
  }

  // Laser hit ‚Äî no debris, just energy burst
  function laserImpact(x, y, col) {
    spawn({ type:'shockwave', x, y, vx:0, vy:0, sz:50, life:400, col, alpha:0.8 });
    spawn({ type:'glow', x, y, vx:0, vy:0, sz:38, life:250, col:'#fff', alpha:0.7 });
    spawn({ type:'glow', x, y, vx:0, vy:0, sz:28, life:320, col, alpha:0.8 });
    for (let i=0; i<16; i++) {
      const ang=Math.random()*Math.PI*2, spd=100+Math.random()*80;
      spawn({ type:'spark', x, y, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd, sz:1.5+Math.random()*2, life:300+Math.random()*300, col:i%2===0?col:'#fff', alpha:0.9, grav:20 });
    }
    start();
  }

  // Melee clash ‚Äî short sparks
  function meleeImpact(x, y, col) {
    spawn({ type:'glow', x, y, vx:0, vy:0, sz:28, life:180, col:'#fff', alpha:0.6 });
    for (let i=0; i<10; i++) {
      const ang=-Math.PI*0.5+(Math.random()-0.5)*Math.PI, spd=60+Math.random()*60;
      spawn({ type:'spark', x, y, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd-20, sz:1.2+Math.random()*2, life:250+Math.random()*200, col:i%2===0?col:'#ffdd80', alpha:1, grav:80 });
    }
    start();
  }

  // Fire/burning city effect
  function cityFire(x, y, col) {
    explosion(x, y, 'big', col);
    // Extra fire particles rising
    for (let i=0; i<8; i++) {
      spawn({ type:'smoke', x:x+(Math.random()-0.5)*30, y:y+10, vx:(Math.random()-0.5)*20, vy:-40-Math.random()*30, sz:10+Math.random()*14, life:700+Math.random()*400, col:'#ff6020', alpha:0.4, grav:-30 });
    }
    start();
  }

  // Flash whole screen briefly
  function flash(col='#ffffff', dur=200) {
    screenFlash = { col, dur, start: performance.now() };
    start();
  }

  // Launch a projectile from (x0,y0) to (x1,y1)
  function shoot(x0, y0, x1, y1, type, col, onImpact) {
    const dur = type==='laser'?180:type==='arrow'?280:type==='shell'?320:150;
    projectiles.push({ x0,y0,x1,y1, type, col, start:performance.now(), dur, onImpact });
    start();
  }

  return { explosion, laserImpact, meleeImpact, cityFire, flash, shoot, spawn, start, ctx: c };
})();

const RETRO={
  burst(sx,sy,col,size){
    const w=document.getElementById('cvs-wrap');
    const r=document.createElement('div');
    r.className='retro-burst';
    r.style.cssText=`left:${sx}px;top:${sy}px;`;
    const ring=document.createElement('div');
    ring.style.cssText=`position:absolute;width:${size*2}px;height:${size*2}px;border:3px solid ${col};border-radius:50%;animation:burst-ring 0.5s ease-out forwards;`;
    r.appendChild(ring);
    for(let i=0;i<8;i++){
      const pt=document.createElement('div');
      const angle=i*(Math.PI*2/8);
      const dist=size*0.85;
      pt.style.cssText=`position:absolute;width:5px;height:5px;background:${col};border-radius:1px;left:${Math.cos(angle)*dist-2.5}px;top:${Math.sin(angle)*dist-2.5}px;animation:burst-star 0.6s ease-out ${i*0.04}s forwards;`;
      r.appendChild(pt);
    }
    const flash=document.createElement('div');
    flash.style.cssText=`position:absolute;width:${size*0.6}px;height:${size*0.6}px;background:${col};border-radius:50%;left:${-size*0.3}px;top:${-size*0.3}px;animation:retro-flash 0.35s ease-out forwards;`;
    r.appendChild(flash);
    w.appendChild(r);
    setTimeout(()=>r.remove(),700);
  },
  unitDeath(sx,sy,factionColor){
    const w=document.getElementById('cvs-wrap');
    for(let i=0;i<12;i++){
      const p=document.createElement('div');
      const angle=Math.random()*Math.PI*2;
      const dist=20+Math.random()*40;
      const size=3+Math.random()*5;
      const dur=400+Math.random()*400;
      p.style.cssText=`position:absolute;width:${size}px;height:${size}px;background:${factionColor};left:${sx}px;top:${sy}px;border-radius:1px;--cx:${Math.cos(angle)*dist}px;--cy:${Math.sin(angle)*dist}px;animation:comet-fly ${dur}ms ease-out forwards;`;
      w.appendChild(p);
      setTimeout(()=>p.remove(),dur+50);
    }
    RETRO.burst(sx,sy,factionColor,28);
  },
  levelUp(sx,sy,txt){
    const w=document.getElementById('cvs-wrap');
    const el=document.createElement('div');
    el.style.cssText=`position:absolute;left:${sx}px;top:${sy-20}px;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:11px;font-weight:700;color:#f0c040;text-shadow:0 0 10px rgba(240,192,64,0.8);background:rgba(0,0,0,0.8);border:1px solid #f0c040;padding:3px 10px;border-radius:2px;white-space:nowrap;animation:level-up-badge 1.8s ease-out forwards;z-index:350;pointer-events:none;`;
    el.textContent=txt||'‚¨Ü LEVEL UP!';
    w.appendChild(el);
    setTimeout(()=>el.remove(),1900);
  },
  eraFanfare(eraName){
    const w=document.getElementById('cvs-wrap');
    const el=document.createElement('div');
    el.style.cssText=`position:absolute;left:50%;top:35%;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:18px;font-weight:900;color:#ffe080;text-shadow:0 0 30px rgba(240,192,64,0.9),0 0 60px rgba(240,192,64,0.4);background:rgba(2,4,16,0.92);border:2px solid #f0c040;padding:12px 28px;border-radius:4px;white-space:nowrap;animation:era-fanfare 2.5s ease-out forwards;z-index:400;pointer-events:none;letter-spacing:4px;`;
    el.textContent='‚ö° '+eraName.toUpperCase();
    w.appendChild(el);
    setTimeout(()=>el.remove(),2600);
  },
  victoryFlash(){
    const w=document.getElementById('cvs-wrap');
    const el=document.createElement('div');
    el.style.cssText=`position:absolute;inset:0;background:radial-gradient(ellipse,rgba(240,192,64,0.3),transparent 70%);animation:retro-flash 1.2s ease-out forwards;z-index:350;pointer-events:none;`;
    w.appendChild(el);
    setTimeout(()=>el.remove(),1300);
  },
  captureSparkle(sx,sy){
    for(let i=0;i<6;i++){
      setTimeout(()=>{RETRO.burst(sx+Math.random()*30-15,sy+Math.random()*30-15,'#f0c040',12);},i*80);
    }
  },
  researchFlash(sx,sy){
    RETRO.burst(sx||CV.width/2,sy||CV.height/2,'#40d8ff',20);
  },
  comet(){
    const w=document.getElementById('cvs-wrap');
    const startY=Math.random()*CV.height*0.4;
    const el=document.createElement('div');
    el.style.cssText=`position:absolute;left:0;top:${startY}px;width:3px;height:3px;background:#fff;border-radius:50%;box-shadow:0 0 6px #fff,8px 0 12px rgba(255,255,255,0.3),16px 0 8px rgba(255,255,255,0.1);animation:comet-fly 1.4s linear forwards;--cx:${CV.width+40}px;--cy:${(Math.random()-0.5)*100}px;z-index:310;pointer-events:none;`;
    w.appendChild(el);
    setTimeout(()=>el.remove(),1500);
  },
}

setInterval(()=>{if(G.grid&&Math.random()<0.3)RETRO.comet();},4000);

function doAttack(atk,def){
  const at=UNITS[atk.type],dt=UNITS[def.type];
  const isFuture=at.era==='SPACE'||at.era==='INTERSTELLAR'||at.era==='ATOMIC';
  const isLaser=at.era==='SPACE'||at.era==='INTERSTELLAR';
  const isRanged=at.ranged;
  if(isFuture)SFX.laser();else SFX.attack();
  let bonus=0;
  if(playerFaction.id==='BENEVOLENT'&&G.wrath>8)bonus=Math.floor(G.wrath/3);
  const atkBonus=rankBonus(atk).atk+(atk._xenoAtk||0);
  const defBonus=rankBonus(def).def+(def.owner==='player'&&G.wonders&&G.wonders.has('SHIELD_ARRAY')?2:0)+(def._wonderDef||0);
  if(at.disableEnemy&&!def.disabled){def.disabled=2;notify('Psychic link! Enemy disabled for 2 turns üí´');}
  const ad=Math.max(1,at.atk+atkBonus-dt.def-defBonus+ri(3)+bonus);
  const dd=at.ranged?0:Math.max(0,dt.atk+rankBonus(def).atk-at.def-atkBonus+ri(2)-1);
  def.hp-=ad;atk.hp-=dd;
  atk.attacked=true;atk.moved=true;

  // ‚îÄ‚îÄ FX ‚îÄ‚îÄ
  const ap=uPos(atk),dp=uPos(def);
  const fac=getFac(atk.owner);
  const projCol=isLaser?'#ff4444':isRanged?'#e8c060':fac.color;
  const projType=isLaser?'laser':isRanged&&at.era==='INDUSTRIAL'?'shell':isRanged?'arrow':'melee';

  FX.shoot(ap.sx,ap.sy,dp.sx,dp.sy,projType,projCol,()=>{
    if(isLaser)FX.laserImpact(dp.sx,dp.sy,projCol);
    else if(isRanged)FX.explosion(dp.sx,dp.sy,ad>6?'big':'normal',projCol);
    else FX.meleeImpact(dp.sx,dp.sy,projCol);
    if(ad>=8)FX.flash('#ff8040',120);
    spawnDmg(dp.sx,dp.sy,ad,'#ff5050');
    if(dd>0)spawnDmg(ap.sx,ap.sy,dd,'#ff8040');
    if(def.hp<=0){
      RETRO.unitDeath(dp.sx,dp.sy,getFac(def.owner).color);
      G.units=G.units.filter(u=>u!==def);G.score+=65;G.unitsKilled++;
      grantXP(atk,2);
      if(!at.ranged){atk.q=def.q;atk.r=def.r;const tc=gCity(atk.q,atk.r);if(tc&&isEnemy(tc.owner))capCity(tc,atk);}
      notify('Enemy eliminated! +65‚òÖ','gold');
    } else {
      grantXP(atk,1);
      notify(`Hit for ${ad} damage`);
    }
    if(atk.hp<=0){G.units=G.units.filter(u=>u!==atk);G.unitsLost++;notify('Unit lost!','warn');}
    if(G.wrath!==null)G.wrath=Math.min(15,G.wrath+1);
    if(G.wrath===15&&atk.owner==='player')SFX.wrath();
    desel();updateHUD();updateSel();checkEnd();
    MUSIC.setMode('combat');
  });
}
function doAtkCity(atk,city){
  const at=UNITS[atk.type];const dmg=Math.max(1,at.atk+ri(3));
  let bonus=0;if(playerFaction.id==='BENEVOLENT'&&G.wrath>8)bonus=Math.floor(G.wrath/4);
  city.hp-=dmg+bonus;atk.attacked=true;atk.moved=true;
  const isFuture=at.era==='SPACE'||at.era==='INTERSTELLAR'||at.era==='ATOMIC';
  const isLaser=at.era==='SPACE'||at.era==='INTERSTELLAR';
  if(isFuture)SFX.laser();else SFX.attack();

  // FX ‚Äî projectile to city
  const ap=uPos(atk);
  const mc=hxy(GW/2,GH/2),{x,y}=hxy(city.q,city.r);
  const cpx=CV.width/2+G.cam.x-mc.x+x, cpy=CV.height/2+G.cam.y-mc.y+y;
  const fac=getFac(atk.owner);
  const projCol=isLaser?'#ff4444':at.ranged?'#e8c060':fac.color;
  const projType=isLaser?'laser':at.ranged&&at.era==='INDUSTRIAL'?'shell':at.ranged?'arrow':'melee';

  FX.shoot(ap.sx,ap.sy,cpx,cpy,projType,projCol,()=>{
    FX.cityFire(cpx,cpy,projCol);
    if(dmg+bonus>=6)FX.flash('#ff6020',100);
    spawnDmg(cpx,cpy-18,dmg+bonus,'#ff9040');
    if(city.hp<=0){capCity(city,atk);grantXP(atk,2);}
    else{const cd=Math.max(0,2-at.def);atk.hp-=cd;grantXP(atk,1);if(atk.hp<=0){G.units=G.units.filter(u=>u!==atk);G.unitsLost++;notify('Unit lost storming walls!','warn');}else notify(`Assault! ${dmg+bonus} damage`);}
    if(G.wrath!==null)G.wrath=Math.min(15,G.wrath+1);
    desel();updateHUD();updateSel();checkEnd();
  });
}
// ‚îÄ‚îÄ XP & RANK SYSTEM ‚îÄ‚îÄ
const RANKS=[
  {name:'',      stars:'',  xpNeeded:0},
  {name:'Seasoned', stars:'‚òÖ',  xpNeeded:2},
  {name:'Veteran',  stars:'‚òÖ‚òÖ', xpNeeded:5},
  {name:'Elite',    stars:'‚òÖ‚òÖ‚òÖ',xpNeeded:9},
];
function rankBonus(unit){
  const r=unit.rank||0;
  return{atk:r,def:r,hpBonus:r*0.1};
}
function grantXP(unit,xp){
  if(!unit||unit.type==='EXODUS_SHIP')return;
  unit.xp=(unit.xp||0)+xp;
  const oldRank=unit.rank||0;
  let newRank=oldRank;
  for(let i=RANKS.length-1;i>0;i--){if(unit.xp>=RANKS[i].xpNeeded){newRank=i;break;}}
  if(newRank>oldRank){
    unit.rank=newRank;
    const ut=UNITS[unit.type];
    // Heal 25% max HP on rank up
    const bonusHP=Math.floor(ut.hp*0.25);
    unit.hp=Math.min(ut.hp+Math.floor(ut.hp*rankBonus(unit).hpBonus),unit.hp+bonusHP);
    const p=uPos(unit);
    RETRO.levelUp(p.sx,p.sy,RANKS[newRank].stars+' '+RANKS[newRank].name+'!');
    if(unit.owner==='player'){
      notify(RANKS[newRank].stars+' '+unit.type+' is now '+RANKS[newRank].name+'!','gold');
      SFX.research();
    }
  }
}

function capCity(city,captor){
  const captorId=captor?captor.owner:'player';
  if(city.owner==='player'&&captorId!=='player')city._wasPlayer=true;
  city.owner=captorId;city.hp=Math.floor(city.maxHp/2);
  if(captorId==='player'){
    G.score+=250;G.stars+=6;G.citiesCaptured++;SFX.capture();
    notify(city.name+' captured! +250‚òÖ','gold');updateHUD();MUSIC.setMode('combat');
    const cp=uPos(captor||{q:city.q,r:city.r});RETRO.captureSparkle(cp.sx,cp.sy);
  }
}

function maybeRandomEvent(){
  if(G.eventCooldown>0){G.eventCooldown--;return;}
  if(Math.random()>0.18)return;
  const evKeys=PLANET_EVENTS[G.planet]||PLANET_EVENTS.EARTH;
  const ev=RANDOM_EVENTS[evKeys[ri(evKeys.length)]];
  if(!ev)return;
  G.eventCooldown=4;
  SFX.event();
  showEventChoice(ev);
}

// ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ
function showEventChoice(ev){
  G._eventPending=true;
  const modal=document.getElementById('evt-modal');
  document.getElementById('evt-icon').textContent=ev.icon;
  document.getElementById('evt-name').textContent=ev.name;
  document.getElementById('evt-desc').textContent=ev.desc;
  const choicesEl=document.getElementById('evt-choices');
  choicesEl.innerHTML=ev.choices.map((c,i)=>
    `<button class="evt-btn" onclick="resolveEvent(${JSON.stringify(ev.id||'EV').replace(/"/g,"'")},${i})">${c.text}</button>`
  ).join('');
  G._pendingEvent=ev;
  modal.classList.add('open');
}

function resolveEvent(evId,choiceIdx){
  const ev=G._pendingEvent;if(!ev)return;
  const c=ev.choices[choiceIdx];if(!c)return;
  document.getElementById('evt-modal').classList.remove('open');
  G._eventPending=false;G._pendingEvent=null;
  const eff=c.effect;
  if(eff==='stars')G.stars=Math.max(0,G.stars+(c.val||0));
  else if(eff==='credits'){G.stars+=(c.val||10);}
  else if(eff==='noop'){}
  else if(eff==='dmg_units'){G.units.filter(u=>u.owner==='player').forEach(u=>{u.hp=Math.max(1,u.hp-(c.val||2));});G.units=G.units.filter(u=>u.hp>0);}
  else if(eff==='dmg_cities'){G.cities.filter(cc=>cc.owner==='player').forEach(cc=>{cc.hp=Math.max(1,cc.hp-(c.val||4));});}
  else if(eff==='heal_units'){G.units.filter(u=>u.owner==='player').forEach(u=>{const ut=UNITS[u.type];u.hp=Math.min(u.hp+(c.val||2),ut.hp);});}
  else if(eff==='heal_cities'){G.cities.filter(cc=>cc.owner==='player').forEach(cc=>{cc.hp=Math.min(cc.hp+(c.val||3),cc.maxHp);});}
  else if(eff==='full_heal'){G.units.filter(u=>u.owner==='player').forEach(u=>{u.hp=UNITS[u.type].hp;});}
  else if(eff==='city_pop'){G.cities.filter(cc=>cc.owner==='player').forEach(cc=>{cc.pop=Math.max(0,cc.pop-1);});}
  else if(eff==='city_pop_half'){G.cities.filter(cc=>cc.owner==='player').forEach(cc=>{cc.pop=Math.max(0,cc.pop-0.5);});}
  else if(eff==='score'){G.score+=(c.val||50);updateHUD();}
  else if(eff==='free_tech'){
    const avail=TECHS.filter(t=>!G.techs.has(t.id)&&t.req.every(r=>G.techs.has(r)));
    if(avail.length){const pick=avail[ri(avail.length)];G.techs.add(pick.id);notify('‚öóÔ∏è Free tech: '+pick.name+'!','gold');}
  }
  else if(eff==='free_specific_tech'){
    const tid=c.val;if(tid&&!G.techs.has(tid)){G.techs.add(tid);notify('‚öóÔ∏è '+tid+' unlocked!','gold');}
    else{G.stars+=10;notify('Already known ‚Äî 10üíé bonus instead.');}
  }
  else if(eff==='meteor_tech'){
    let count=0;
    const avail=TECHS.filter(t=>!G.techs.has(t.id)&&t.req.every(r=>G.techs.has(r)));
    avail.slice(0,2).forEach(t=>{G.techs.add(t.id);count++;});
    if(count)notify('‚öóÔ∏è '+count+' techs from meteor debris!','gold');
  }
  else if(eff==='steal_tech'){
    const ai=G.aiPlayers&&G.aiPlayers.find(a=>!a.eliminated);
    if(ai){const unique=[...ai.techs].filter(t=>!G.techs.has(t));if(unique.length){const t=unique[ri(unique.length)];G.techs.add(t);notify('üïµÔ∏è Stolen tech: '+t+'!','gold');}else notify('No new techs to steal.');}
  }
  else if(eff==='defector_peace'){
    if(!G.diplo)G.diplo={};
    G.aiPlayers&&G.aiPlayers.filter(a=>!a.eliminated).forEach(a=>{G.diplo[a.id]=(G.diplo[a.id]||0)+5;});
    notify('üïäÔ∏è Double agent creates 5-turn peace with all factions!','gold');
  }
  else if(eff==='reveal_enemies'){
    G.units.filter(u=>isAI(u.owner)).forEach(u=>{if(G.fog[u.q]&&G.fog[u.q][u.r]!=='visible')G.fog[u.q][u.r]='fog';});
    notify('üëÅÔ∏è Enemy positions revealed!','gold');
  }
  else if(eff==='free_unit'){
    const myCities=G.cities.filter(c=>c.owner==='player');
    if(myCities.length){const city=myCities[0];if(!gUnit(city.q,city.r)){G.units.push({id:G.nextId++,q:city.q,r:city.r,owner:'player',type:'WARRIOR',hp:UNITS.WARRIOR.hp,moved:true,attacked:true,xp:0,rank:0});notify('‚öîÔ∏è Free Warrior joined your cause!','gold');}}
  }
  else if(eff==='level_city'){
    const myCities=G.cities.filter(c=>c.owner==='player');
    if(myCities.length){const city=myCities[ri(myCities.length)];city.lv++;city.maxPop=city.lv*5;city.hp=Math.min(city.hp+5,city.maxHp);notify('üè∞ '+city.name+' levelled up!','gold');}
  }
  else if(eff==='unit_atk_buff'){G.units.filter(u=>u.owner==='player').forEach(u=>u._xenoAtk=(u._xenoAtk||0)+1);notify('‚öîÔ∏è All units gain +1 ATK from xenotech!','gold');}
  else if(eff==='dmg_enemies'){G.units.filter(u=>isAI(u.owner)).forEach(u=>{u.hp=Math.max(1,u.hp-(c.val||3));});}
  else if(eff==='next_tech_free'){G._nextTechFree=true;notify('üî¨ Next research costs 0üíé!','gold');}
  else if(eff==='all_credits'){G.stars+=(c.val||8);G.aiPlayers&&G.aiPlayers.forEach(ai=>{ai.stars=(ai.stars||5)+(c.val||8);});}
  else if(eff==='no_tech'){G.noTechTurn=true;}
  else if(eff==='ridge_dmg'){G.units.filter(u=>u.owner==='player'&&G.grid[u.q]&&G.grid[u.q][u.r].terrain===T.M_RIDGE).forEach(u=>{u.hp-=(c.val||3);if(u.hp<=0){G.units=G.units.filter(x=>x!==u);G.unitsLost++;}});}
  else if(eff==='fog_expand'){for(let q=0;q<GW;q++)for(let r=0;r<GH;r++){if(G.fog[q][r]==='visible')G.fog[q][r]='fog';}}
  else if(eff==='destroy_tile'){const q=2+ri(GW-4),r=2+ri(GH-4);const newT=G.planet==='EARTH'?T.OCEAN:G.planet==='MOON'?T.M_CRATER:T.R_CANYON;G.grid[q][r].terrain=newT;delete tileCache[`${newT}-visible`];delete tileCache[`${newT}-fog`];}
  else if(eff==='destroy_enemy_tile'){
    const ai=G.aiPlayers&&G.aiPlayers.find(a=>!a.eliminated);
    if(ai){const ac2=G.cities.find(cc=>cc.owner===ai.id);if(ac2){const q=ac2.q+ri(3)-1,r=ac2.r+ri(3)-1;if(q>=0&&q<GW&&r>=0&&r<GH){const newT=T.OCEAN;G.grid[q][r].terrain=newT;}}}
  }
  else if(eff==='lose_unit'){const pu=G.units.filter(u=>u.owner==='player');if(pu.length){G.units=G.units.filter(u=>u!==pu[pu.length-1]);G.unitsLost++;}}
  notify(ev.icon+' '+c.msg||ev.name);
  updateHUD();
  continueAfterEvent();
}

function continueAfterEvent(){
  if(G._aiContinue){const fn=G._aiContinue;G._aiContinue=null;setTimeout(fn,100);}
}

// ‚îÄ‚îÄ TURN SYSTEM ‚îÄ‚îÄ
function endTurn(){
  if(G.phase!=='player')return;
  G.phase='ai';SFX.endturn&&SFX.endturn();
  playTone(220,'triangle',0.18,0.05);playTone(176,'triangle',0.18,0.04,0.17);
  G.noTechTurn=false;
  // Tick diplomacy timers
  if(G.diplo){
    Object.keys(G.diplo).forEach(aiId=>{
      if(G.diplo[aiId]>0){
        G.diplo[aiId]--;
        if(G.diplo[aiId]===0){
          const ai=G.aiPlayers&&G.aiPlayers.find(a=>a.id===aiId);
          if(ai)notify('‚öîÔ∏è Peace with '+ai.faction.name+' has ended.','warn');
        }
      }
    });
  }
  G.units.filter(u=>u.owner==='player').forEach(u=>{u.moved=false;u.attacked=false;if(u.disabled)u.disabled--;});
  G.units.filter(u=>u.owner==='player'&&u.type==='ENGINEER').forEach(eng=>{
    hN(eng.q,eng.r).forEach(([nq,nr])=>{const ally=gUnit(nq,nr);if(ally&&ally.owner==='player'){const ut=UNITS[ally.type];ally.hp=Math.min(ally.hp+2,ut.hp);const p=uPos(ally);spawnHeal(p.sx,p.sy,2);}});
  });
  let income=2;
  G.cities.filter(c=>c.owner==='player').forEach(c=>{
    let cityIncome=c.lv+(G.techs.has('MEDICINE')?1:0);
    if(G.techs.has('FARMING'))cityIncome+=0.5;
    if(c.role==='FOUNDRY')cityIncome+=2;
    if(G.wonders.has('ARC_REACTOR'))cityIncome+=3;
    // Adjacent resource tiles give income bonus
    const resTiles=[[c.q,c.r],...hN(c.q,c.r)];
    resTiles.forEach(([rq,rr])=>{
      if(rq<0||rq>=GW||rr<0||rr>=GH)return;
      const res=TILE_RESOURCES[G.grid[rq][rr].terrain];
      if(res)cityIncome+=res.incomeBonus||0;
    });
    income+=cityIncome;
    let growRate=playerFaction.id==='BENEVOLENT'?0.3:playerFaction.id==='COLLECTIVE'?0.7:0.5;
    if(c.role==='GRANARY')growRate+=0.4;
    c.pop=Math.min(c.pop+growRate,c.maxPop);
    if(c.pop>=c.maxPop){c.pop=0;c.lv++;c.maxPop=c.lv*5;c.hp=Math.min(c.hp+5,c.maxHp);G.score+=120;
      notify(c.name+' grew to Level '+c.lv+'!','gold');
      const mc2=hxy(GW/2,GH/2),{x:cx,y:cy}=hxy(c.q,c.r);
      RETRO.levelUp(CV.width/2+G.cam.x-mc2.x+cx,CV.height/2+G.cam.y-mc2.y+cy,'‚¨Ü LEVEL '+c.lv+'!');
    }
  });
  if(G.wrath!==null&&G.wrath>0){
    const nearEnemy=G.units.filter(u=>isAI(u.owner)).some(e=>G.units.filter(u=>u.owner==='player').some(p=>hDist(p.q,p.r,e.q,e.r)<=4));
    if(!nearEnemy)G.wrath=Math.max(0,G.wrath-1);
  }
  G.stars+=Math.floor(income);
  G.score+=G.cities.filter(c=>c.owner==='player').length*10;
  G.turn++;
  document.getElementById('tbadge').textContent='TURN '+G.turn;
  updateEra();
  maybeRandomEvent();
  const nearFoe=G.units.filter(u=>u.owner==='player').some(pu=>G.units.filter(u2=>isAI(u2.owner)).some(e=>hDist(pu.q,pu.r,e.q,e.r)<=5));
  MUSIC.setMode(nearFoe?'combat':'explore');
  setMsg('Rivals are thinking‚Ä¶');
  doAllAI(0);
}

function doAllAI(idx){
  if(!G.aiPlayers||idx>=G.aiPlayers.length){
    G.units.filter(u=>u.owner==='player').forEach(u=>revealFog(u.q,u.r,2));
    advanceWaypoints();
    G.phase='player';setMsg('Your move, Commander ‚Äî '+ERA_NAMES[G.era]);updateHUD();checkEnd();
    return;
  }
  const ai=G.aiPlayers[idx];
  const alive=G.cities.some(c=>c.owner===ai.id)||G.units.some(u=>u.owner===ai.id);
  if(!alive){doAllAI(idx+1);return;}
  doSingleAI(ai);
  setTimeout(()=>doAllAI(idx+1),180+idx*120);
}

function doSingleAI(ai){
  const pers=ai.personality,myId=ai.id,fac=ai.faction;
  const diff=ai.diff||AI_DIFFICULTY.NORMAL;
  ai.stars=(ai.stars||5);

  G.cities.filter(c=>c.owner===myId).forEach(c=>{
    c.pop=Math.min(c.pop+0.45,c.maxPop);
    if(c.pop>=c.maxPop){c.pop=0;c.lv++;c.maxPop=c.lv*5;}
    ai.stars+=c.lv+(ai.techs.has('FARMING')?1:0)+(ai.techs.has('MEDICINE')?1:0)+diff.incomeBonus;
  });
  const techBudget=Math.floor(ai.stars*(0.45*diff.techMult));
  const maxTechsThisTurn=diff.multiTech?3:1;
  let spent=0,techsResearched=0;
  const skipResearch=Math.random()<(diff.techSkipChance||0);

  if(!skipResearch){
    for(const tid of pers.techPath){
      if(techsResearched>=maxTechsThisTurn)break;
      if(ai.techs.has(tid))continue;
      const td=TECHS.find(t=>t.id===tid);
      if(!td)continue;
      if(!td.req.every(r=>ai.techs.has(r)))continue;
      const scaledCost=Math.ceil(td.cost/diff.techMult);
      if(ai.stars-spent>=scaledCost&&spent<techBudget){
        spent+=scaledCost;ai.stars-=scaledCost;ai.techs.add(tid);techsResearched++;
      }
    }
    if(techsResearched===0&&Math.random()<0.3){
      const avail=TECHS.filter(t=>!ai.techs.has(t.id)&&t.req.every(r=>ai.techs.has(r)));
      if(avail.length){
        avail.sort((a,b)=>a.cost-b.cost);
        const pick=avail[0];
        const scaledCost=Math.ceil(pick.cost/diff.techMult);
        if(ai.stars>=scaledCost){ai.stars-=scaledCost;ai.techs.add(pick.id);}
      }
    }
  }

  // AI wonder building ‚Äî BUILDER and RESEARCHER prioritise wonders
  if(ai.stars>30&&Math.random()<(pers.bias==='economy'||pers.bias==='exodus'?0.35:0.15)){
    if(!ai.wonders)ai.wonders=new Set();
    const available=Object.values(WONDERS).filter(w=>
      !ai.wonders.has(w.id)&&!G.wonders.has(w.id)&&
      !G.aiPlayers.some(a2=>a2!==ai&&a2.wonders&&a2.wonders.has(w.id))&&
      ai.techs.has(w.req)&&ai.stars>=w.cost
    );
    if(available.length){
      const pick=available[ri(available.length)];
      ai.stars-=pick.cost;ai.wonders.add(pick.id);
      notify('‚ö†Ô∏è '+fac.name+' built the '+pick.icon+' '+pick.name+'!','warn');
    }
  }


  function getUnitsByRole(role){
    return Object.entries(UNITS).filter(([key,ut])=>{
      if(ut.greyOnly&&fac.id!=='GREYS')return false;
      if(ut.benevolentOnly&&fac.id!=='BENEVOLENT')return false;
      if(ut.isExodus)return false;
      if(ut.req&&!ai.techs.has(ut.req))return false;
      if(role==='melee')return !ut.ranged&&ut.atk>=3&&ut.move>=1;
      if(role==='ranged')return ut.ranged&&!ut.isExodus;
      if(role==='siege')return ut.ranged&&ut.atk>=6;
      if(role==='special')return ut.era==='SPACE'||ut.era==='INTERSTELLAR';
      return false;
    }).sort((a,b)=>b[1].atk-a[1].atk);
  }
  const myUnits=G.units.filter(u=>u.owner===myId);
  const nMelee=myUnits.filter(u=>!UNITS[u.type].ranged).length;
  const nRanged=myUnits.filter(u=>UNITS[u.type].ranged).length;
  const total=Math.max(1,myUnits.length);
  const comp=pers.unitComposition;

  G.cities.filter(c=>c.owner===myId).forEach(c=>{
    if(gUnit(c.q,c.r))return;
    if(Math.random()<(1-diff.spendMult)*0.5)return;
    let role='melee';
    const meleeFrac=nMelee/total,rangedFrac=nRanged/total;
    if(meleeFrac>(comp.melee+0.1)&&rangedFrac<comp.ranged)role='ranged';
    else if(rangedFrac>(comp.ranged+0.1)&&total>4)role='siege';
    else if(total>6&&comp.special>0&&Math.random()<comp.special)role='special';
    if(diff.blunderChance>0&&Math.random()<diff.blunderChance){
      const allAffordable=Object.entries(UNITS).filter(([,ut])=>!ut.greyOnly&&!ut.benevolentOnly&&!ut.isExodus&&(!ut.req||ai.techs.has(ut.req))&&ai.stars>=ut.cost);
      if(allAffordable.length){
        const[key,ut]=allAffordable[ri(allAffordable.length)];
        ai.stars-=ut.cost;G.units.push({id:G.nextId++,q:c.q,r:c.r,owner:myId,type:key,hp:ut.hp,moved:false,attacked:false,xp:0,rank:0});
      }
      return;
    }
    const candidates=getUnitsByRole(role);
    const fallback=getUnitsByRole('melee');
    const pool=candidates.length?candidates:fallback;
    if(!pool.length)return;
    const affordable=pool.filter(([,ut])=>{
      const cost=ut.cost-(fac.unitDiscount||0);
      return ai.stars>=cost&&ai.stars*(pers.spendThreshold*diff.spendMult)>=cost;
    });
    if(!affordable.length)return;
    const [key,ut]=affordable[0];
    const cost=ut.cost-(fac.unitDiscount||0);
    ai.stars-=cost;
    G.units.push({id:G.nextId++,q:c.q,r:c.r,owner:myId,type:key,hp:ut.hp,moved:false,attacked:false,xp:0,rank:0});
  });

  if(pers.bias==='exodus'&&ai.techs.has('EXODUS')&&diff.exodusAware){
    const existingExodus=G.units.find(u=>u.owner===myId&&u.type==='EXODUS_SHIP');
    if(!existingExodus){
      const homeCities=G.cities.filter(c=>c.owner===myId&&!gUnit(c.q,c.r));
      if(homeCities.length&&ai.stars>=UNITS.EXODUS_SHIP.cost){
        ai.stars-=UNITS.EXODUS_SHIP.cost;
        G.units.push({id:G.nextId++,q:homeCities[0].q,r:homeCities[0].r,owner:myId,type:'EXODUS_SHIP',hp:UNITS.EXODUS_SHIP.hp,moved:false,attacked:false,xp:0,rank:0});
      }
    } else if(G.blackHole&&!existingExodus.moved){
      const nbrs=hN(existingExodus.q,existingExodus.r).filter(([nq,nr])=>{
        if(nq<0||nq>=GW||nr<0||nr>=GH)return false;
        const terr=G.grid[nq][nr].terrain;
        return PASS[terr]!==false&&terr!==T.M_LAVA&&terr!==T.R_CANYON&&!gUnit(nq,nr);
      }).sort(([aq,ar],[bq,br])=>hDist(aq,ar,G.blackHole.q,G.blackHole.r)-hDist(bq,br,G.blackHole.q,G.blackHole.r));
      if(nbrs.length){
        const[nq,nr]=nbrs[0];existingExodus.q=nq;existingExodus.r=nr;existingExodus.moved=true;
        if(hDist(nq,nr,G.blackHole.q,G.blackHole.r)<=1){
          const f=getFac(myId);
          setTimeout(()=>endScreen(false,'The '+f.name+' launched their Exodus Ship through the Black Hole first! Humanity\'s future belongs to them.'),300);
        }
      }
    }
  }

  function aiCanPass(q,r){
    if(q<0||q>=GW||r<0||r>=GH)return false;
    const terr=G.grid[q][r].terrain;
    if(terr===T.M_LAVA||terr===T.R_CANYON)return false;
    if(terr===T.OCEAN)return fac.passOcean||false;
    if(terr===T.MOUNTAIN||terr===T.M_RIDGE||terr===T.R_MOUN)return fac.passMountain||false;
    return PASS[terr]!==false;
  }

  function getVisiblePlayerTargets(){
    const pUnits=G.units.filter(u=>u.owner==='player');
    const pCities=G.cities.filter(c=>c.owner==='player');
    if(diff.fogCheat)return[...pUnits,...pCities];
    return[
      ...pUnits.filter(u=>G.fog[u.q]&&G.fog[u.q][u.r]==='visible'),
      ...pCities.filter(c=>G.fog[c.q]&&G.fog[c.q][c.r]==='visible'),
    ];
  }

  function threatScore(target){
    let score=0;
    if(target.type&&UNITS[target.type]){
      const ut=UNITS[target.type];
      score=ut.atk*2+(1-target.hp/ut.hp)*8;
      if(diff.lookAhead)score+=ut.atk*1.5;
    } else if(target.lv!==undefined){
      score=target.lv*3+(1-target.hp/target.maxHp)*6;
      if(diff.lookAhead)score+=target.lv*2;
    }
    return score;
  }

  function getNearestOwnCity(q,r){
    return G.cities.filter(c=>c.owner===myId).sort((a,b)=>hDist(a.q,a.r,q,r)-hDist(b.q,b.r,q,r))[0];
  }
  function cityIsDefended(city){
    return G.units.some(u=>u.owner===myId&&(u.q===city.q&&u.r===city.r||hDist(u.q,u.r,city.q,city.r)<=1));
  }

  const atPeaceWithPlayer=inPeace(myId);
  const playerTargets=atPeaceWithPlayer?[]:getVisiblePlayerTargets().map(t=>({...t,score:threatScore(t),isUnit:!!UNITS[t.type],isCity:t.lv!==undefined}));
  const myCities=G.cities.filter(c=>c.owner===myId);

  function mayTaunt(){
    if(diff.taunt&&Math.random()<0.1){
      const t=ELON_TAUNTS[ri(ELON_TAUNTS.length)];
      setTimeout(()=>notify(t,'warn'),400);
    }
  }

  G.units.filter(u=>u.owner===myId&&!u.moved).forEach(unit=>{
    if(unit.hp<=0)return;
    const ut=UNITS[unit.type];
    const hpFrac=unit.hp/ut.hp;
    const effectiveRetreat=pers.retreatThreshold*diff.retreatMult;

    if(diff.blunderChance>0&&Math.random()<diff.blunderChance*0.6){
      if(Math.random()<0.5){unit.moved=true;return;} // do nothing
      const wander=hN(unit.q,unit.r).filter(([nq,nr])=>aiCanPass(nq,nr)&&!gUnit(nq,nr));
      if(wander.length){const[nq,nr]=wander[ri(wander.length)];unit.q=nq;unit.r=nr;}
      unit.moved=true;return;
    }

    if(hpFrac<effectiveRetreat){
      const safeCity=getNearestOwnCity(unit.q,unit.r);
      if(safeCity&&hDist(unit.q,unit.r,safeCity.q,safeCity.r)>1){
        const nbrs=hN(unit.q,unit.r).filter(([nq,nr])=>aiCanPass(nq,nr)&&!gUnit(nq,nr))
          .sort(([aq,ar],[bq,br])=>hDist(aq,ar,safeCity.q,safeCity.r)-hDist(bq,br,safeCity.q,safeCity.r));
        if(nbrs.length){const[nq,nr]=nbrs[0];unit.q=nq;unit.r=nr;unit.moved=true;}
      }
      return;
    }
    if(!playerTargets.length)return;
    const homeCap=myCities[0];
    if(homeCap&&!cityIsDefended(homeCap)&&Math.random()<pers.defenceRatio){
      if(hDist(unit.q,unit.r,homeCap.q,homeCap.r)>1){
        const nbrs=hN(unit.q,unit.r).filter(([nq,nr])=>aiCanPass(nq,nr)&&!gUnit(nq,nr))
          .sort(([aq,ar],[bq,br])=>hDist(aq,ar,homeCap.q,homeCap.r)-hDist(bq,br,homeCap.q,homeCap.r));
        if(nbrs.length){const[nq,nr]=nbrs[0];unit.q=nq;unit.r=nr;unit.moved=true;return;}
      }
    }
    let bestTarget=null,bestVal=-Infinity;
    playerTargets.forEach(tgt=>{
      const d=hDist(unit.q,unit.r,tgt.q,tgt.r);
      const val=(tgt.score+10)/(d+1);
      if(val>bestVal){bestVal=val;bestTarget=tgt;}
    });
    if(!bestTarget)return;

    if(ut.ranged&&!unit.attacked){
      const atRange=playerTargets.filter(tgt=>{
        const d=hDist(unit.q,unit.r,tgt.q,tgt.r);return d>=1&&d<=2;
      }).sort((a,b)=>b.score-a.score);
      if(atRange.length){
        const tgt=atRange[0];
        const raw=Math.max(1,ut.atk-(tgt.def||0)+ri(3));
        const dmg=Math.round(raw*diff.dmgMult);
        if(tgt.isUnit){
          const pu=G.units.find(u=>u.q===tgt.q&&u.r===tgt.r&&u.owner==='player');
          if(pu){pu.hp-=dmg;if(pu.hp<=0){const pp=uPos(pu);RETRO.burst(pp.sx,pp.sy,getFac(pu.owner).color,18);G.units=G.units.filter(u=>u!==pu);G.unitsLost++;}}
        } else if(tgt.isCity){
          const pc=G.cities.find(c=>c.q===tgt.q&&c.r===tgt.r);
          if(pc){pc.hp-=dmg;if(pc.hp<=0){pc.owner=myId;pc.hp=Math.floor(pc.maxHp/2);notify('‚ö†Ô∏è '+pc.name+' seized by '+fac.name+'!','warn');if(G.wrath!==null)G.wrath=Math.min(15,G.wrath+3);}}
        }
        unit.attacked=true;unit.moved=true;
        if(G.wrath!==null)G.wrath=Math.min(15,G.wrath+1);
        mayTaunt();
        return;
      }
    }

    if(!unit.attacked){
      let attacked=false;
      for(const[nq,nr]of hN(unit.q,unit.r)){
        const pu=G.units.find(u=>u.q===nq&&u.r===nr&&u.owner==='player');
        const pc=G.cities.find(c=>c.q===nq&&c.r===nr&&c.owner==='player');
        if(pu&&!pu.disabled){
          const raw=Math.max(1,ut.atk-UNITS[pu.type].def+ri(3)+(pers.bias==='attack'?1:0));
          const dmg=Math.round(raw*diff.dmgMult);
          const ret=ut.ranged?0:Math.max(0,UNITS[pu.type].atk-ut.def+ri(2)-1);
          pu.hp-=dmg;unit.hp-=ret;
          // FX
          const aip=uPos(unit),pip=uPos(pu);
          const isLaserAI=ut.era==='SPACE'||ut.era==='INTERSTELLAR';
          const aiCol=fac.color;
          const aiProjType=isLaserAI?'laser':ut.ranged&&ut.era==='INDUSTRIAL'?'shell':ut.ranged?'arrow':'melee';
          FX.shoot(aip.sx,aip.sy,pip.sx,pip.sy,aiProjType,aiCol,()=>{
            if(isLaserAI)FX.laserImpact(pip.sx,pip.sy,aiCol);
            else if(ut.ranged)FX.explosion(pip.sx,pip.sy,'normal',aiCol);
            else FX.meleeImpact(pip.sx,pip.sy,aiCol);
            spawnDmg(pip.sx,pip.sy,dmg,'#ff5050');
          });
          if(pu.hp<=0){const pp=uPos(pu);RETRO.burst(pp.sx,pp.sy,getFac(pu.owner).color,18);G.units=G.units.filter(u=>u!==pu);G.unitsLost++;}
          if(unit.hp<=0){G.units=G.units.filter(u=>u!==unit);}
          if(G.wrath!==null)G.wrath=Math.min(15,G.wrath+2);
          attacked=true;unit.attacked=true;unit.moved=true;
          mayTaunt();
          break;
        }
        if(pc&&!attacked){
          const raw=Math.max(1,ut.atk+ri(3));
          const dmg=Math.round(raw*diff.dmgMult);
          pc.hp-=dmg;
          const ret=ut.ranged?0:Math.max(0,2-ut.def);unit.hp-=ret;
          if(pc.hp<=0){pc.owner=myId;pc.hp=Math.floor(pc.maxHp/2);notify('‚ö†Ô∏è '+pc.name+' seized by '+fac.name+'!','warn');if(G.wrath!==null)G.wrath=Math.min(15,G.wrath+4);}
          if(unit.hp<=0)G.units=G.units.filter(u=>u!==unit);
          attacked=true;unit.attacked=true;unit.moved=true;
          mayTaunt();
          break;
        }
      }
      if(attacked||unit.hp<=0)return;
    }

    if(!unit.moved){
      const steps=ut.move||1;
      let cur={q:unit.q,r:unit.r};
      for(let step=0;step<steps;step++){
        const nbrs=hN(cur.q,cur.r).filter(([nq,nr])=>{
          if(!aiCanPass(nq,nr))return false;
          const occ=gUnit(nq,nr);
          return !occ||(occ.owner==='player');
        }).sort(([aq,ar],[bq,br])=>hDist(aq,ar,bestTarget.q,bestTarget.r)-hDist(bq,br,bestTarget.q,bestTarget.r));
        if(!nbrs.length)break;
        const[nq,nr]=nbrs[0];
        if(gUnit(nq,nr)?.owner==='player')break;
        cur={q:nq,r:nr};
      }
      if(cur.q!==unit.q||cur.r!==unit.r){
        unit.q=cur.q;unit.r=cur.r;unit.moved=true;
        const tc=gCity(unit.q,unit.r);
        if(tc&&tc.owner==='player'){tc.owner=myId;tc.hp=Math.floor(tc.maxHp/2);notify('‚ö†Ô∏è '+tc.name+' has fallen to '+fac.name+'!','warn');if(G.wrath!==null)G.wrath=Math.min(15,G.wrath+4);}
      }
    }
  });
  G.units=G.units.filter(u=>u.hp>0);
}

function checkEnd(){
  if(G.blackHole){
    const aiExodus=G.units.find(u=>isAI(u.owner)&&u.type==='EXODUS_SHIP'&&hDist(u.q,u.r,G.blackHole.q,G.blackHole.r)<=1);
    if(aiExodus){
      const f=getFac(aiExodus.owner);
      endScreen(false,'The '+f.name+' launched their Exodus Ship through the Black Hole first! Humanity\'s future belongs to them.');
      return;
    }
  }
  const aiC=G.cities.filter(c=>isAI(c.owner));
  const aiU=G.units.filter(u=>isAI(u.owner));
  const pC=G.cities.filter(c=>c.owner==='player');
  const pU=G.units.filter(u=>u.owner==='player');
  if(!aiC.length&&!aiU.length){
    RETRO.victoryFlash();
    const _achD=checkAchievements(true);endScreen(true,'Total Domination ‚Äî all rival factions have been crushed!',_achD);_achD.forEach((a,i)=>setTimeout(()=>flashAchievement(a),i*600+200));
    return;
  }
  if(!pC.length&&!pU.length){endScreen(false,'Your empire has been overwhelmed.');return;}
  G.aiPlayers&&G.aiPlayers.forEach(ai=>{
    if(!G.cities.some(c=>c.owner===ai.id)&&!G.units.some(u=>u.owner===ai.id)&&!ai.eliminated){
      ai.eliminated=true;
      notify('üíÄ '+ai.faction.name+' has been eliminated!','gold');
      RETRO.burst(CV.width/2+(Math.random()-0.5)*200,CV.height/2+(Math.random()-0.5)*100,ai.faction.color,40);
    }
  });
}

function triggerVictory(){
  G._lastVictoryType='exodus';
  checkExodusAchievement();
  SFX.victory();SFX.launch();
  RETRO.victoryFlash();
  MUSIC.stop();
  let delay=0;
  const colours=['#f0c040','#40d8ff','#ffffff','#f0c040','#ffe080'];
  for(let i=0;i<14;i++){
    setTimeout(()=>{
      RETRO.burst(cvW*0.1+Math.random()*cvW*0.8,cvH*0.1+Math.random()*cvH*0.8,colours[i%colours.length],20+Math.random()*24);
    },delay);
    delay+=130;
  }
  setTimeout(()=>{
    const w=document.getElementById('cvs-wrap');
    const el=document.createElement('div');
    el.style.cssText=`position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:radial-gradient(ellipse,rgba(240,192,64,0.18),rgba(2,4,16,0.92));z-index:390;pointer-events:none;animation:retro-flash 1.8s ease-out forwards;`;
    el.innerHTML=`<div style="font-family:Orbitron,monospace;font-size:28px;font-weight:900;color:#f0c040;text-shadow:0 0 40px rgba(240,192,64,0.9),0 0 80px rgba(240,192,64,0.4);letter-spacing:6px;margin-bottom:8px;">‚ú® EXODUS LAUNCHED</div><div style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:4px;color:rgba(255,220,120,0.7)">HUMANITY DEPARTS FOR A NEW GALAXY</div>`;
    w.appendChild(el);
    setTimeout(()=>el.remove(),1800);
  },400);
  setTimeout(()=>{
    const newAch=checkAchievements(true);
    endScreen(true,'‚ú® EXODUS LAUNCHED ‚Äî Your Exodus Ship tears through the Black Hole! Humanity departs for a new galaxy beyond the stars.',newAch);
    newAch.forEach((a,i)=>setTimeout(()=>flashAchievement(a),i*600+200));
  },2000);
}

function loadLB(){try{return JSON.parse(localStorage.getItem('farreach_lb')||'[]');}catch(e){return[];}}
function saveLB(entry){try{const lb=loadLB();lb.push(entry);lb.sort((a,b)=>b.score-a.score);localStorage.setItem('farreach_lb',JSON.stringify(lb.slice(0,10)));}catch(e){}}
function renderLB(lb){return lb.map((e,i)=>`<div class="lb-row"><div class="lb-rank">#${i+1}</div><div class="lb-name">${e.faction||'?'} ${e.name||'Commander'}</div><div class="lb-score">${(e.score||0).toLocaleString()}</div><div class="lb-meta">${e.turns||0}t ¬∑ ${e.planet||'Earth'} ¬∑ ${e.era||''}</div></div>`).join('')||'<div style="text-align:center;color:rgba(216,232,248,0.25);padding:10px;font-size:10px;font-style:italic">No records yet</div>';}

function renderTechs(){
  renderMobTechs();
  const el=document.getElementById('techlist');if(!el)return;
  let html='';
  ERA_ORDER.forEach(era=>{
    const eraTs=TECHS.filter(t=>t.era===era);
    html+=`<div class="era-hdr">${ERA_NAMES[era]}</div>`;
    eraTs.forEach(t=>{
      const done=G.techs.has(t.id),avail=!done&&!G.noTechTurn&&t.req.every(r=>G.techs.has(r));
      const disc2=playerFaction&&playerFaction.techDiscount?Math.ceil(t.cost*playerFaction.techDiscount):t.cost;
      const disc3=G.cities&&G.cities.some(c=>c.owner==='player'&&c.role==='ACADEMY')?Math.max(1,disc2-2):disc2;
      const disc=G.wonders&&G.wonders.has('GREAT_LIBRARY')?Math.max(1,disc3-3):disc3;
      html+=`<div class="trow"><div class="tpip ${done?'done':avail?'avail':''}"></div><span style="font-size:9px;color:${done?'var(--cyan)':avail?'var(--parchment)':'rgba(216,232,248,0.25)'}">${t.icon} ${t.name}${done?' ‚úì':''}</span>${avail?`<button class="abtn hi" style="padding:1px 5px;font-size:8px;margin:0 0 0 auto;width:auto" onclick="doResearch('${t.id}')">${disc}üíé</button>`:''}</div>`;
    });
  });
  el.innerHTML=html;
}
function renderMobTechs(){
  const el=document.getElementById('mob-techlist');if(!el)return;
  let html='';
  ERA_ORDER.forEach(era=>{
    const eraTs=TECHS.filter(t=>t.era===era);
    html+=`<div class="era-hdr">${ERA_NAMES[era]}</div>`;
    eraTs.forEach(t=>{
      const done=G.techs.has(t.id),avail=!done&&!G.noTechTurn&&t.req.every(r=>G.techs.has(r));
      const disc=playerFaction&&playerFaction.techDiscount?Math.ceil(t.cost*playerFaction.techDiscount):t.cost;
      html+=`<div class="trow"><div class="tpip ${done?'done':avail?'avail':''}"></div><span style="font-size:10px;color:${done?'var(--cyan)':avail?'var(--parchment)':'rgba(216,232,248,0.25)'}">${t.icon} ${t.name}${done?' ‚úì':''}</span>${avail?`<button class="abtn hi" style="padding:5px 8px;font-size:10px;margin-left:auto;width:auto" onclick="doResearch('${t.id}')">${disc}üíé</button>`:''}</div>`;
    });
  });
  el.innerHTML=html;
  const fab=document.getElementById('mob-tech-btn');
  if(fab)fab.classList.toggle('lit',TECHS.some(t=>!G.techs.has(t.id)&&t.req.every(r=>G.techs.has(r))));
}
function doResearch(id){
  if(G.noTechTurn){notify('Solar flare disrupts research this turn!','warn');return;}
  const t=TECHS.find(x=>x.id===id);if(!t||G.techs.has(id))return;
  let disc=playerFaction&&playerFaction.techDiscount?Math.ceil(t.cost*playerFaction.techDiscount):t.cost;
  if(G.cities.some(c=>c.owner==='player'&&c.role==='ACADEMY'))disc=Math.max(1,disc-2);
  if(G.wonders&&G.wonders.has('GREAT_LIBRARY'))disc=Math.max(1,disc-3);
  if(G.stars<disc){notify('Not enough credits! Need '+disc+'üíé','warn');return;}
  const actualCost=G._nextTechFree?0:disc;
  G._nextTechFree=false;
  G.stars-=actualCost;G.techs.add(id);SFX.research();
  G.score+=50;
  const newEra=getCurrentEra();
  if(newEra!==G.era){
    notify('‚ö° NEW ERA: '+ERA_NAMES[newEra]+'!','gold');G.era=newEra;
    MUSIC.setPlanet(G.era==='INTERSTELLAR'?'space':G.planet.toLowerCase());
    setTimeout(()=>RETRO.eraFanfare(ERA_NAMES[newEra]),200);
  }
  notify(t.icon+' '+t.name+' researched!');
  RETRO.researchFlash();
  renderTechs();updateHUD();updateSel();
  if(id==='MOONBASE')notify('üåï Moon Base tech ‚Äî you can now colonise the Moon!','gold');
  if(id==='MARS_BASE')notify('üî¥ Mars Base tech ‚Äî Mars awaits!','gold');
  if(id==='EXODUS')notify('‚ú® EXODUS DRIVE ready ‚Äî move your Exodus Ship to the Black Hole!','gold');
}

// ‚îÄ‚îÄ DIPLOMACY ‚îÄ‚îÄ
const DIPLO_ACCEPT_CHANCE={RUSHER:0.25,BUILDER:0.7,TACTICIAN:0.45,BERSERKER:0.1,RESEARCHER:0.65};

function getDiplo(aiId){return G.diplo&&G.diplo[aiId]||0;}
function inPeace(aiId){return getDiplo(aiId)>0;}

function showDiploScreen(){
  if(!G.aiPlayers||!G.aiPlayers.length)return;
  const rows=G.aiPlayers.filter(ai=>!ai.eliminated).map(ai=>{
    const fac=ai.faction;
    const peace=getDiplo(ai.id);
    const persKey=Object.keys(AI_PERSONALITIES).find(k=>AI_PERSONALITIES[k]===ai.personality)||'TACTICIAN';
    const attitude=DIPLO_ACCEPT_CHANCE[persKey];
    const attitudeLabel=attitude>=0.6?'üü¢ Receptive':attitude>=0.35?'üü° Neutral':'üî¥ Hostile';
    const statusHtml=peace>0
      ?`<span style="color:var(--green);font-size:8px">üïäÔ∏è Peace: ${peace} turns left</span>`
      :`<span style="color:rgba(255,80,80,0.7);font-size:8px">‚öîÔ∏è At war</span>`;
    return`<div style="border:1px solid rgba(64,216,255,0.12);border-radius:6px;padding:12px;margin-bottom:10px;background:rgba(4,8,24,0.6);">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
        <span style="font-size:22px">${fac.icon}</span>
        <div style="flex:1">
          <div style="font-family:Orbitron,monospace;font-size:9px;letter-spacing:1px;color:${fac.light}">${fac.name}</div>
          <div style="font-size:8px;color:rgba(216,232,248,0.4);margin-top:2px">${attitudeLabel} ¬∑ ${statusHtml}</div>
        </div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        ${peace<=0?`<button onclick="proposePeace('${ai.id}')" style="flex:1;min-width:80px;padding:7px 6px;border:1px solid rgba(64,255,128,0.35);background:rgba(64,255,128,0.06);color:rgba(64,255,128,0.85);font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;cursor:pointer;border-radius:3px;min-height:36px;transition:all 0.15s;">üïäÔ∏è PROPOSE PEACE</button>`
        :`<button onclick="declareWar('${ai.id}')" style="flex:1;min-width:80px;padding:7px 6px;border:1px solid rgba(255,80,80,0.35);background:rgba(255,80,80,0.06);color:rgba(255,100,100,0.85);font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;cursor:pointer;border-radius:3px;min-height:36px;transition:all 0.15s;">üó°Ô∏è DECLARE WAR</button>`}
        <button onclick="payTribute('${ai.id}')" style="flex:1;min-width:80px;padding:7px 6px;border:1px solid rgba(240,192,64,0.35);background:rgba(240,192,64,0.06);color:rgba(240,192,64,0.85);font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;cursor:pointer;border-radius:3px;min-height:36px;transition:all 0.15s;">üí∞ PAY TRIBUTE (10üíé)</button>
      </div>
    </div>`;
  }).join('');

  const html=`<div style="font-family:Orbitron,monospace;font-size:9px;letter-spacing:3px;color:var(--cyan);margin-bottom:14px;text-align:center">DIPLOMACY</div>
    ${rows}
    <p style="font-size:8px;color:rgba(216,232,248,0.25);text-align:center;font-style:italic">During peace, rivals will not attack you.</p>`;
  document.getElementById('sel-panel').innerHTML=html;
  if(isMobile())openMobSheet(html);
}

function proposePeace(aiId){
  const ai=G.aiPlayers&&G.aiPlayers.find(a=>a.id===aiId);if(!ai||ai.eliminated)return;
  const persKey=Object.keys(AI_PERSONALITIES).find(k=>AI_PERSONALITIES[k]===ai.personality)||'TACTICIAN';
  const chance=DIPLO_ACCEPT_CHANCE[persKey]||0.4;
  if(Math.random()<chance){
    if(!G.diplo)G.diplo={};
    G.diplo[aiId]=6;
    notify('üïäÔ∏è '+ai.faction.name+' accepts peace for 6 turns!','gold');
  } else {
    notify('‚öîÔ∏è '+ai.faction.name+' refuses your offer!','warn');
  }
  showDiploScreen();
}

function payTribute(aiId){
  if(G.stars<10){notify('Not enough credits! Need 10üíé','warn');return;}
  const ai=G.aiPlayers&&G.aiPlayers.find(a=>a.id===aiId);if(!ai||ai.eliminated)return;
  G.stars-=10;
  if(!G.diplo)G.diplo={};
  G.diplo[aiId]=(G.diplo[aiId]||0)+5;
  notify('üí∞ Tribute paid ‚Äî '+ai.faction.name+' grants 5 turns of peace.','gold');
  updateHUD();showDiploScreen();
}

function declareWar(aiId){
  const ai=G.aiPlayers&&G.aiPlayers.find(a=>a.id===aiId);if(!ai)return;
  if(!G.diplo)G.diplo={};
  G.diplo[aiId]=0;
  notify('üó°Ô∏è War declared on '+ai.faction.name+'!','warn');
  showDiploScreen();
}


// ‚îÄ‚îÄ WONDERS ‚îÄ‚îÄ
function applyWonderEffect(wid){
  const w=WONDERS[wid];if(!w)return;
  if(w.effect==='city_hp'){G.cities.filter(c=>c.owner==='player').forEach(c=>{c.maxHp+=10;c.hp=Math.min(c.hp+10,c.maxHp);});}
  if(w.effect==='reveal_map'){for(let q=0;q<GW;q++)for(let r=0;r<GH;r++)if(G.fog[q][r]==='hidden')G.fog[q][r]='fog';}
  if(w.effect==='unit_def'){G.units.filter(u=>u.owner==='player').forEach(u=>u._wonderDef=(u._wonderDef||0)+2);}
}
function buildWonder(wid){
  const w=WONDERS[wid];if(!w)return;
  if(G.wonders.has(wid)){notify(w.name+' already built!','warn');return;}
  const aiBuilt=G.aiPlayers&&G.aiPlayers.some(a=>a.wonders&&a.wonders.has(wid));
  if(aiBuilt){notify('Another empire already built the '+w.name+'!','warn');return;}
  if(!G.techs.has(w.req)){notify('Requires '+w.req+' tech!','warn');return;}
  if(G.stars<w.cost){notify('Need '+w.cost+'üíé to build '+w.name,'warn');return;}
  G.stars-=w.cost;
  G.wonders.add(wid);
  G.score+=300;
  applyWonderEffect(wid);
  SFX.research&&SFX.research();
  setTimeout(()=>RETRO.eraFanfare&&RETRO.eraFanfare(w.icon+' '+w.name),100);
  notify(w.icon+' '+w.name+' COMPLETED! '+w.desc,'gold');
  updateHUD();updateSel();
}

const CITY_ROLES={
  FOUNDRY:  {id:'FOUNDRY', icon:'üè≠', name:'Foundry',  color:'#f08030', desc:'Earn +2üíé income per turn. Units cost -1üíé to train here.'},
  GARRISON: {id:'GARRISON',icon:'‚öîÔ∏è', name:'Garrison', color:'#e04040', desc:'Units trained here start with 1 XP (Seasoned sooner). City gains +8 max HP.'},
  GRANARY:  {id:'GRANARY', icon:'üåæ', name:'Granary',  color:'#80d040', desc:'+0.4 extra population growth per turn. Levels up faster.'},
  ACADEMY:  {id:'ACADEMY', icon:'üî¨', name:'Academy',  color:'#40b8ff', desc:'All tech research costs -2üíé.'},
};
function setSpecialisation(q,r,roleId){
  q=+q;r=+r;
  const city=gCity(q,r);if(!city||city.owner!=='player')return;
  if(city.lv<2){notify('City must be Level 2 to specialise!','warn');return;}
  if(city.role===roleId){city.role=null;notify(city.name+' ‚Äî specialisation removed.');updateSel();return;}
  const prev=city.role;
  // Undo old role effects
  if(prev==='GARRISON')city.maxHp-=8;
  city.role=roleId;
  // Apply new role effects
  if(roleId==='GARRISON'){city.maxHp+=8;city.hp=Math.min(city.hp+8,city.maxHp);}
  const r2=CITY_ROLES[roleId];
  notify(r2.icon+' '+city.name+' ‚Üí '+r2.name,'gold');
  SFX.build&&SFX.build();
  updateSel();updateHUD();
}

function doTrain(q,r,type){
  q=+q;r=+r;
  const ut=UNITS[type];if(!ut)return;
  const factOk=(!ut.greyOnly||playerFaction.id==='GREYS')&&(!ut.benevolentOnly||playerFaction.id==='BENEVOLENT');
  if(!factOk){notify('This unit is faction-exclusive!','warn');return;}
  if(ut.req&&!G.techs.has(ut.req)){notify('Research '+ut.req+' first!','warn');return;}
  if(gUnit(q,r)){notify('Tile occupied!','warn');return;}
  let cost=ut.cost;
  if(playerFaction.id==='COLLECTIVE')cost=Math.max(1,cost-1);
  if(playerFaction.id==='APEX'&&(type==='COLONY_VEH'||type==='EXODUS_SHIP'))cost=Math.max(1,cost-2);
  const trainCity=gCity(q,r);
  if(trainCity&&trainCity.role==='FOUNDRY')cost=Math.max(1,cost-1);
  if(G.stars<cost){notify('Not enough credits! Need '+cost+'üíé','warn');return;}
  G.stars-=cost;G.score+=25;
  const startXP=trainCity&&trainCity.role==='GARRISON'?1:0;
  G.units.push({id:G.nextId++,q,r,owner:'player',type,hp:ut.hp,moved:true,attacked:true,xp:startXP,rank:0});
  SFX.build();
  if(type==='EXODUS_SHIP')SFX.launch();
  notify(ut.icon+' '+ut.name+' deployed!');
  updateHUD();showCity(gCity(q,r));
}

// ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ
function showUnit(unit){
  const ut=UNITS[unit.type],hp=Math.max(0,unit.hp),hpPct=hp/ut.hp;
  const hpBar=hpPct>0.6?'bar-hp-hi':hpPct>0.3?'bar-hp-mid':'bar-hp-lo';
  const rank=unit.rank||0;
  const rb=rankBonus(unit);
  const fac=playerFaction;

  // Era colour theme
  const eraColors={MEDIEVAL:'dim',INDUSTRIAL:'gold',ATOMIC:'cyan',SPACE:'green',INTERSTELLAR:'purple'};
  const eraBdg=eraColors[ut.era]||'dim';
  const eraAccentMap={MEDIEVAL:'rgba(216,232,248,0.18)',INDUSTRIAL:'rgba(240,192,64,0.4)',ATOMIC:'rgba(64,216,255,0.4)',SPACE:'rgba(64,255,128,0.4)',INTERSTELLAR:'rgba(184,100,255,0.4)'};
  const eraAccent=eraAccentMap[ut.era]||'rgba(64,216,255,0.2)';
  const eraBgMap={MEDIEVAL:'rgba(216,232,248,0.04)',INDUSTRIAL:'rgba(240,192,64,0.06)',ATOMIC:'rgba(64,216,255,0.06)',SPACE:'rgba(64,255,128,0.06)',INTERSTELLAR:'rgba(184,100,255,0.06)'};
  const eraBg=eraBgMap[ut.era]||'transparent';

  // Status badges
  const badges=[
    `<span class="bdg ${eraBdg}">${ut.era}</span>`,
    ut.ranged?`<span class="bdg cyan">RANGED</span>`:`<span class="bdg dim">MELEE</span>`,
    unit.moved?`<span class="bdg red">EXHAUSTED</span>`:`<span class="bdg green">READY</span>`,
    unit.disabled?`<span class="bdg purple">DISABLED ${unit.disabled}T</span>`:'',
  ].join('');

  // Rank section
  const xpPct=rank<3?(unit.xp||0)/RANKS[Math.min(rank+1,3)].xpNeeded*100:100;
  const rankHtml=rank>0
    ?`<div class="rank-card"><span class="rank-stars">${RANKS[rank].stars}</span><div><div class="rank-name">${RANKS[rank].name}</div><div class="rank-xp-txt">${unit.xp} XP ¬∑ next at ${RANKS[Math.min(rank+1,3)].xpNeeded}</div></div></div>`
    :`<div class="bar-row"><div class="bar-labels"><span>XP</span><b>${unit.xp||0} / ${RANKS[1].xpNeeded}</b></div><div class="bar-track"><div class="bar-fill bar-xp" style="width:${xpPct}%"></div></div></div>`;

  // Upgrade / disband buttons
  const nextType=UPGRADE_PATH[unit.type];
  const nextUt=nextType&&nextType!==unit.type?UNITS[nextType]:null;
  const upgCost=nextUt?Math.max(1,Math.floor((nextUt.cost-ut.cost)*0.6)):0;
  const canUpg=nextUt&&(!nextUt.req||G.techs.has(nextUt.req))&&G.stars>=upgCost;
  const upgBtn=nextUt?`<button class="abtn2 ${canUpg?'cyan':'dim'}" onclick="upgradeUnit(G.selU)" ${canUpg?'':'disabled'}>‚¨Ü UPGRADE<small>${upgCost}üíé</small></button>`:'';
  const refund=Math.max(1,Math.floor(ut.cost*0.2));
  const disbBtn=`<button class="abtn2 red" onclick="disbandUnit(G.selU)">‚úï DISBAND<small>+${refund}üíé</small></button>`;

  // Special notes
  const notes=[
    unit.disabled?`<div class="inf special">üí´ Psychic link ‚Äî disabled for ${unit.disabled} more turns</div>`:'',
    ut.isExodus?`<div class="inf exodus">‚ú® Move to the Black Hole to WIN the game!</div>`:'',
    ut.benevolentOnly?`<div class="inf special">Wrath bonus: ${G.wrath>8?'+'+Math.floor(G.wrath/3)+' atk':'Needs Wrath > 8'}</div>`:'',
    unit.waypoint?`<div class="inf active">üìç Marching to (${unit.waypoint.q},${unit.waypoint.r})</div>`:`<div class="inf">Right-click map to set waypoint</div>`,
  ].join('');

  // Portrait canvas id
  const pid='uport_'+unit.id;

  const html=`
  <div class="p-sect" style="background:linear-gradient(180deg,${eraBg},transparent);border-bottom-color:${eraAccent}22;">
    <div class="portrait-row">
      <div class="portrait-box" style="border-color:${eraAccent};box-shadow:0 0 16px rgba(0,0,0,0.7),0 0 8px ${eraAccent.replace('0.4','0.15')} inset;">
        <canvas id="${pid}" width="62" height="62"></canvas>
      </div>
      <div class="portrait-title">
        <div class="portrait-name">${ut.name}</div>
        <div class="portrait-sub">${fac.name}</div>
        <div class="badge-row" style="margin-top:6px">${badges}</div>
      </div>
    </div>
    <div class="bar-row">
      <div class="bar-labels"><span>HEALTH</span><b>${hp} / ${ut.hp}</b></div>
      <div class="bar-track"><div class="bar-fill ${hpBar}" style="width:${hpPct*100}%"></div></div>
    </div>
    ${rankHtml}
  </div>
  <div class="p-sect">
    <div class="p-hdg"><span class="p-hdg-lbl cyan">COMBAT</span><span class="p-hdg-line cyan"></span></div>
    <div class="sg">
      <div class="sc atk">
        <div class="sc-lbl">‚öî Attack</div>
        <div class="sc-val">${ut.atk}${rb.atk>0?`<span class="b"> +${rb.atk}</span>`:''}</div>
      </div>
      <div class="sc def">
        <div class="sc-lbl">üõ° Defence</div>
        <div class="sc-val">${ut.def}${rb.def>0?`<span class="b"> +${rb.def}</span>`:''}</div>
      </div>
      <div class="sc mov">
        <div class="sc-lbl">üëü Move</div>
        <div class="sc-val">${ut.move}</div>
      </div>
      <div class="sc">
        <div class="sc-lbl">üéØ Range</div>
        <div class="sc-val">${ut.ranged?2:1}</div>
      </div>
    </div>
    <div class="act-row">${upgBtn}${disbBtn}</div>
    ${notes}
  </div>`;

  document.getElementById('sel-panel').innerHTML=html;
  if(isMobile())openMobSheet(html);

  // Draw portrait into canvas
  requestAnimationFrame(()=>{
    const pc=document.getElementById(pid);
    if(!pc||!fac)return;
    const pc2=pc.getContext('2d');
    pc2.clearRect(0,0,62,62);
    // Background ‚Äî faction radial
    const bg=pc2.createRadialGradient(31,31,0,31,31,36);
    bg.addColorStop(0,fac.cityColor+'55');bg.addColorStop(0.6,fac.cityColor+'1a');bg.addColorStop(1,'rgba(2,4,16,0.95)');
    pc2.fillStyle=bg;pc2.fillRect(0,0,62,62);
    // Corner glow
    const cg=pc2.createRadialGradient(8,8,0,8,8,22);
    cg.addColorStop(0,'rgba(255,255,255,0.08)');cg.addColorStop(1,'transparent');
    pc2.fillStyle=cg;pc2.fillRect(0,0,62,62);
    drawUnitIcon(pc2,unit.type,31,31,21,fac.cityColor,fac.cityLight);
  });
}

function showCity(city){
  if(!city)return;
  const fac=playerFaction||Object.values(FACTIONS)[0];
  const techReq={ARCHER:'ARCHERY',KNIGHT:'RIDING',CATAPULT:'SIEGE',RIFLEMAN:'GUNPOWDER',ARTILLERY:'STEEL',ENGINEER:'STEAM',TANK:'STEEL',JET:'AVIATION',PSYCHIC:'COMPUTING',ASTRONAUT:'ORBIT',LASER_TRP:'LASERS',AI_ROBOT:'AI_WEAPONS',COLONY_VEH:'COLONY_SHIP',EXODUS_SHIP:'EXODUS',LEVIATHAN:'DARK_ENERGY'};
  const btns=Object.entries(UNITS).map(([key,ut])=>{
    if(ut.greyOnly&&playerFaction.id!=='GREYS')return'';
    if(ut.benevolentOnly&&playerFaction.id!=='BENEVOLENT')return'';
    const reqOk=!ut.req||G.techs.has(ut.req);
    let cost=ut.cost;
    if(playerFaction.id==='COLLECTIVE')cost=Math.max(1,cost-1);
    if(playerFaction.id==='APEX'&&(key==='COLONY_VEH'||key==='EXODUS_SHIP'))cost=Math.max(1,cost-2);
    if(city.role==='FOUNDRY')cost=Math.max(1,cost-1);
    const can=reqOk&&G.stars>=cost&&!gUnit(city.q,city.r);
    const reqNote=ut.req&&!G.techs.has(ut.req)?` <span style="opacity:0.4;font-size:8px">¬∑${ut.req}</span>`:'';
    return`<button class="abtn${can?' hi':''}" onclick="doTrain('${city.q}','${city.r}','${key}')"${can?'':' disabled'}>${ut.icon} ${ut.name}${reqNote} <span style="opacity:0.45;font-size:8px;float:right">${cost}üíé</span></button>`;
  }).join('');
  const moonBtn=G.techs.has('MOONBASE')&&G.planet==='EARTH'?`<button class="sbtn" style="margin-top:10px;font-size:9px;width:100%;padding:7px" onclick="travelToPlanet('MOON')">üåï Travel to Moon</button>`:'';
  const marsBtn=G.techs.has('MARS_BASE')&&G.planet!=='MARS'?`<button class="sbtn" style="margin-top:6px;font-size:9px;width:100%;padding:7px" onclick="travelToPlanet('MARS')">üî¥ Travel to Mars</button>`:'';

  const income=city.lv+(city.role==='FOUNDRY'?2:0)+(G.wonders.has('ARC_REACTOR')?3:0);
  // Count adjacent resource bonus
  const adjRes=[[city.q,city.r],...hN(city.q,city.r)].reduce((sum,[rq,rr])=>{
    if(rq<0||rq>=GW||rr<0||rr>=GH)return sum;
    const res=TILE_RESOURCES[G.grid[rq][rr].terrain];
    return sum+(res?res.incomeBonus:0);
  },0);
  const incomeDisplay=income+adjRes;
  // Wonders panel
  const wonderHtml=Object.values(WONDERS).map(w=>{
    const built=G.wonders.has(w.id);
    const aiBuilt=G.aiPlayers&&G.aiPlayers.some(a=>a.wonders&&a.wonders.has(w.id));
    const claimed=built||aiBuilt;
    const hasReq=G.techs.has(w.req);
    const canAfford=G.stars>=w.cost;
    const canBuild=hasReq&&canAfford&&!claimed;
    let statusLabel='',statusColor='rgba(216,232,248,0.3)';
    if(built){statusLabel=' ‚úì';statusColor='var(--gold)';}
    else if(aiBuilt){statusLabel=' ‚úó';statusColor='var(--red)';}
    else if(!hasReq){statusLabel=' ¬∑ needs '+w.req;statusColor='rgba(216,232,248,0.18)';}
    return`<button onclick="${canBuild?`buildWonder('${w.id}')`:''}" ${canBuild?'':'disabled'} style="display:flex;align-items:center;gap:7px;width:100%;padding:7px 9px;margin-bottom:4px;border:1px solid ${built?'rgba(240,192,64,0.4)':canBuild?'rgba(64,216,255,0.22)':'rgba(64,216,255,0.06)'};background:${built?'rgba(240,192,64,0.07)':canBuild?'rgba(64,216,255,0.05)':'rgba(64,216,255,0.01)'};cursor:${canBuild?'pointer':'default'};border-radius:4px;text-align:left;transition:all 0.15s;min-height:40px;opacity:${claimed&&!built?0.4:1};">
      <span style="font-size:16px;flex-shrink:0">${w.icon}</span>
      <div style="flex:1;min-width:0">
        <div style="font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;color:${built?'var(--gold)':canBuild?'var(--parchment)':'rgba(216,232,248,0.38)'};">${w.name}<span style="color:${statusColor}">${statusLabel}</span></div>
        <div style="font-size:7px;color:rgba(216,232,248,0.3);margin-top:1px;line-height:1.3">${w.desc}</div>
      </div>
      ${canBuild?`<span style="font-family:Orbitron,monospace;font-size:8px;color:var(--gold);flex-shrink:0">${w.cost}üíé</span>`:''}
    </button>`;
  }).join('');

  // Specialisation panel
  let specHtml='';
  if(city.lv>=2){
    const roleHtml=Object.values(CITY_ROLES).map(role=>{
      const active=city.role===role.id;
      return`<button onclick="setSpecialisation('${city.q}','${city.r}','${role.id}')" style="display:flex;align-items:center;gap:7px;width:100%;padding:7px 9px;margin-bottom:4px;border:1px solid ${active?role.color+'99':'rgba(64,216,255,0.09)'};background:${active?role.color+'14':'rgba(64,216,255,0.02)'};color:${active?role.color:'rgba(216,232,248,0.6)'};cursor:pointer;border-radius:4px;font-size:9px;text-align:left;transition:all 0.15s;min-height:38px;">
        <span style="font-size:15px;flex-shrink:0">${role.icon}</span>
        <div style="flex:1"><div style="font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px">${role.name}${active?' ‚úì':''}</div><div style="font-size:7px;opacity:0.45;margin-top:1px;line-height:1.3">${role.desc}</div></div>
      </button>`;
    }).join('');
    specHtml=roleHtml;
  } else {
    specHtml=`<p style="font-size:7px;color:rgba(216,232,248,0.2);margin:4px 0 8px;font-style:italic">Reach Level 2 to unlock a specialisation</p>`;
  }

  const hpPct2=city.hp/city.maxHp;
  const hpBar2=hpPct2>0.6?'bar-hp-hi':hpPct2>0.3?'bar-hp-mid':'bar-hp-lo';

  const html=`
  <div class="p-sect" style="background:linear-gradient(180deg,rgba(64,216,255,0.03),transparent);">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <div style="width:44px;height:44px;border-radius:6px;border:1px solid ${fac.color}44;background:linear-gradient(135deg,${fac.cityColor}22,rgba(2,4,16,0.9));display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;">üè∞</div>
      <div style="flex:1;min-width:0">
        <div style="font-family:Orbitron,monospace;font-size:11px;font-weight:700;color:${fac.light};line-height:1.2">${city.name}${city.role?` <span style="font-size:12px">${CITY_ROLES[city.role].icon}</span>`:''}</div>
        <div style="font-size:8px;color:rgba(216,232,248,0.35);margin-top:3px">${fac.name} ¬∑ Level ${city.lv}</div>
      </div>
    </div>
    <div class="bar-row">
      <div class="bar-labels"><span>HP</span><b>${city.hp} / ${city.maxHp}</b></div>
      <div class="bar-track"><div class="bar-fill ${hpBar2}" style="width:${hpPct2*100}%"></div></div>
    </div>
    <div class="bar-row">
      <div class="bar-labels"><span>POPULATION</span><b>${Math.floor(city.pop)} / ${city.maxPop}</b></div>
      <div class="bar-track"><div class="bar-fill bar-pop" style="width:${city.pop/city.maxPop*100}%"></div></div>
    </div>
    <div class="sg three" style="margin-top:8px">
      <div class="sc"><div class="sc-lbl">Level</div><div class="sc-val">${city.lv}</div></div>
      <div class="sc"><div class="sc-lbl">Income</div><div class="sc-val" style="color:var(--gold)">${incomeDisplay}üíé${adjRes>0?`<span class="b"> +${adjRes}</span>`:''}</div></div>
      <div class="sc"><div class="sc-lbl">Credits</div><div class="sc-val">${G.stars}</div></div>
    </div>
  </div>
  <div class="p-sect">
    <div class="p-hdg"><span class="p-hdg-lbl gold">SPECIALISE</span><span class="p-hdg-line gold"></span></div>
    ${specHtml}
  </div>
  <div class="p-sect">
    <div class="p-hdg"><span class="p-hdg-lbl purple">WONDERS</span><span class="p-hdg-line purple"></span></div>
    ${wonderHtml}
  </div>
  <div class="p-sect">
    <div class="p-hdg"><span class="p-hdg-lbl cyan">DEPLOY UNIT</span><span class="p-hdg-line cyan"></span></div>
    <div class="deploy-list">${btns}</div>
    ${moonBtn}${marsBtn}
  </div>`;
  document.getElementById('sel-panel').innerHTML=html;
  if(isMobile())openMobSheet(html);
}

function showTile(q,r){
  const fog=G.fog[q][r];
  if(fog==='hidden'){const html=`<p style="color:rgba(216,232,248,0.2);font-size:10px;font-style:italic;margin-top:16px;text-align:center">Uncharted territory</p>`;document.getElementById('sel-panel').innerHTML=html;if(isMobile())openMobSheet(html);return;}
  const t=G.grid[q][r].terrain;
  const isBH=G.blackHole&&q===G.blackHole.q&&r===G.blackHole.r;
  const bhHtml=isBH?`<div style="margin-top:8px;padding:8px;border:1px solid rgba(150,80,255,0.4);background:rgba(80,0,140,0.12);border-radius:3px"><div style="font-family:Orbitron,monospace;font-size:8px;color:#b864ff;letter-spacing:1px">‚ö´ BLACK HOLE</div><p style="font-size:8px;color:rgba(216,232,248,0.5);margin-top:3px">Move an Exodus Ship here to WIN the game and send humanity to a new galaxy.</p></div>`:'';
  const res=TILE_RESOURCES[t];
  const resHtml=res?`<div style="display:flex;align-items:center;gap:8px;margin-top:8px;padding:7px 10px;border:1px solid rgba(240,192,64,0.3);border-radius:4px;background:rgba(240,192,64,0.06);">
    <span style="font-size:18px">${res.icon}</span>
    <div><div style="font-family:Orbitron,monospace;font-size:8px;color:var(--gold);letter-spacing:1px">${res.label}</div>
    <div style="font-size:8px;color:rgba(216,232,248,0.5);margin-top:1px">${res.bonus} to adjacent city</div></div>
  </div>`:'';
  const html=`<h3 style="font-family:Orbitron,monospace;font-size:11px;color:var(--cyan);margin-bottom:7px">${TICON[t]} ${TNAME[t]}</h3><div class="igrid"><div class="ic"><div class="icl">Passable</div><div class="icv">${PASS[t]?'Yes':'No'}</div></div><div class="ic"><div class="icl">Coords</div><div class="icv">${q},${r}</div></div></div>${fog==='fog'?'<p style="font-size:8px;color:rgba(216,232,248,0.22);margin-top:5px;font-style:italic">Last seen ‚Äî unexplored</p>':''}${resHtml}${bhHtml}`;
  document.getElementById('sel-panel').innerHTML=html;
  if(isMobile())openMobSheet(html);
}

function updateSel(){if(G.selU)showUnit(G.selU);else if(G.sel){const c=gCity(G.sel.q,G.sel.r);if(c&&c.owner==='player')showCity(c);else showTile(G.sel.q,G.sel.r);}renderTechs();}
// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
function updateHUD(){
  document.getElementById('h-score').textContent=G.score;
  document.getElementById('h-stars').textContent=G.stars;
  document.getElementById('h-cities').textContent=G.cities.filter(c=>c.owner==='player').length;
  document.getElementById('h-units').textContent=G.units.filter(u=>u.owner==='player').length;
  const mtb=document.getElementById('mob-turn-badge');if(mtb)mtb.textContent='T'+G.turn;
  // Pulse End Turn button when it's the player's turn
  const eb=document.getElementById('endbtn');
  if(eb)eb.classList.toggle('ready',G.phase==='player');
  renderTechs();
}
let _nt2;
function notify(msg,type){
  const el=document.getElementById('notif');el.textContent=msg;
  el.className='on'+(type?' '+type:'');
  clearTimeout(_nt2);_nt2=setTimeout(()=>el.className='',2500);
  setMsg(msg);
}
function setMsg(m){const mb=document.getElementById('msgbar');if(mb)mb.textContent=m;}

// ‚îÄ‚îÄ PLANET TRAVEL ‚îÄ‚îÄ
function travelToPlanet(planet){
  if(planet==='MOON'&&!G.techs.has('MOONBASE')){notify('Research Moon Base tech first!','warn');return;}
  if(planet==='MARS'&&!G.techs.has('MARS_BASE')){notify('Research Mars Base tech first!','warn');return;}
  showOv();
  document.getElementById('ov-content').innerHTML=`
    <h1 style="font-size:28px">${planet==='MOON'?'üåï':'üî¥'} TRAVEL TO ${planet}</h1>
    <div class="ov-sub">${planet==='MOON'?'LUNAR EXPEDITION':'MARTIAN COLONISATION'}</div>
    <p class="ov-desc">Your colony ships will carry your empire's knowledge and armies to ${planet==='MOON'?'the Moon':'Mars'}. Cities and units stay behind on ${G.planet.charAt(0)+G.planet.slice(1).toLowerCase()} ‚Äî a new map awaits. Your technology and score carry forward.</p>
    <p class="ov-desc" style="color:var(--gold)">Score: ${G.score} | Tech count: ${G.techs.size} | Turn: ${G.turn}</p>
    <div style="display:flex;gap:12px;justify-content:center;margin-top:16px">
      <button class="sbtn" onclick="hideOv()">‚Üê Stay on ${G.planet.charAt(0)+G.planet.slice(1).toLowerCase()}</button>
      <button class="sbtn gbtn" onclick="doTravelToPlanet('${planet}')">üöÄ Launch Expedition!</button>
    </div>`;
}

function doTravelToPlanet(planet){
  hideOv();
  SFX.launch();
  notify('üöÄ Launching expedition to '+planet+'!','gold');
  const savedScore=G.score,savedTechs=new Set(G.techs),savedTurn=G.turn,savedFactionId=G.factionId,savedAI=G.aiPlayers.map(a=>({factionId:a.factionId,personality:Object.keys(AI_PERSONALITIES).find(k=>AI_PERSONALITIES[k]===a.personality)||'TACTICIAN'}));
  setTimeout(()=>{
    initGame(savedFactionId,savedAI,planet);
    G.score=savedScore;G.techs=savedTechs;G.turn=savedTurn;G.stars+=20;
    updateEra();updateHUD();
    MUSIC.setPlanet(planet==='MOON'?'moon':'mars');
    setMsg('You have arrived at '+planet+'. Establish your new base!');
  },600);
}

function showPlanetOverview(){
  showOv();
  const earthUnlocked=true;
  const moonUnlocked=G.techs&&G.techs.has('MOONBASE');
  const marsUnlocked=G.techs&&G.techs.has('MARS_BASE');
  document.getElementById('ov-content').innerHTML=`
    <h1 style="font-size:26px">üåå PLANETARY MAP</h1>
    <div class="ov-sub">THE PATH TO THE STARS</div>
    <p class="ov-desc">Conquer each world to advance your empire. Research the required technologies to unlock new planets.</p>
    <div class="planet-map">
      <div class="planet-card ${G.planet==='EARTH'?'active':''}" onclick="${earthUnlocked?`hideOv()`:''}">
        <div style="font-size:40px;margin-bottom:8px">üåç</div>
        <div style="font-family:Orbitron,monospace;font-size:11px;color:var(--cyan)">EARTH</div>
        <div style="font-size:9px;color:rgba(216,232,248,0.5);margin-top:4px">Origin world</div>
        <div style="font-size:8px;color:var(--green);margin-top:4px">${G.planet==='EARTH'?'‚ñ∂ CURRENT':''}${earthUnlocked&&G.planet!=='EARTH'?'Travel available':''}</div>
      </div>
      <div style="font-size:20px;color:rgba(64,216,255,0.3);align-self:center">‚Üí</div>
      <div class="planet-card ${G.planet==='MOON'?'active':''} ${moonUnlocked?'':'locked'}" onclick="${moonUnlocked?`travelToPlanet('MOON');hideOv()`:''}">
        <div style="font-size:40px;margin-bottom:8px">üåï</div>
        <div style="font-family:Orbitron,monospace;font-size:11px;color:var(--cyan)">MOON</div>
        <div style="font-size:9px;color:rgba(216,232,248,0.5);margin-top:4px">Low gravity frontier</div>
        <div style="font-size:8px;margin-top:4px;color:${moonUnlocked?'var(--green)':'var(--red)'}">${moonUnlocked?(G.planet==='MOON'?'‚ñ∂ CURRENT':'Travel ready'):'üîí Requires: Moon Base tech'}</div>
      </div>
      <div style="font-size:20px;color:rgba(64,216,255,0.3);align-self:center">‚Üí</div>
      <div class="planet-card ${G.planet==='MARS'?'active':''} ${marsUnlocked?'':'locked'}" onclick="${marsUnlocked?`travelToPlanet('MARS');hideOv()`:''}">
        <div style="font-size:40px;margin-bottom:8px">üî¥</div>
        <div style="font-family:Orbitron,monospace;font-size:11px;color:var(--cyan)">MARS</div>
        <div style="font-size:9px;color:rgba(216,232,248,0.5);margin-top:4px">Final frontier</div>
        <div style="font-size:8px;margin-top:4px;color:${marsUnlocked?'var(--green)':'var(--red)'}">${marsUnlocked?(G.planet==='MARS'?'‚ñ∂ CURRENT':'Travel ready'):'üîí Requires: Mars Base tech'}</div>
      </div>
      <div style="font-size:20px;color:rgba(150,80,255,0.6);align-self:center">‚Üí‚Üí</div>
      <div class="planet-card ${G.techs&&G.techs.has('EXODUS')?'active':'locked'}">
        <div style="font-size:40px;margin-bottom:8px">‚ö´</div>
        <div style="font-family:Orbitron,monospace;font-size:11px;color:#b864ff">BLACK HOLE</div>
        <div style="font-size:9px;color:rgba(216,232,248,0.5);margin-top:4px">Gateway to eternity</div>
        <div style="font-size:8px;margin-top:4px;color:${G.techs&&G.techs.has('EXODUS')?'var(--gold)':'var(--red)'}">${G.techs&&G.techs.has('EXODUS')?'‚ú® Send Exodus Ship!':'üîí Requires: Exodus Drive'}</div>
      </div>
    </div>
    <button class="sbtn" onclick="hideOv()">‚Üê Back to Game</button>`;
}

function loadSpeedLB(){try{return JSON.parse(localStorage.getItem('farreach_speed')||'[]');}catch(e){return[];}}
function saveSpeedLB(entry){try{const lb=loadSpeedLB();lb.push(entry);lb.sort((a,b)=>a.turns-b.turns);localStorage.setItem('farreach_speed',JSON.stringify(lb.slice(0,10)));}catch(e){}}
function renderSpeedLB(lb){
  if(!lb.length)return'<div style="text-align:center;color:rgba(216,232,248,0.22);padding:12px;font-size:10px;font-style:italic">No speed records yet ‚Äî win a game to set one</div>';
  return lb.map((e,i)=>`<div class="lb-row">
    <div class="lb-rank" style="color:${i===0?'#ffd700':i===1?'#c0c0c0':i===2?'#cd7f32':'rgba(240,192,64,0.5)'}">#${i+1}</div>
    <div class="lb-name">${e.faction||'?'} ${e.name||'Commander'}</div>
    <div class="lb-score" style="color:var(--green)">${e.turns}t</div>
    <div class="lb-meta">${e.difficulty||''} ¬∑ ${e.date||''}</div>
  </div>`).join('');
}

// ‚îÄ‚îÄ END SCREEN ‚îÄ‚îÄ
function endScreen(won, reason, newAchievements){
  const elapsed=Math.floor((Date.now()-G.startTime)/60000);
  const rivals=(G.aiPlayers||[]).map(a=>FACTIONS[a.factionId].icon+' '+FACTIONS[a.factionId].name).join(', ')||'The AI';
  if(won)SFX.victory();else SFX.defeat();
  MUSIC.stop();
  const lbEntry={score:G.score,name:playerFaction.name,faction:playerFaction.icon,turns:G.turn,planet:G.planet,era:G.era,date:new Date().toLocaleDateString(),difficulty:AI_DIFFICULTY[globalDifficulty]?.label||''};
  saveLB(lbEntry);
  if(won){
    saveSpeedLB(lbEntry);
    if(isDailyChallenge)markDailyPlayed();
  }

  // ‚îÄ‚îÄ CINEMATIC PHASE ‚îÄ‚îÄ
  showOv();
  const cinEl=document.getElementById('ov-content');
  const fac=playerFaction;
  const victoryLines=won?[
    reason.includes('Exodus')?'‚ú® THE EXODUS SHIP TEARS THROUGH':'‚öîÔ∏è THE LAST RIVAL FALLS',
    fac.icon+' '+fac.name.toUpperCase()+' STANDS TRIUMPHANT',
    'THE STARS ARE YOURS',
  ]:[
    'üíÄ YOUR EMPIRE CRUMBLES',
    fac.icon+' '+fac.name.toUpperCase()+' IS DEFEATED',
    'THE DARKNESS CLOSES IN',
  ];

  const cinColor=won?fac.color:'#ff2020';
  const cinGlow=won?fac.light:'#ff6060';

  cinEl.innerHTML=`
    <div id="cin-wrap" style="min-height:60vh;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;">
      <canvas id="cin-cvs" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;opacity:0.7"></canvas>
      <div id="cin-line0" style="font-family:Orbitron,monospace;font-size:10px;letter-spacing:6px;color:${cinGlow};opacity:0;margin-bottom:18px;transition:opacity 0.8s;text-shadow:0 0 20px ${cinColor}">${victoryLines[0]}</div>
      <div id="cin-line1" style="font-family:Orbitron,monospace;font-size:${won?28:22}px;font-weight:900;letter-spacing:4px;color:${won?'var(--gold)':'var(--red)'};opacity:0;margin-bottom:12px;transition:opacity 0.8s;text-shadow:0 0 40px ${cinColor}88">${victoryLines[1]}</div>
      <div id="cin-line2" style="font-family:Orbitron,monospace;font-size:12px;letter-spacing:8px;color:${cinGlow};opacity:0;margin-bottom:32px;transition:opacity 0.8s;text-shadow:0 0 16px ${cinColor}66">${victoryLines[2]}</div>
      <div id="cin-skip" style="opacity:0;transition:opacity 1s;font-size:8px;color:rgba(216,232,248,0.3);letter-spacing:2px;cursor:pointer;font-family:Orbitron,monospace;border:1px solid rgba(216,232,248,0.12);padding:6px 16px;border-radius:2px;" onclick="showEndResults(${won},'${reason.replace(/'/g,"\\'")}',${JSON.stringify(newAchievements||[]).replace(/</g,'\\u003c')})">‚ñ∂ SKIP</div>
    </div>`;

  // Particle canvas
  const cc=document.getElementById('cin-cvs');
  const cw=cc.parentElement.offsetWidth||400;
  const ch=cc.parentElement.offsetHeight||360;
  cc.width=cw;cc.height=ch;
  const cx2=cc.getContext('2d');
  const particles=[];
  const pCount=won?80:50;
  for(let i=0;i<pCount;i++){
    particles.push({
      x:Math.random()*cw,y:won?ch+Math.random()*60:Math.random()*ch,
      vx:(Math.random()-0.5)*(won?1.2:0.6),
      vy:won?-(1.5+Math.random()*2):(0.3+Math.random()*1.2),
      size:won?(1.5+Math.random()*3):(1+Math.random()*2),
      alpha:Math.random(),
      color:won?(Math.random()<0.5?cinColor:cinGlow):'#ff4444',
      life:1,decay:0.004+Math.random()*0.006,
    });
  }
  let cinFrame=0;
  function animCin(){
    cx2.clearRect(0,0,cw,ch);
    // Background pulse
    if(won){
      const bg=cx2.createRadialGradient(cw/2,ch/2,0,cw/2,ch/2,cw*0.7);
      bg.addColorStop(0,cinColor+'12');bg.addColorStop(1,'transparent');
      cx2.fillStyle=bg;cx2.fillRect(0,0,cw,ch);
    } else {
      cx2.fillStyle='rgba(40,0,0,'+(0.04+Math.sin(cinFrame*0.05)*0.02)+')';
      cx2.fillRect(0,0,cw,ch);
    }
    particles.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;p.life-=p.decay;p.alpha=p.life;
      if(p.y<-10||p.life<=0){
        p.x=Math.random()*cw;p.y=won?ch+10:-10;p.life=0.8+Math.random()*0.2;p.vy=won?-(1.5+Math.random()*2):(0.3+Math.random()*1.2);
      }
      cx2.globalAlpha=Math.max(0,p.alpha*0.7);
      cx2.fillStyle=p.color;
      cx2.beginPath();cx2.arc(p.x,p.y,p.size,0,Math.PI*2);cx2.fill();
    });
    cx2.globalAlpha=1;
    cinFrame++;
    if(cinFrame<220)requestAnimationFrame(animCin);
  }
  animCin();

  // Staggered text reveals
  setTimeout(()=>{const e=document.getElementById('cin-line0');if(e)e.style.opacity='1';},200);
  setTimeout(()=>{const e=document.getElementById('cin-line1');if(e)e.style.opacity='1';},700);
  setTimeout(()=>{const e=document.getElementById('cin-line2');if(e)e.style.opacity='1';},1300);
  setTimeout(()=>{const e=document.getElementById('cin-skip');if(e)e.style.opacity='1';},1600);
  // Auto-advance after 3.8s
  setTimeout(()=>showEndResults(won,reason,newAchievements||[]),3800);
}

function showEndResults(won, reason, newAchievements){
  // Guard against double-call (skip + timer)
  if(document.getElementById('end-tab-content'))return;
  const elapsed=Math.floor((Date.now()-G.startTime)/60000);
  const rivals=(G.aiPlayers||[]).map(a=>FACTIONS[a.factionId].icon+' '+FACTIONS[a.factionId].name).join(', ')||'The AI';
  const newAchHtml=(newAchievements||[]).length?`
    <div style="margin:0 0 14px;padding:10px 12px;border:1px solid rgba(240,192,64,0.25);border-radius:6px;background:rgba(240,192,64,0.04);">
      <div style="font-family:Orbitron,monospace;font-size:7px;letter-spacing:3px;color:var(--gold);margin-bottom:8px;text-align:center;">üèÜ ACHIEVEMENTS UNLOCKED</div>
      ${(newAchievements||[]).map(a=>`<div style="display:flex;align-items:center;gap:10px;padding:5px 0;border-bottom:1px solid rgba(240,192,64,0.08);">
        <span style="font-size:22px">${a.icon}</span>
        <div><div style="font-family:Orbitron,monospace;font-size:9px;color:var(--gold);letter-spacing:1px">${a.name}</div>
        <div style="font-size:8px;color:rgba(216,232,248,0.45);margin-top:2px">${a.desc}</div></div>
      </div>`).join('')}
    </div>`:'';
  document.getElementById('ov-content').innerHTML=`
    <h1 style="font-size:${won?34:28}px;color:${won?'var(--gold)':'var(--red)'};margin-bottom:6px">${won?'‚ú® VICTORY':'üíÄ DEFEAT'}</h1>
    <div class="ov-sub" style="color:${won?'var(--gold-lt)':'var(--red)'};margin-bottom:10px">${won?'HUMANITY ASCENDS':'EMPIRE FALLEN'}</div>
    <p class="ov-desc" style="margin-bottom:4px">${reason||''}</p>
    <p style="font-size:9px;color:rgba(216,232,248,0.3);font-style:italic;margin-bottom:14px">${playerFaction.icon} ${playerFaction.name} vs ${rivals}</p>

    <div class="end-stats">
      <div class="es-cell"><span class="es-val" style="color:${won?'var(--gold)':'var(--cyan)'}">${G.score.toLocaleString()}</span><span class="es-lbl">Score</span></div>
      <div class="es-cell"><span class="es-val">${G.turn}</span><span class="es-lbl">Turns</span></div>
      <div class="es-cell"><span class="es-val">${elapsed}m</span><span class="es-lbl">Time</span></div>
      <div class="es-cell"><span class="es-val">${G.unitsKilled}</span><span class="es-lbl">Slain</span></div>
      <div class="es-cell"><span class="es-val">${G.citiesCaptured}</span><span class="es-lbl">Captured</span></div>
      <div class="es-cell"><span class="es-val">${G.techs.size}</span><span class="es-lbl">Techs</span></div>
    </div>

    ${newAchHtml}

    ${won?`<button onclick="shareScore()" style="width:100%;padding:14px;margin-bottom:14px;background:linear-gradient(135deg,rgba(64,216,255,0.14),rgba(64,216,255,0.05));border:2px solid var(--cyan);color:var(--cyan);font-family:Orbitron,monospace;font-size:11px;letter-spacing:3px;cursor:pointer;border-radius:5px;transition:all 0.2s;min-height:48px;box-shadow:0 0 18px rgba(64,216,255,0.12);" onmouseover="this.style.boxShadow='0 0 28px rgba(64,216,255,0.3)';this.style.background='rgba(64,216,255,0.18)'" onmouseout="this.style.boxShadow='0 0 18px rgba(64,216,255,0.12)';this.style.background='linear-gradient(135deg,rgba(64,216,255,0.14),rgba(64,216,255,0.05))'">
      üì§ SHARE YOUR RESULT
    </button>`:''}

    <div style="display:flex;gap:0;margin-bottom:0;border-radius:4px 4px 0 0;overflow:hidden;border:1px solid rgba(64,216,255,0.12);border-bottom:none;">
      <button id="tab-score" onclick="switchEndTab('score')" style="flex:1;padding:8px 0;font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;cursor:pointer;border:none;border-right:1px solid rgba(64,216,255,0.1);background:rgba(64,216,255,0.1);color:var(--cyan);min-height:36px;">üèÜ SCORES</button>
      <button id="tab-speed" onclick="switchEndTab('speed')" style="flex:1;padding:8px 0;font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;cursor:pointer;border:none;border-right:1px solid rgba(64,216,255,0.1);background:transparent;color:rgba(216,232,248,0.4);min-height:36px;">‚ö° SPEED</button>
      <button id="tab-ach" onclick="switchEndTab('ach')" style="flex:1;padding:8px 0;font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;cursor:pointer;border:none;background:transparent;color:rgba(216,232,248,0.4);min-height:36px;">üéñ MEDALS</button>
    </div>
    <div id="end-tab-content" style="border:1px solid rgba(64,216,255,0.12);border-radius:0 0 4px 4px;max-height:140px;overflow-y:auto;scrollbar-width:thin;background:rgba(4,8,20,0.6);margin-bottom:14px;">
      ${renderLB(loadLB().slice(0,5))}
    </div>

    <div class="end-btns">
      <button class="sbtn" onclick="showPickScreen()">New Game</button>
      <button class="sbtn gbtn" onclick="hideOv()">View Board</button>
    </div>`;
}

function switchEndTab(tab){
  ['score','speed','ach'].forEach(t=>{
    const btn=document.getElementById('tab-'+t);
    if(!btn)return;
    const active=t===tab;
    btn.style.background=active?'rgba(64,216,255,0.1)':'transparent';
    btn.style.color=active?'var(--cyan)':'rgba(216,232,248,0.4)';
  });
  const c=document.getElementById('end-tab-content');if(!c)return;
  if(tab==='score')c.innerHTML=renderLB(loadLB().slice(0,5));
  else if(tab==='speed')c.innerHTML=renderSpeedLB(loadSpeedLB().slice(0,5));
  else c.innerHTML=renderAchievementsPanel();
}

let pickedFaction=null,setupAICount=1;

// ‚îÄ‚îÄ PICK SCREEN ‚îÄ‚îÄ
// ‚îÄ‚îÄ SCENARIOS ‚îÄ‚îÄ
const SCENARIOS={
  LAST_STAND:{
    id:'LAST_STAND',icon:'‚öîÔ∏è',name:'Last Stand',
    planet:'EARTH',
    tagline:'Outnumbered. Outgunned. Not outmatched.',
    desc:'Your empire is on the brink. Three rivals have already established industrial powers while you scramble to hold a single city. Survive, then conquer.',
    difficulty:'HARD',
    playerSetup:{stars:15,cityLv:2,extraTechs:['FARMING','MINING','SMITHING','ARCHERY'],extraUnits:['WARRIOR','ARCHER','KNIGHT']},
    aiSetup:[
      {factionId:'GREYS',    personality:'RUSHER',     bonusTechs:['FARMING','MINING','SMITHING','GUNPOWDER','STEAM'],bonusCities:1,bonusStars:20},
      {factionId:'APEX',     personality:'TACTICIAN',  bonusTechs:['FARMING','MINING','SMITHING','GUNPOWDER','STEAM'],bonusCities:1,bonusStars:20},
      {factionId:'VOID',     personality:'BERSERKER',  bonusTechs:['FARMING','MINING','SMITHING','GUNPOWDER'],bonusCities:1,bonusStars:18},
    ],
  },
  SPACE_RACE:{
    id:'SPACE_RACE',icon:'üöÄ',name:'Space Race',
    planet:'EARTH',
    tagline:'The galaxy awaits. Everyone knows it.',
    desc:'All factions begin in the Space Age with full technology. One mission: launch the Exodus Ship through the Black Hole before your rivals do.',
    difficulty:'NORMAL',
    playerSetup:{stars:60,cityLv:3,extraTechs:['FARMING','MINING','SMITHING','ARCHERY','RIDING','SIEGE','GUNPOWDER','STEAM','STEEL','MEDICINE','ELECTRICITY','NUCLEAR','RADAR','AVIATION','COMPUTING','ROCKETRY','ORBIT','LIFE_SUPPORT','AI_WEAPONS','LASERS'],extraUnits:['ASTRONAUT','AI_ROBOT']},
    aiSetup:[
      {factionId:'BENEVOLENT',personality:'RESEARCHER',bonusTechs:['FARMING','MINING','SMITHING','ARCHERY','RIDING','SIEGE','GUNPOWDER','STEAM','STEEL','MEDICINE','ELECTRICITY','NUCLEAR','RADAR','AVIATION','COMPUTING','ROCKETRY','ORBIT','LIFE_SUPPORT','AI_WEAPONS','LASERS'],bonusCities:1,bonusStars:60},
      {factionId:'NOMADS',   personality:'TACTICIAN',  bonusTechs:['FARMING','MINING','SMITHING','ARCHERY','RIDING','SIEGE','GUNPOWDER','STEAM','STEEL','MEDICINE','ELECTRICITY','NUCLEAR','RADAR','AVIATION','COMPUTING','ROCKETRY','ORBIT','LIFE_SUPPORT','AI_WEAPONS','LASERS'],bonusCities:1,bonusStars:60},
    ],
  },
  FRESH_WORLD:{
    id:'FRESH_WORLD',icon:'üåã',name:'Fresh World',
    planet:'EARTH',
    tagline:'No city. No throne. Just will.',
    desc:'You awaken on a new world with nothing but a warrior and a dream. Your first task: seize a city. Your rivals started yesterday.',
    difficulty:'NORMAL',
    playerSetup:{stars:5,cityLv:0,extraTechs:[],extraUnits:[]},
    aiSetup:[
      {factionId:'APEX',     personality:'BUILDER',   bonusTechs:['FARMING','MINING'],bonusCities:0,bonusStars:12},
      {factionId:'VOID',     personality:'TACTICIAN', bonusTechs:['FARMING'],bonusCities:0,bonusStars:10},
    ],
  },
};

function showScenariosScreen(){
  const cards=Object.values(SCENARIOS).map(sc=>{
    const diffColor=sc.difficulty==='HARD'?'var(--red)':sc.difficulty==='EASY'?'var(--green)':'var(--cyan)';
    return`<div style="border:1px solid rgba(64,216,255,0.15);border-radius:8px;padding:16px;margin-bottom:12px;background:rgba(4,8,24,0.7);cursor:pointer;transition:all 0.2s;" onclick="launchScenario('${sc.id}')" onmouseover="this.style.borderColor='rgba(64,216,255,0.4)';this.style.background='rgba(64,216,255,0.06)'" onmouseout="this.style.borderColor='rgba(64,216,255,0.15)';this.style.background='rgba(4,8,24,0.7)'">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <span style="font-size:28px">${sc.icon}</span>
        <div>
          <div style="font-family:Orbitron,monospace;font-size:12px;letter-spacing:2px;color:var(--cyan)">${sc.name}</div>
          <div style="font-size:9px;color:rgba(216,232,248,0.45);margin-top:2px;font-style:italic">${sc.tagline}</div>
        </div>
        <div style="margin-left:auto;font-family:Orbitron,monospace;font-size:7px;letter-spacing:1px;color:${diffColor};border:1px solid ${diffColor}44;padding:3px 8px;border-radius:2px;">${sc.difficulty}</div>
      </div>
      <p style="font-size:9px;color:rgba(216,232,248,0.55);margin:0 0 10px;line-height:1.5">${sc.desc}</p>
      <div style="font-family:Orbitron,monospace;font-size:8px;color:rgba(64,216,255,0.7);letter-spacing:1px;">‚ñ∂ LAUNCH SCENARIO</div>
    </div>`;
  }).join('');

  document.getElementById('ov-content').innerHTML=`
    <h1 style="font-size:24px;letter-spacing:4px">SCENARIOS</h1>
    <div class="ov-sub">HAND-CRAFTED CHALLENGES</div>
    <p class="ov-desc" style="margin-bottom:18px">Each scenario drops you into a unique situation with specific starting conditions and goals.</p>
    ${cards}
    <button class="sbtn" onclick="showPickScreen()" style="font-size:9px;border-color:rgba(64,216,255,0.3);color:rgba(216,232,248,0.5);margin-top:4px;">‚Üê Back</button>`;
}

function launchScenario(scId){
  const sc=SCENARIOS[scId];if(!sc)return;
  // Use first non-player faction for player if no faction picked yet ‚Äî pick a dramatic one
  const playerFacId=sc.id==='LAST_STAND'?'COLLECTIVE':sc.id==='SPACE_RACE'?'APEX':sc.id==='FRESH_WORLD'?'NOMADS':'COLLECTIVE';
  const aiSetupBase=sc.aiSetup.map(a=>({factionId:a.factionId,personality:a.personality}));

  // Override difficulty for scenario
  const prevDiff=globalDifficulty;
  globalDifficulty=sc.difficulty||'NORMAL';

  initGame(playerFacId,aiSetupBase,sc.planet);

  // Apply player setup
  const ps=sc.playerSetup;
  G.stars=ps.stars;
  ps.extraTechs.forEach(t=>G.techs.add(t));
  if(ps.cityLv===0){
    // Remove player city ‚Äî true nomad start
    G.cities=G.cities.filter(c=>c.owner!=='player');
  } else if(ps.cityLv>1){
    const pc=G.cities.find(c=>c.owner==='player');
    if(pc){pc.lv=ps.cityLv;pc.maxPop=pc.lv*5;pc.maxHp=20+ps.cityLv*5;pc.hp=pc.maxHp;}
  }
  // Add extra player units
  const pStart=G.units.find(u=>u.owner==='player');
  const baseQ=pStart?pStart.q:Math.floor(GW/4),baseR=pStart?pStart.r:Math.floor(GH/2);
  ps.extraUnits.forEach((type,i)=>{
    const offsets=[[0,2],[1,1],[-1,1],[0,-2],[1,-1]];
    const[dq,dr]=offsets[i%offsets.length];
    const eq=Math.max(0,Math.min(GW-1,baseQ+dq)),er=Math.max(0,Math.min(GH-1,baseR+dr));
    if(!gUnit(eq,er))G.units.push({id:G.nextId++,q:eq,r:er,owner:'player',type,hp:UNITS[type].hp,moved:false,attacked:false,xp:0,rank:0});
  });

  // Apply AI setups
  sc.aiSetup.forEach((aiSc,i)=>{
    const ai=G.aiPlayers[i];if(!ai)return;
    aiSc.bonusTechs.forEach(t=>ai.techs.add(t));
    ai.stars+=aiSc.bonusStars||0;
    // Spawn extra AI cities
    for(let c2=0;c2<(aiSc.bonusCities||0);c2++){
      const aiCity=G.cities.find(cc=>cc.owner===ai.id);
      if(aiCity){
        const offQ=aiCity.q+(Math.random()<0.5?-3:3),offR=aiCity.r+(Math.random()<0.5?-2:2);
        const nq=Math.max(1,Math.min(GW-2,Math.round(offQ))),nr=Math.max(1,Math.min(GH-2,Math.round(offR)));
        if(!gCity(nq,nr)&&G.grid[nq][nr].terrain!==T.OCEAN&&G.grid[nq][nr].terrain!==T.MOUNTAIN){
          G.cities.push({q:nq,r:nr,owner:ai.id,name:ai.faction.name.split(' ')[0]+' Colony',lv:1,pop:0,maxPop:5,hp:20,maxHp:20});
        }
      }
    }
  });

  updateEra();updateHUD();
  hideOv();
  // Scenario banner
  setTimeout(()=>notify(sc.icon+' '+sc.name.toUpperCase()+' ‚Äî '+sc.tagline,'gold'),400);
  globalDifficulty=sc.id==='LAST_STAND'?'HARD':prevDiff;
}

function showPickScreen(){
  pickedFaction=null;window._aiSlots=null;
  showOv();
  const lb=loadLB();
  const earned=loadAchievements();
  const dailyDone=hasDailyBeenPlayed();
  const streak=getDailyStreak();
  const lbHtml=lb.length?`
    <div style="margin-bottom:16px;text-align:left;border:1px solid rgba(240,192,64,0.12);border-radius:6px;overflow:hidden;background:rgba(240,192,64,0.02);">
      <div style="font-family:Orbitron,monospace;font-size:7px;letter-spacing:3px;color:var(--gold);padding:8px 12px;border-bottom:1px solid rgba(240,192,64,0.08);text-align:center;">‚Äî HALL OF FAME ‚Äî</div>
      <div style="max-height:88px;overflow-y:auto;scrollbar-width:thin">${renderLB(lb.slice(0,5))}</div>
    </div>`:'';

  document.getElementById('ov-content').innerHTML=`
    <div style="margin-bottom:4px;font-size:26px;letter-spacing:3px;opacity:0.15;color:var(--cyan)">‚ú¶ ‚ú¶ ‚ú¶</div>
    <h1>FAR REACH</h1>
    <div class="ov-sub">FROM CASTLE TO THE STARS</div>

    <!-- Daily Challenge card ‚Äî most prominent engagement hook -->
    <div style="margin-bottom:16px;border-radius:8px;overflow:hidden;border:1.5px solid ${dailyDone?'rgba(64,255,128,0.3)':'rgba(240,192,64,0.4)'};background:linear-gradient(135deg,${dailyDone?'rgba(64,255,128,0.05)':'rgba(240,192,64,0.06)'},rgba(2,4,16,0.6));">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;gap:12px;flex-wrap:wrap;">
        <div style="text-align:left;">
          <div style="font-family:Orbitron,monospace;font-size:9px;letter-spacing:2px;color:${dailyDone?'var(--green)':'var(--gold)'};margin-bottom:3px;">
            ${dailyDone?'‚úì TODAY COMPLETE':'üìÖ DAILY CHALLENGE'}
          </div>
          <div style="font-size:9px;color:rgba(216,232,248,0.45);">${getDailyDateStr()} ¬∑ ${{'EARTH':'üåç Earth','MOON':'üåï Moon','MARS':'üî¥ Mars'}[getDailyPlanet(getDailySeed())]} ¬∑ Same map for all players</div>
          ${streak>1?`<div style="font-size:8px;color:var(--gold);margin-top:3px;">üî• ${streak}-day streak</div>`:''}
        </div>
        <button onclick="launchDailyChallenge()" style="flex-shrink:0;padding:10px 20px;font-family:Orbitron,monospace;font-size:9px;letter-spacing:2px;border:1.5px solid ${dailyDone?'rgba(64,255,128,0.5)':'var(--gold)'};background:${dailyDone?'rgba(64,255,128,0.1)':'rgba(240,192,64,0.1)'};color:${dailyDone?'var(--green)':'var(--gold)'};cursor:pointer;border-radius:5px;min-height:44px;-webkit-tap-highlight-color:transparent;transition:all 0.2s;">
          ${dailyDone?'‚ñ∂ Replay':'‚ñ∂ Play Now'}
        </button>
      </div>
    </div>

    ${lbHtml}
    <p class="ov-desc">Choose your faction. Carve a path from medieval kingdoms to the stars ‚Äî and beyond.</p>
    <div class="faction-grid">
      ${Object.values(FACTIONS).map(f=>`
        <div class="fcard" id="fc-${f.id}" onclick="pickFaction('${f.id}')" style="border-color:${f.color}22;background:linear-gradient(135deg,${f.color}06,${f.color}02)">
          <div class="fcheck" style="color:${f.light}">‚úì</div>
          <div class="ficon" style="text-shadow:0 0 16px ${f.color}88">${f.icon}</div>
          <div class="ftext">
            <div class="fname" style="color:${f.light}">${f.name}</div>
            <div class="ftrait">${f.desc}</div>
            <div class="fbonus" style="color:${f.color}">${f.bonus}</div>
          </div>
        </div>`).join('')}
    </div>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:4px;">
      <button class="sbtn" id="launch-btn" disabled onclick="showOpponentSetup()">Choose Opponents ‚Üí</button>
      <button class="sbtn gbtn" id="quick-btn" disabled onclick="quickStart()" style="font-size:9px;letter-spacing:2px;">üé≤ Quick Start</button>
    </div>
    <div style="display:flex;justify-content:center;gap:10px;margin-top:10px;flex-wrap:wrap;">
      <button onclick="showScenariosScreen()" style="display:flex;align-items:center;gap:8px;padding:9px 20px;font-family:Orbitron,monospace;font-size:8px;letter-spacing:2px;border:1px solid rgba(64,216,255,0.22);background:rgba(64,216,255,0.03);color:rgba(64,216,255,0.7);cursor:pointer;border-radius:4px;min-height:40px;-webkit-tap-highlight-color:transparent;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--cyan)';this.style.color='var(--cyan)';this.style.background='rgba(64,216,255,0.07)'" onmouseout="this.style.borderColor='rgba(64,216,255,0.22)';this.style.color='rgba(64,216,255,0.7)';this.style.background='rgba(64,216,255,0.03)'">
        <span style="font-size:14px">‚öîÔ∏è</span>
        <span>Scenarios</span>
      </button>
      <button onclick="showAchievementsScreen()" style="display:flex;align-items:center;gap:8px;padding:9px 20px;font-family:Orbitron,monospace;font-size:8px;letter-spacing:2px;border:1px solid rgba(240,192,64,0.22);background:rgba(240,192,64,0.03);color:rgba(240,192,64,0.7);cursor:pointer;border-radius:4px;min-height:40px;-webkit-tap-highlight-color:transparent;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--gold)';this.style.color='var(--gold)';this.style.background='rgba(240,192,64,0.07)'" onmouseout="this.style.borderColor='rgba(240,192,64,0.22)';this.style.color='rgba(240,192,64,0.7)';this.style.background='rgba(240,192,64,0.03)'">
        <span style="font-size:14px;">üéñ</span>
        <span>${earned.size} / ${Object.keys(ACHIEVEMENTS).length} Medals</span>
        ${earned.size===Object.keys(ACHIEVEMENTS).length?'<span style="color:var(--gold)">‚òÖ</span>':''}
      </button>
    </div>`;
}

function showAchievementsScreen(){
  const earned=loadAchievements();
  const total=Object.keys(ACHIEVEMENTS).length;
  document.getElementById('ov-content').innerHTML=`
    <h1 style="font-size:24px;letter-spacing:4px">MEDALS</h1>
    <div class="ov-sub">${earned.size} / ${total} UNLOCKED</div>
    <div style="height:8px;background:rgba(0,0,0,0.4);border-radius:4px;margin:0 0 18px;overflow:hidden;">
      <div style="height:100%;width:${(earned.size/total*100).toFixed(0)}%;background:linear-gradient(90deg,var(--gold),var(--gold-lt));border-radius:4px;transition:width 0.6s ease;"></div>
    </div>
    <div style="text-align:left;margin:0 -4px 18px">${renderAchievementsPanel()}</div>
    <button class="sbtn" onclick="showPickScreen()" style="font-size:9px;border-color:rgba(64,216,255,0.3);color:rgba(216,232,248,0.5);">‚Üê Back</button>`;
}

function pickFaction(id){
  pickedFaction=id;
  document.querySelectorAll('.fcard').forEach(el=>{
    const elId=el.id.replace('fc-','');if(!FACTIONS[elId])return;
    const f=FACTIONS[elId];
    el.classList.remove('picked');
    el.style.borderColor=f.color+'22';
    el.style.background=`linear-gradient(135deg,${f.color}06,${f.color}02)`;
    el.style.boxShadow='';
  });
  const f=FACTIONS[id];
  const card=document.getElementById('fc-'+id);
  if(card){
    card.classList.add('picked');
    card.style.borderColor=f.color;
    card.style.background=`linear-gradient(135deg,${f.color}18,${f.color}08)`;
    card.style.boxShadow=`0 0 24px ${f.color}44, 0 8px 32px rgba(0,0,0,0.6)`;
  }
  const btn=document.getElementById('launch-btn');if(btn){btn.disabled=false;btn.style.borderColor=f.color;btn.style.color=f.light;}
  const qb=document.getElementById('quick-btn');if(qb)qb.disabled=false;
}

function quickStart(){
  if(!pickedFaction)return;
  const others=Object.values(FACTIONS).filter(f=>f.id!==pickedFaction).sort(()=>Math.random()-0.5);
  const pnames=Object.keys(AI_PERSONALITIES).sort(()=>Math.random()-0.5);
  const count=1+Math.floor(Math.random()*3);
  const aiSetup=Array.from({length:count},(_,i)=>({
    factionId:others[i%others.length].id,
    personality:pnames[i%pnames.length],
  }));
  hideOv();
  initGame(pickedFaction,aiSetup,'EARTH');
  updateHUD();renderTechs();
  const rivalDesc=aiSetup.map(a=>FACTIONS[a.factionId].icon+' '+AI_PERSONALITIES[a.personality].name).join(', ');
  setMsg('Quick Start! Rivals: '+rivalDesc);
}

function randomiseAI(count){
  const others=Object.values(FACTIONS).filter(f=>f.id!==pickedFaction);
  const pnames=Object.keys(AI_PERSONALITIES);
  const shuffledFac=[...others].sort(()=>Math.random()-0.5);
  const shuffledPers=[...pnames].sort(()=>Math.random()-0.5);
  window._aiSlots=Array.from({length:3},(_,i)=>({
    factionId:shuffledFac[i%shuffledFac.length].id,
    personality:shuffledPers[i%shuffledPers.length],
  }));
  setupAICount=count||Math.ceil(Math.random()*3);
  [1,2,3].forEach(i=>{const b=document.getElementById('cnt-'+i);if(b)b.className='cnt-btn'+(i===setupAICount?' active':'');});
  renderAISlots();
  const sl=document.getElementById('ai-slots');
  if(sl){sl.style.transition='opacity 0.15s';sl.style.opacity='0';setTimeout(()=>{sl.style.opacity='1';},160);}
}

function showOpponentSetup(){
  if(!pickedFaction)return;
  const pf=FACTIONS[pickedFaction];
  const others=Object.values(FACTIONS).filter(f=>f.id!==pickedFaction);
  const pnames=Object.keys(AI_PERSONALITIES);
  if(!window._aiSlots){window._aiSlots=Array.from({length:3},(_,i)=>({factionId:others[i%others.length].id,personality:pnames[i%pnames.length]}));}
  const diff=AI_DIFFICULTY[globalDifficulty];
  document.getElementById('ov-content').innerHTML=`
    <h1 style="font-size:24px;letter-spacing:4px">MISSION SETUP</h1>
    <div class="ov-sub" style="color:${pf.light}">${pf.icon} COMMANDING ${pf.name.toUpperCase()}</div>

    <!-- Difficulty -->
    <div style="margin-bottom:16px;padding:12px 14px;border:1px solid rgba(60,140,255,0.14);border-radius:6px;background:rgba(60,140,255,0.03)">
      <div style="font-family:Orbitron,monospace;font-size:7px;letter-spacing:3px;color:var(--cyan);margin-bottom:10px;text-align:center">‚öô AI DIFFICULTY</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:8px">
        ${Object.values(AI_DIFFICULTY).map(d=>`
          <button class="diff-pill${globalDifficulty===d.id?' diff-active':''}" id="diff-${d.id}"
            onclick="setDifficulty('${d.id}')"
            style="padding:8px 12px;font-family:Orbitron,monospace;font-size:8px;letter-spacing:1px;border:1px solid ${globalDifficulty===d.id?d.color:d.color+'44'};background:${globalDifficulty===d.id?d.color+'22':'transparent'};color:${globalDifficulty===d.id?d.color:'rgba(216,232,248,0.5)'};cursor:pointer;border-radius:4px;transition:all 0.18s;min-height:38px;-webkit-tap-highlight-color:transparent;">${d.label}</button>`).join('')}
      </div>
      <div id="diff-desc" style="font-size:9px;color:rgba(216,232,248,0.45);text-align:center;font-style:italic;min-height:16px;padding:0 8px">${diff.desc}</div>
    </div>

    <!-- Rival count -->
    <div style="margin-bottom:14px">
      <div style="font-family:Orbitron,monospace;font-size:7px;letter-spacing:3px;color:var(--cyan);margin-bottom:8px;text-align:center">‚öî NUMBER OF RIVALS</div>
      <div style="display:flex;gap:8px;justify-content:center">
        ${[1,2,3].map(n=>`<button class="cnt-btn${n===setupAICount?' active':''}" id="cnt-${n}" onclick="setAICount(${n})" style="flex:1;max-width:90px;font-size:11px;">${n} ${n===1?'Rival':'Rivals'}</button>`).join('')}
      </div>
    </div>

    <!-- AI Slots -->
    <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
      <button onclick="randomiseAI()" style="padding:6px 14px;font-family:Orbitron,monospace;font-size:8px;letter-spacing:1px;border:1px solid rgba(240,192,64,0.35);background:transparent;color:var(--gold);cursor:pointer;border-radius:3px;min-height:36px;-webkit-tap-highlight-color:transparent;">üé≤ Randomise All</button>
    </div>
    <div id="ai-slots" style="margin-bottom:18px"></div>

    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
      <button class="sbtn" onclick="showPickScreen()" style="font-size:9px;border-color:rgba(64,216,255,0.25);color:rgba(216,232,248,0.45);">‚Üê Back</button>
      <button class="sbtn gbtn" onclick="launchGame()" style="font-size:11px;padding:12px 32px;">üöÄ Begin Campaign</button>
    </div>`;
  renderAISlots();
}

function setDifficulty(id){
  globalDifficulty=id;
  const d=AI_DIFFICULTY[id];
  Object.keys(AI_DIFFICULTY).forEach(did=>{
    const b=document.getElementById('diff-'+did);
    if(!b)return;
    const dd=AI_DIFFICULTY[did];
    const active=did===id;
    b.style.borderColor=active?dd.color:dd.color+'44';
    b.style.background=active?dd.color+'22':'transparent';
    b.style.color=active?dd.color:'rgba(216,232,248,0.5)';
  });
  const desc=document.getElementById('diff-desc');
  if(desc)desc.textContent=d.desc;
  if(id==='ELON'){
    setTimeout(()=>{
      const desc2=document.getElementById('diff-desc');
      if(desc2)desc2.innerHTML=`${d.desc} <span style="color:#ff4444;font-weight:700">‚ö† Not responsible for property damage.</span>`;
    },600);
  }
}

function setAICount(n){
  setupAICount=n;
  [1,2,3].forEach(i=>{const b=document.getElementById('cnt-'+i);if(b){b.className='cnt-btn'+(i===n?' active':'');}});
  renderAISlots();
}

function renderAISlots(){
  const others=Object.values(FACTIONS).filter(f=>f.id!==pickedFaction);
  const pnames=Object.keys(AI_PERSONALITIES);
  const sl=document.getElementById('ai-slots');if(!sl)return;
  if(!window._aiSlots)window._aiSlots=Array.from({length:3},(_,i)=>({factionId:others[i%others.length].id,personality:pnames[i%pnames.length]}));
  sl.innerHTML=Array.from({length:setupAICount},(_,i)=>{
    const s=window._aiSlots[i];const f=FACTIONS[s.factionId];
    const pers=AI_PERSONALITIES[s.personality];
    return`<div class="ai-slot-card" style="display:flex;align-items:stretch;gap:0;border:1px solid ${f.color}33;border-radius:6px;margin-bottom:8px;overflow:hidden;background:linear-gradient(135deg,${f.color}08,rgba(4,8,24,0.6));">
      <!-- Faction colour stripe -->
      <div style="width:5px;background:${f.color};flex-shrink:0;"></div>
      <!-- Icon -->
      <div style="display:flex;align-items:center;justify-content:center;padding:10px 12px;font-size:28px;flex-shrink:0;">${f.icon}</div>
      <!-- Controls -->
      <div style="flex:1;padding:8px 10px 8px 0;display:flex;flex-direction:column;gap:5px;">
        <select onchange="setAIFac(${i},this.value)"
          style="width:100%;background:rgba(2,4,16,0.8);color:${f.light};border:1px solid ${f.color}44;padding:6px 8px;font-family:Orbitron,monospace;font-size:8px;border-radius:3px;min-height:34px;-webkit-tap-highlight-color:transparent;">
          ${others.map(of=>`<option value="${of.id}" ${of.id===s.factionId?'selected':''}>${of.icon} ${of.name}</option>`).join('')}
        </select>
        <select onchange="setAIPers(${i},this.value)"
          style="width:100%;background:rgba(2,4,16,0.8);color:rgba(216,232,248,0.75);border:1px solid rgba(64,216,255,0.15);padding:6px 8px;font-size:9px;border-radius:3px;min-height:34px;-webkit-tap-highlight-color:transparent;">
          ${pnames.map(pn=>`<option value="${pn}" ${pn===s.personality?'selected':''}>${AI_PERSONALITIES[pn].name} ‚Äî ${AI_PERSONALITIES[pn].desc}</option>`).join('')}
        </select>
      </div>
    </div>`;
  }).join('');
}
window.randomiseAI=randomiseAI;
function setAIFac(i,fid){if(window._aiSlots)window._aiSlots[i].factionId=fid;renderAISlots();};
function setAIPers(i,p){if(window._aiSlots)window._aiSlots[i].personality=p;};

function launchGame(){
  if(!pickedFaction)return;
  const aiSetup=(window._aiSlots||[]).slice(0,setupAICount);
  hideOv();
  initGame(pickedFaction,aiSetup,'EARTH');
  updateHUD();renderTechs();
  setMsg('The '+FACTIONS[pickedFaction].name+' awakens. Your journey to the stars begins on Earth.');
}

const SAVE_KEY='farreach_save';

// ‚îÄ‚îÄ MENU ‚îÄ‚îÄ
function openGameMenu(){
  const el=document.getElementById('game-menu');
  if(el)el.classList.add('open');
  const note=document.getElementById('gm-save-note');
  if(note){
    try{
      const s=localStorage.getItem(SAVE_KEY);
      if(s){const d=JSON.parse(s);note.style.color='rgba(64,255,128,0.55)';note.textContent='‚úì Save: Turn '+d.turn+' ‚Äî '+d.planet+(d.savedAt?' ¬∑ '+d.savedAt:'');}
      else{note.style.color='rgba(216,232,248,0.2)';note.textContent='No save found';}
    }catch(e){note.textContent='';}
  }
  if(MUSIC.isPlaying()&&window._AC){try{window._AC.suspend&&window._AC.suspend();}catch(e){}}
}

function closeGameMenu(){
  const el=document.getElementById('game-menu');
  if(el)el.classList.remove('open');
  if(MUSIC.isPlaying()&&window._AC){try{window._AC.resume&&window._AC.resume();}catch(e){}}
}

function menuSave(){
  if(!G||!G.grid){
    const note=document.getElementById('gm-save-note');
    if(note){note.style.color='rgba(255,100,100,0.8)';note.textContent='‚ö† No game in progress to save';}
    return;
  }
  try{
    const save={
      turn:G.turn,planet:G.planet,era:G.era,score:G.score,stars:G.stars,
      factionId:G.factionId,
      techs:[...G.techs],
      cities:G.cities.map(c=>({...c})),
      units:G.units.map(u=>({...u})),
      blackHole:G.blackHole,
      wrath:G.wrath,
      unitsKilled:G.unitsKilled,unitsLost:G.unitsLost,citiesCaptured:G.citiesCaptured,
      aiPlayers:(G.aiPlayers||[]).map(a=>({
        id:a.id,factionId:a.factionId,stars:a.stars,
        techs:[...a.techs],
        personalityKey:Object.keys(AI_PERSONALITIES).find(k=>AI_PERSONALITIES[k]===a.personality)||'TACTICIAN',
        diffKey:a.diff?a.diff.id:'NORMAL',
        eliminated:a.eliminated||false,
      })),
      difficulty:globalDifficulty,
      diplo:G.diplo||{},
      wonders:[...(G.wonders||[])],
      savedAt:new Date().toLocaleTimeString(),
    }
    localStorage.setItem(SAVE_KEY,JSON.stringify(save));
    const note=document.getElementById('gm-save-note');
    if(note){note.style.color='rgba(64,255,128,0.75)';note.textContent='‚úì Saved ‚Äî Turn '+G.turn;}
    notify('üíæ Game saved!','gold');
    RETRO.researchFlash(50,20);
  }catch(e){
    const note=document.getElementById('gm-save-note');
    if(note){note.style.color='rgba(255,80,80,0.8)';note.textContent='‚ö† Save failed: '+e.message;}
  }
}

function menuLoad(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw){
      const note=document.getElementById('gm-save-note');
      if(note){note.style.color='rgba(255,150,80,0.7)';note.textContent='‚ö† No save game found';}
      return;
    }
    const save=JSON.parse(raw);
    closeGameMenu();
    const fac=FACTIONS[save.factionId]||Object.values(FACTIONS)[0];
    playerFaction=fac;

    G={
      grid:null,fog:null,cities:save.cities||[],units:save.units||[],
      turn:save.turn||1,phase:'player',era:save.era||'MEDIEVAL',
      score:save.score||0,stars:save.stars||8,
      techs:new Set(save.techs||[]),
      blackHole:save.blackHole||null,
      wrath:save.wrath,
      unitsKilled:save.unitsKilled||0,unitsLost:save.unitsLost||0,citiesCaptured:save.citiesCaptured||0,
      factionId:save.factionId,
      planet:save.planet||'EARTH',
      cam:{x:0,y:0},nextId:1000,sel:null,selU:null,mRange:null,aRange:null,
      drag:null,dragged:false,pinch:null,
      aiPlayers:(save.aiPlayers||[]).map(a=>({
        id:a.id,factionId:a.factionId,stars:a.stars||5,
        faction:FACTIONS[a.factionId]||Object.values(FACTIONS)[0],
        techs:new Set(a.techs||[]),
        personality:AI_PERSONALITIES[a.personalityKey]||AI_PERSONALITIES.TACTICIAN,
        diff:AI_DIFFICULTY[a.diffKey]||AI_DIFFICULTY.NORMAL,
        eliminated:a.eliminated||false,
      })),
      startTime:Date.now(),
      noTechTurn:false,eventCooldown:0,
      diplo:save.diplo||{},
      wonders:new Set(save.wonders||[]),
    }
    globalDifficulty=save.difficulty||'NORMAL';
    const[gw,gh]=save.planet==='MOON'?[16,12]:[18,14];
    SEED=save.turn*31337%99999; // deterministic from turn
    G.grid=genMap(save.planet);
    G.fog={};
    for(let q=0;q<(save.planet==='MOON'?16:18);q++){G.fog[q]={};for(let r=0;r<(save.planet==='MOON'?12:14);r++)G.fog[q][r]='visible';}
    const db=document.getElementById('diff-badge');
    if(db){const d=AI_DIFFICULTY[globalDifficulty];db.textContent=d.label;db.style.display='';db.style.color=d.color;db.style.borderColor=d.color+'44';db.style.background=d.color+'08';}
    document.getElementById('h-planet').textContent=save.planet.charAt(0)+save.planet.slice(1).toLowerCase();
    document.getElementById('faction-badge').textContent=fac.icon+' '+fac.name;
    document.getElementById('faction-badge').style.display='';
    updateHUD();renderTechs();updateEra();
    render();
    notify('üìÇ Game loaded ‚Äî Turn '+G.turn,'gold');
    setMsg('Welcome back, Commander. '+ERA_NAMES[G.era]);
    MUSIC.setPlanet(save.planet.toLowerCase());
    if(!MUSIC.isPlaying())MUSIC.start();
    document.getElementById('h-planet').textContent=save.planet.charAt(0)+save.planet.slice(1).toLowerCase();
    document.getElementById('tbadge').textContent='TURN '+G.turn;
  }catch(e){
    notify('‚ö† Load failed: '+e.message,'warn');
    console.error('Load error:',e);
  }
}

function menuRestart(){
  gameConfirm('RESTART? Current game will be lost.',()=>{
    closeGameMenu();MUSIC.stop();showPickScreen();
  });
}

function menuGiveUp(){
  if(!G||!G.grid){closeGameMenu();return;}
  gameConfirm('GIVE UP? This ends the game as a defeat.',()=>{
    closeGameMenu();endScreen(false,'You have surrendered. The galaxy continues without you.');
  });
}

function menuExit(){
  gameConfirm('EXIT TO TITLE? Unsaved progress will be lost.',()=>{
    closeGameMenu();MUSIC.stop();G={grid:null};showPickScreen();
  });
}

(function(){
  if(!('serviceWorker' in navigator))return;
  const SW_SRC=`
const CACHE='farreach-v1';
const ASSETS=[self.location.href];
self.addEventListener('install',e=>{
  e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()));
});
self.addEventListener('activate',e=>{
  e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))).then(()=>self.clients.claim()));
});
self.addEventListener('fetch',e=>{
  e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
    const clone=res.clone();
    caches.open(CACHE).then(c=>c.put(e.request,clone));
    return res;
  }).catch(()=>caches.match('/'))));
});`;
  const blob=new Blob([SW_SRC],{type:'application/javascript'});
  const url=URL.createObjectURL(blob);
  navigator.serviceWorker.register(url,{scope:'./'})
    .then(()=>{/* registered */})
    .catch(()=>{/* non-https or blocked */});
})();

let _installPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  _installPrompt=e;
  setTimeout(()=>{
    if(_installPrompt&&!localStorage.getItem('farreach_installed')){
      showInstallNudge();
    }
  },8000);
});
window.addEventListener('appinstalled',()=>{
  localStorage.setItem('farreach_installed','1');
  _installPrompt=null;
  const nudge=document.getElementById('install-nudge');
  if(nudge)nudge.remove();
  notify('üì≤ Far Reach installed!','gold');
});

function showInstallNudge(){
  if(document.getElementById('install-nudge'))return;
  const el=document.createElement('div');
  el.id='install-nudge';
  el.style.cssText='position:fixed;bottom:calc(68px + env(safe-area-inset-bottom,0px));right:12px;z-index:600;background:rgba(2,4,16,0.97);border:1px solid rgba(240,192,64,0.4);border-radius:8px;padding:10px 14px;max-width:220px;box-shadow:0 4px 24px rgba(0,0,0,0.8);animation:level-up-badge 0.4s ease-out forwards;';
  el.innerHTML=`
    <div style="font-family:Orbitron,monospace;font-size:8px;letter-spacing:2px;color:var(--gold);margin-bottom:4px;">üì≤ INSTALL FAR REACH</div>
    <div style="font-size:9px;color:rgba(216,232,248,0.5);margin-bottom:8px;line-height:1.4;">Add to home screen for the best experience</div>
    <div style="display:flex;gap:6px;">
      <button onclick="triggerInstall()" style="flex:1;padding:7px 0;font-family:Orbitron,monospace;font-size:8px;border:1px solid var(--gold);background:rgba(240,192,64,0.1);color:var(--gold);cursor:pointer;border-radius:3px;min-height:32px;">Install</button>
      <button onclick="dismissInstall()" style="padding:7px 10px;font-family:Orbitron,monospace;font-size:8px;border:1px solid rgba(64,216,255,0.2);background:transparent;color:rgba(216,232,248,0.4);cursor:pointer;border-radius:3px;min-height:32px;">‚úï</button>
    </div>`;
  document.body.appendChild(el);
}
function triggerInstall(){
  if(_installPrompt){_installPrompt.prompt();_installPrompt.userChoice.then(()=>{_installPrompt=null;});}
  dismissInstall();
}
function dismissInstall(){
  const el=document.getElementById('install-nudge');if(el)el.remove();
  localStorage.setItem('farreach_install_dismissed','1');
}
// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
function unlockAudio(){
  const ac=getAC();
  if(ac&&ac.state==='suspended'){ac.resume().catch(()=>{});}
  document.removeEventListener('touchstart',unlockAudio,true);
  document.removeEventListener('touchend',unlockAudio,true);
  document.removeEventListener('click',unlockAudio,true);
}
document.addEventListener('touchstart',unlockAudio,{once:true,passive:true});
document.addEventListener('touchend',unlockAudio,{once:true,passive:true});
document.addEventListener('click',unlockAudio,{once:true,passive:true});

function gameConfirm(msg,onYes,onNo){
  const existing=document.getElementById('gcf-overlay');
  if(existing)existing.remove();
  const el=document.createElement('div');
  el.id='gcf-overlay';
  el.style.cssText='position:fixed;inset:0;z-index:2000;display:flex;align-items:center;justify-content:center;background:rgba(2,4,16,0.92);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);';
  el.innerHTML=`<div style="background:linear-gradient(160deg,rgba(4,10,28,0.99),rgba(2,4,16,0.99));border:1px solid rgba(64,216,255,0.25);border-radius:8px;padding:28px 24px;max-width:88vw;min-width:260px;text-align:center;box-shadow:0 0 60px rgba(0,0,0,0.95);">
    <div style="font-family:Orbitron,monospace;font-size:9px;letter-spacing:2px;color:var(--cyan);margin-bottom:16px;">${msg}</div>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button id="gcf-no" style="flex:1;padding:12px 0;background:rgba(64,216,255,0.04);border:1px solid rgba(64,216,255,0.2);color:rgba(216,232,248,0.6);font-family:Orbitron,monospace;font-size:9px;letter-spacing:2px;cursor:pointer;border-radius:4px;min-height:44px;">CANCEL</button>
      <button id="gcf-yes" style="flex:1;padding:12px 0;background:rgba(255,68,68,0.06);border:1px solid rgba(255,68,68,0.35);color:#ff9090;font-family:Orbitron,monospace;font-size:9px;letter-spacing:2px;cursor:pointer;border-radius:4px;min-height:44px;">CONFIRM</button>
    </div>
  </div>`;
  document.body.appendChild(el);
  el.querySelector('#gcf-yes').addEventListener('click',()=>{el.remove();if(onYes)onYes();});
  el.querySelector('#gcf-no').addEventListener('click',()=>{el.remove();if(onNo)onNo();});
  el.addEventListener('click',ev=>{if(ev.target===el){el.remove();if(onNo)onNo();}});
}

function showOv(){document.getElementById('ov').style.display='flex';}
function hideOv(){document.getElementById('ov').style.display='none';}

document.addEventListener('keydown',e=>{if(e.key==='Escape'){const m=document.getElementById('game-menu');if(m&&m.classList.contains('open'))closeGameMenu();}});

function toggleMusic(){
  const on=MUSIC.toggle();
  const btn=document.getElementById('music-btn');
  if(btn){btn.textContent=on?'üéµ':'üîá';btn.style.opacity=on?'1':'0.45';}
}

function wireMobile(){
  const fab=document.getElementById('mob-tech-btn');
  const techOv=document.getElementById('mob-tech-ov');
  const techClose=document.getElementById('mob-tech-close');
  const handle=document.getElementById('mob-handle');
  const closeBtn=document.getElementById('mob-close');
  if(fab)fab.addEventListener('click',()=>{renderMobTechs();if(techOv)techOv.classList.add('open');});
  if(techClose)techClose.addEventListener('click',()=>{if(techOv)techOv.classList.remove('open');});
  if(handle)handle.addEventListener('click',closeMobSheet);
  if(closeBtn)closeBtn.addEventListener('click',closeMobSheet);
}
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',wireMobile);
else wireMobile();

function resize(){
  const wrap=document.getElementById('cvs-wrap');
  const dpr=Math.min(window.devicePixelRatio||1,3);
  cvW=wrap.clientWidth;cvH=wrap.clientHeight;
  CV.width=Math.round(cvW*dpr);CV.height=Math.round(cvH*dpr);
  CV.style.width=cvW+'px';CV.style.height=cvH+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  // FX overlay canvas
  const fxc=document.getElementById('FX');
  fxc.width=Math.round(cvW*dpr);fxc.height=Math.round(cvH*dpr);
  fxc.style.width=cvW+'px';fxc.style.height=cvH+'px';
  fxc.style.position='absolute';fxc.style.top='0';fxc.style.left='0';
  FX.ctx.setTransform(dpr,0,0,dpr,0,0);
  Object.keys(tileCache).forEach(k=>delete tileCache[k]);
}
document.getElementById('endbtn').addEventListener('click',()=>{if(G.phase==='player')endTurn();});
// Right-click sets waypoint for selected unit
CV.addEventListener('contextmenu',e=>{
  e.preventDefault();
  if(!G.selU||G.selU.owner!=='player')return;
  const rect=CV.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  const mx=(e.clientX-rect.left)*dpr,my=(e.clientY-rect.top)*dpr;
  const mc=hxy(GW/2,GH/2);
  const ox=CV.width/2+G.cam.x-mc.x,oy=CV.height/2+G.cam.y-mc.y;
  // Convert pixel to hex
  const px=(mx-ox)/HS,py=(my-oy)/HS;
  const q=Math.round((px*2/3)),r=Math.round((-px/3+py*Math.sqrt(3)/3));
  // Brute-force find closest tile
  let bestQ=0,bestR=0,bestD=Infinity;
  for(let tq=0;tq<GW;tq++)for(let tr=0;tr<GH;tr++){
    const {x,y}=hxy(tq,tr);
    const d=(mx-ox-x)**2+(my-oy-y)**2;
    if(d<bestD){bestD=d;bestQ=tq;bestR=tr;}
  }
  if(bestQ>=0&&bestQ<GW&&bestR>=0&&bestR<GH)setWaypoint(G.selU,bestQ,bestR);
});
document.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'&&!e.repeat){
    if(document.activeElement&&(document.activeElement.tagName==='INPUT'||document.activeElement.tagName==='SELECT'||document.activeElement.tagName==='TEXTAREA'))return;
    if(document.getElementById('ov').style.display!=='none')return;
    if(G.phase==='player'){
      const btn=document.getElementById('endbtn');
      btn.style.boxShadow='0 0 24px rgba(64,216,255,0.7)';
      btn.style.borderColor='var(--cyan)';
      setTimeout(()=>{btn.style.boxShadow='';btn.style.borderColor='';},300);
      endTurn();
    }
  }
});
window.addEventListener('resize',resize);
resize();
showPickScreen();
(function loop(){if(G.grid)render();requestAnimationFrame(loop);})();</script>
</body>
</html>
